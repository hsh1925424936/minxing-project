<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
    <title>任务</title>
    <script src="../../js/vue.js"></script>
    <script src="../../js/jquery-1.11.3.js"></script>
    <script src="../../layer/xie/layer1.js"></script>
    <script src="../../js/futuredoctorapp/common.js"></script>
    <script src="../../js/futuredoctorapp/vueComponent.js"></script>
    <script src="../../bootstrap-3.3.5-dist/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="../../css/futuredoctorapp/common.css">
    <link rel="stylesheet" href="../../css/futuredoctorapp/vueComponent.css">
    <link rel="stylesheet" href="../../bootstrap-3.3.5-dist/css/bootstrap.min.css">
    <style>
        body{
            background-color: #F2F2F2;
        }
        .container{ padding-left:0px;padding-right:0px}
        .oneProject>div{
            padding:0
        }
        .oneProject{
            padding:8px 10px;
            margin:0;
            border-bottom:1px solid #F2F2F2;
        }
        #todoList{
            background-color:white;
        }
        #noTodo{
            width:60%;
            margin:40% auto;
            text-align: center;
        }
    </style>
</head>
<body>
    <div id="container" class="container" v-cloak>
        <headerbox :thistitle="headerTitle" :titlenum="titlenum" :showback="showback" :showreload="showreload" id="header"></headerbox>
        <div id="todoList" v-show="isTodo">
            <ul>
                <li class="oneProject row" ontouchstart="mousedownFn(this)" ontouchend="mouseupFn(this)" v-for="(value,index) in todoList" :data-scheduleid="value.scheduleid">
                    <div class="col-xs-2">
                        <img src="../../images/futuredoctorapp/icon-renwu-kaoqin.png" alt="">
                    </div>
                    <div class="col-xs-8">
                        <dl class="m0">
                            <dt class="f14">考勤签到</dt>
                            <dd class="f12gray">您的课程——
                                <span>{{ value.coursename }}</span>将于
                                <span>{{ value.starttime | month_min }}</span>开课，地点
                                <span>{{ value.roomnum }}</span>。
                            </dd>
                        </dl>
                    </div>
                </li>
            </ul>
        </div>
        <div v-show="!isTodo" id="noTodo">
            <img src="../../images/futuredoctorapp/icon-renwu.png" alt="">
            <br>
            <br>
            <p class="f16 fgray">已完成所有任务</p>
        </div>
        <footertab :todonum="todonum" :msgnum="msgnum" :isactive="isactive" :navimgsrc="navimgsrc"></footertab>
    </div>
<script>
    Vue.filter('month_min',function(value){
        //2017-12-01 08:09:00
        var month=value.slice(5,7);
        if(month[0]==0){
            month=month.slice(1,2);
        };
        var day=value.slice(9,11);
        if(day[0]==0){
            day=day.slice(1,2);
        };
        var time=value.slice(12,17);
        return (month+'月'+day+'日 '+time)
    });
    var vm=new Vue({
        el:'#container',
        data:{
            headerTitle:'任务',
            todonum:0,
            msgnum:0,
            titlenum:0,
            isactive:[true,false,false,false],
            navimgsrc:['../../images/futuredoctorapp/nav-renwu-h.png','../../images/futuredoctorapp/nav-xiaoxi.png','../../images/futuredoctorapp/nav-yinyong.png','../../images/futuredoctorapp/nav-touxiang.png'],
            showback:false,
            showreload:true,
            //以上是配置头部和底部
            isTodo:"",//当前是否有任务
            todoList:"",//后台返回任务详情
        },
        mounted:function(){
            this.msgnum=queryMsgNum();
        },
        methods:{

        }
    });
    if(navigator.userAgent.indexOf("iPhone")!=-1){//如果是苹果系统
        setupWebViewJavascriptBridge(function(bridge) {
            bridge.registerHandler('setUserInfoForiOS', function (data) {
                userid=JSON.parse(data.UserInfo).userid;
                username=JSON.parse(data.UserInfo).username;
                sessionid=JSON.parse(data.UserInfo).sessionid;
                setCookie("uid",userid);
                setCookie("sid",sessionid);
                setCookie('name',username);
                getCourseInfo();//查询课程信息
                queryuserinfo();//查询个人信息
            });
        })
    }else{//安卓
        function setUserInfo(msg){//安卓接受用户信息函数
            if(typeof(msg)=="string"){
                msg=JSON.parse(msg)
            };
            setCookie("uid",msg.userid);
            setCookie("sid",msg.sessionid);
            setCookie('name',msg.username);
            getCourseInfo();//查询课程信息
            queryuserinfo();//查询个人信息
        };
    };
    function mousedownFn(elem){
        $(elem).css('backgroundColor','#F2F2F2')
    };
    function mouseupFn(elem){
        var scheid=$(elem).data('scheduleid');
        $(elem).css('backgroundColor','white');
        window.location.href="tosign.html?scheid="+scheid;
    };
    function getCourseInfo(){//查询课程信息接口
        var json={
            command:"course/querycourseinfo",
            timetype:0,
            sessionid:getCookie('sid'),
            uid:getCookie('uid'),
            loginid:getCookie('uid')
        };
        function callback(res){
            if(!res.schedules){//如果当前时间没有任务
                vm.isTodo=false;
                return
            };
            if(res.schedules[0].issigned==1){//一表示这个签到任务已经签到
                vm.isTodo=false;
                return
            };
            var nowMin=parseInt(new Date().getTime()/3600);//如果当前时间有签到任务，并且没签到，再去判断是否离课程开始还有10分钟
            var timer=setTimeout(function(){
                nowSeconds++;
                if((parseInt(new Data(res.schedules[0].starttime).getTime()/3600-10))>nowSeconds){
                    vm.isTodo=false;
                }else{
                    vm.isTodo=true;
                    vm.todonum=vm.titlenum=1;
                    vm.todoList=res.schedules;
                }
            },3600);
        };
        post("/course/querycourseinfo",json,callback,errcodefn,errfn)
    };
    function queryuserinfo(){//查询个人信息接口
        var data={
            command:'user/queryuserdetail',
            sessionid:getCookie('sid'),
            loginid:getCookie('uid'),
            uid:getCookie('uid')
        };
        function callback(res){
            var role;
            if(res.users[0].workunit){
                setCookie('danwei',res.users[0].workunit)
            };
            if(res.users[0].deptname){
                setCookie('keshi',res.users[0].workunit)
            };
            if(res.type==0){
                role='student';
            }else if(res.type==1 || res.type==2){
                role='manager';
            }else{
                role='teacher';
            };
            setCookie('role',role)
        }
    }
</script>
</body>
</html>