<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
    <title>任务</title>
    <script src="../../js/jquery-3.1.1.min.js"></script>
    <script src="../../bootstrap-3.3.5-dist/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="../../css/futuredoctorapp/common.css?v=1">
    <link rel="stylesheet" href="../../css/futuredoctorapp/vueComponent.css">
    <link rel="stylesheet" href="../../bootstrap-3.3.5-dist/css/bootstrap.min.css">
    <link rel="  stylesheet" href="../../css/futuredoctorapp/picker.css">
    <style>
        body{
            background-color: #F2F2F2;
        }
        .container{ padding-left:0px;padding-right:0px;}
        .oneProject>div{
            padding:0;
        }
        .oneProject{
            padding:8px 10px;
            margin:0;
            border-bottom:1px solid #F2F2F2;
        }
        #header{
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 99;
        }
        #todoList{
            background-color:transparent;
            padding-bottom: 5rem;
            margin-top: 4rem;
        }
        #todoList .detaillist{
            position: relative;
            background: #FFF;
            margin: 6px 6px;
            border-radius: 6px;
            box-shadow: 0 0 3px #CCC;
            padding: 15px 14px 15px 70px;
        }
        #todoList .detaillist .tag{
            position: absolute;
            width: 50px;
            height: 32px;
            padding-right:10px;
            top: 50%;
            left: 0;
            /* background:#6ad969; */
            color: #FFF;
            border-radius: 0 20px 20px 0;
            font-size:16px;
             font-weight:normal;
            line-height:32px;
            font-style: normal;
            text-align: center;
            -webkit-transform: translate3d(0, -55%, 0);
            -moz-transform: translate3d(0, -55%, 0);
            -ms-transform: translate3d(0, -55%, 0);
            -o-transform: translate3d(0, -55%, 0);
            transform: translate3d(0, -55%, 0);
            /* box-shadow: 3px 3px 6px #bae4b9; */
        }
        #todoList .detaillist .tag1{
            position: absolute;
            width: 50px;
            height: 32px;
            line-height: 12px;
            top: 50%;
            left: 0;
            background:#6ad969;
            color: #FFF;
            border-radius: 0 20px 20px 0;
            font-weight:bold;
            font-style: normal;
            text-align: center;
            -webkit-transform: translate3d(0, -55%, 0);
            -moz-transform: translate3d(0, -55%, 0);
            -ms-transform: translate3d(0, -55%, 0);
            -o-transform: translate3d(0, -55%, 0);
            transform: translate3d(0, -55%, 0);
            box-shadow: 3px 3px 6px #bae4b9;
        }
        #todoList .detaillist .tag.course {
            background: #29A7FF !important;
            box-shadow: 0px 2px 6px -1px rgba(41,167,255,0.9);
        }
        #todoList .detaillist .tag.train {
            background: #bae4b9 !important;
            box-shadow: 0px 2px 6px -1px rgba(186,288,185,0.9);
        }
        #todoList .detaillist .tag.evaluate {
            background: #03CDF9 !important;
            box-shadow: 0px 2px 6px -1px rgba(3,205,249,0.9);
        }
        #todoList .detaillist .tag.survey {
            background: #F8CF31 !important;
            box-shadow: 0px 2px 6px -1px rgba(248,207,49,0.9);
        }
        #todoList .detaillist .tag.personal{
            background: #eff816 !important;
            box-shadow: 0px 2px 6px -1px rgba(239,248,22,0.9);
        }
        #todoList .detaillist .tag.classes{
            background: #33f825 !important;
            box-shadow: 0px 2px 6px -1px rgba(51,248,37,0.9);
        }
        #todoList .detaillist .tag.chuke{
            background: #33f825 !important;
            box-shadow: 0px 2px 6px -1px rgba(51,248,37,0.9);
        }
        #todoList .detaillist .tag1.layout{
            font-size: 12px;
            background: #21DFC8 !important;
            /* box-shadow: 0px 2px 3px #21DFC8; */
            box-shadow: 0px 2px 6px -1px rgba(33,223,200,0.9);
            padding: 5px 2px 5px 1px;
        }
        #todoList .detaillist .tag1.review{
            font-size: 12px;
            background: #f99e1c !important;
            /* box-shadow: 0px 2px 3px #f99e1c;
             */
            box-shadow: 0px 2px 6px -1px rgba(249,158,28,0.9);
            padding: 5px 2px 5px 1px;
        }
        #todoList .detaillist .tag1.test{
            font-size: 12px;
            background-color: #11b95c !important;
            /* box-shadow: 0px 2px 3px #f99e1c;
             */
            box-shadow: 0px 2px 6px -1px rgba(17,185,92,0.9);
            padding: 5px 8px;
        }
        #todoList .remind{
            font-family: "Microsoft Yahei";
            font-size: 12px;
            text-align: center;
            line-height: 16px;
            color: #fff;
            display: inline-block;
            width: 25px;
            height: 16px;
            border-radius: 10px 10px 10px 10px;
            background-color: red;
            position: absolute;
            top:1rem;
            margin-left: .5rem;
        }
        #todoList .course{
            position: absolute;
            width: 55px;
            top: 50%;
            left: .1rem;
            margin-top: 5px;
            -webkit-transform: translate3d(0, -55%, 0);
            -moz-transform: translate3d(0, -55%, 0);
            -ms-transform: translate3d(0, -55%, 0);
            -o-transform: translate3d(0, -55%, 0);
            transform: translate3d(0, -55%, 0);
        }
        #todoList .detaillist p{
            color: #999999;
            margin-bottom:0;
            font-size: 13px;
        }
        #todoList h4{
            font-size:16px;
            color: #333333;
            margin-top:0;
            margin-bottom: 5px;
        }
        #todoList .m-date,
        #todoList .m-time {
            float: right;
            color: #999999;
            font-size:14px;
        }
        #noTodo{
            width:40%;
            margin:24% auto;
            text-align: center;
        }
        #noTodo img{
            display:block;
            width:100%;
        }
        .noToDoText{
            font-size:16px;
            color:#999999;
        }
        .headerbox b{
            font-size: 18px;
        }
    </style>
</head>
<body>
<div id="container" class="container" v-cloak>
    <headerbox :thistitle="headerTitle" :titlenum="todonum" :showback="showback" :showoption="showoption" id="header"></headerbox>
    <div id="todoList">
        <!--上拉选项-->
        <div class="picker-modal">
            <div class="picker-wrap">
                <div class="picker-toolbar">
                    <div id="cancel">取消</div>
                    <div style="font-size: 16px">选择要筛选的任务类型</div>
                    <div id="confirm">确定</div>
                </div>
                <div class="picker-column">
                    <div class="up"></div>
                    <div class="down"></div>
                    <div class="line"></div>
                    <ul id="scrollArea"></ul>
                </div>
            </div>
        </div>
        <!--详情列表-->
        <ul style="margin-top: 6rem" v-load-more="getMoreTodoList">
            <li class="detaillist" class="oneProject row" ontouchstart="mousedownFn(this)" ontouchend="mouseupFn(this)"  @click="gotoNew(value)" v-for="(value,index) in taskcountlist" v-if="value.taskcount != 0">
                <!--实验室审核-->
                <template v-if="value.counttype == 4">
                    <i class="tag1 review">实验室审核</i>
                    <!--<img class="course1" src="../../images/futuredoctorapp/icon_shenpi.png">-->
                    <h4>{{value.taskname}}<span class="remind">{{value.taskcount}}</span></h4>
                    <p>
                        <span>目前有{{value.taskcount}}条实验室使用申请需审核</span>
                    </p>
                </template>
                <!--实验室安排---->
                <template v-else>
                    <i class="tag1 layout">实验室安排</i>
                    <!--<img class="course1" src="../../images/futuredoctorapp/icon_anpai.png">-->
                    <h4>{{value.taskname}}<span class="remind">{{value.taskcount}}</span><span class="m-date">{{value.counttype | day}}</span></h4>
                    <p>
                        <span>有{{value.taskcount}}个实验室使用需安排</span>
                    </p>
                </template>
            </li>
            <li class="detaillist" class="oneProject row" ontouchstart="mousedownFn(this)" ontouchend="mouseupFn(this)"  @click="gotoNew(value)" v-for="(value,index) in tasklist" >
                <!--个人预约-->
                <template v-if="value.tasktype == 1">
                    <i class="tag personal">个人</i>
                    <h4>{{value.taskname}}</h4>
                    <p>
                        <span>{{value.createdtimestr}}</span>
                    </p>
                </template>
                <!--班级预约-->
                <template v-if="value.tasktype == 2">
                    <i class="tag personal">班级</i>
                    <h4>{{value.taskname}}</h4>
                    <p>
                        <span>{{value.createdtimestr}}</span>
                    </p>
                </template>
                <!--出科考试-->
                <template v-if="value.tasktype == 3">
                    <i class="tag personal">出科</i>
                    <h4>{{value.taskname}}</h4>
                    <p>
                        <span>{{value.createdtimestr}}</span>
                    </p>
                </template>
                <!--上课-->
                <template v-if="value.tasktype == 6">
                    <i class="tag course">上课</i>
                    <h4>{{value.taskname}}</h4>
                    <p>
                        <span>{{value.createdtimestr}}</span>
                    </p>
                </template>
                <!--评价-->
                <template v-if="value.tasktype == 5">
                    <i class="tag evaluate">评价</i>
                    <h4>{{value.taskname}}</h4>
                    <p>
                        <span>{{value.createdtimestr}}</span>
                    </p>
                </template>
                <!--问卷-->
                <template v-if="value.tasktype == 7">
                    <i class="tag survey">问卷</i>
                    <h4>{{value.taskname}}</h4>
                    <p>
                        <span>{{value.createdtimestr}}</span>
                    </p>
                </template>
                <!--课前训练-->
                <template v-if="value.tasktype == 8">
                    <i class="tag train">训练</i>
                    <h4>{{value.taskname}}</h4>
                    <p>
                        <span>{{value.createdtimestr}}</span>
                    </p>
                </template>
                <!--随堂小测-->
                <template v-if="value.tasktype == 9">
                    <i class="tag1 test">随堂小测</i>
                    <h4>{{value.taskname}}</h4>
                    <p>
                        <span>{{value.createdtimestr}}</span>
                    </p>
                </template>
            </li>
        </ul>
    </div>

    <div v-show="noTodo" id="noTodo">
        <img src="../../images/futuredoctorapp/icon-renwu.png" alt="">
        <br>
        <br>
        <p class="noToDoText">已完成所有任务</p>
    </div>

    <confirmlogout></confirmlogout>
    <footertab :todoNum="todonum" :msgNum="msgnum" :isactive="isactive" :navimgsrc="navimgsrc"></footertab>

</div>

<script src="../../js/vue-2.1.6.min.js"></script>
<script src="../../layer/xie/layer1.js"></script>
<script src="../../js/futuredoctorapp/common.js"></script>
<script src="../../js/futuredoctorapp/vueComponent.js"></script>
<script src="../../js/futuredoctorapp/picker.js"></script>
<script>
    var isvmready=false;
    var isiosready=false;
    var filtertasktype='';
    registerToNative('goBack', function (data) {
        $('#confirmlogout').removeClass('hide');
    })
    var vm=new Vue({
        el:'#container',
        data:{
            headerTitle:'任务',
            todonum:0,
            msgnum:0,
            isStu: false,
            // titlenum:0,
            isactive:[true,false,false,false],
            navimgsrc:['../../images/futuredoctorapp/nav-renwu-h.png','../../images/futuredoctorapp/nav-xiaoxi.png','../../images/futuredoctorapp/nav-yinyong.png','../../images/futuredoctorapp/nav-touxiang.png'],
            showback:false,
            showoption:true,
            //以上是配置头部和底部
            noTodo:true,//当前是否有任务
            tasklist: [],
            taskcountlist: [],
            taskcount:0,
            page:1,
            preventRepeatRequest:false,
            nomore:false,
        },
        mounted:function(){
            invokeNative('GetUserInfo', {}, getUserInfo);
            isvmready=true
//            todoListLoad();
//            querytasktype();
        },
        computed: {
//            'isTodo': function () {
//                return this.tasklist && this.tasklist.length && this.taskcountlist && this.taskcountlist.length;
//            },
            'todonum': function () {
                var lab = 0;
                for(var i = 0; i < this.taskcountlist.length; i++){
                    lab += this.taskcountlist[i].taskcount;
                }
                var listnum = this.taskcount + lab;
                return listnum || 0;
            }
        },
        filters: {
            day: function (val) {
                if (val == 5)return '今天';
                if (val == 6)return '明天、后天';
            },
        },
        directives: {
        'load-more': {
          bind: function(el, binding) {
            var windowHeight = window.screen.height;
            var height;
            var setTop;
            var paddingBottom;
            var marginBottom;
            var requestFram;
            var oldScrollTop;
            var scrollEl;
            var heightEl;
            var scrollType = el.attributes.type && el.attributes.type.value;
            var scrollReduce = 2;
            if (scrollType == 2) {
              scrollEl = el;
              heightEl = el.children[0];
            } else {
              scrollEl = document.body;
              heightEl = el;
            }

            el.addEventListener('touchstart',function(){
              //alert('touchstart')
              height = heightEl.clientHeight;
              if (scrollType == 2) {
                height = height
              }
              setTop = el.offsetTop;
              paddingBottom = vm.getStyle(el, 'paddingBottom');
              marginBottom = vm.getStyle(el, 'marginBottom');
            }, false)

            el.addEventListener('touchmove', function(){
              //alert('touchmove')
              loadMore();
            }, false)

            el.addEventListener('touchend', function(){
              //alert('touchend')
              oldScrollTop = scrollEl.scrollTop;
              moveEnd();
            }, false)

            var moveEnd = function() {
              requestFram = requestAnimationFrame(function(){
                if (scrollEl.scrollTop != oldScrollTop) {
                  oldScrollTop = scrollEl.scrollTop;
                  moveEnd()
                } else {
                  cancelAnimationFrame(requestFram);
                  height = heightEl.clientHeight;

                  loadMore();
                }
              })
            }

            var loadMore =function (){

              if (scrollEl.scrollTop + windowHeight+50 >= height + setTop + paddingBottom + marginBottom - scrollReduce) {

                binding.value();
              }
            }
          }
        }
      },
        methods:{
            getStyle:function(element, attr, NumberMode){
              var target;
              // scrollTop 获取方式不同，没有它不属于style，而且只有document.body才能用
              if (attr === 'scrollTop') {
                  target = element.scrollTop;
              }else if(element.currentStyle){
                  target = element.currentStyle[attr];
              }else{
                  target = document.defaultView.getComputedStyle(element,null)[attr];
              }
              //在获取 opactiy 时需要获取小数 parseFloat
              return  NumberMode == 'float'? parseFloat(target) : parseInt(target);
            },
            getMoreTodoList:function(){
                if(this.preventRepeatRequest){
                  return;
                }
                if(this.nomore)return;
                this.preventRepeatRequest= true;
                this.page=this.page+1;
                var data = {
                    command: "task/queryusertaskinfo",
                    loginid:getCookie('uid'),
                    sessionid:getCookie('sid'),
                    uid:getCookie('uid'),
                    page:this.page,
                    reqnum:20,
                    tasktype:filtertasktype,
                };
                post('/task/queryusertaskinfo',data,this.getMoreSuccess,errcodefn,errfn);
            },
            getMoreSuccess:function(res){
                this.preventRepeatRequest= false;
                if(res.tasklist.length==0){
                    this.nomore=true;
                }else{
                   this.tasklist = this.tasklist.concat(res.tasklist);
                }

            },
            gotoNew: function (it) {
                if(it.counttype == 5) window.location.href = it.taskurl+"?type=2&resulttype=1&timetype=0";
                else if (it.counttype == 6) window.location.href = it.taskurl+"?type=2&resulttype=1&timetype=3";
                else if (it.taskurl == null || it.taskurl == '') $(it.task).remove();
                else if (it.taskurl != null && it.taskurl != '' && it.taskurl.indexOf("?")!=-1)
                  window.location.href = it.taskurl+'&sourceid='+it.id;
                else if (it.taskurl != null && it.taskurl != '') window.location.href = it.taskurl+'?sourceid='+it.id;
                else window.location.href = it.taskurl;
            },
            querymsg:function() {    //查询消息
                var self=this
                var data={
                    command:'announce/queryannouncelist',
                    sessionid:getCookie('sid'),
                    loginid:getCookie('uid'),
                    uid:getCookie('uid'),
                    page:1,
                    reqnum:1,
                }
                function callback(res){
                    if(!res.allcount){
                        self.msgnum=0
                    }else{
                        self.msgnum=res.unreadcount
                    }
                }
                post('/announce/queryannouncelist',data,callback,errcodefn,errfn);
            },
        }
    });
    function todoListLoad(){
        var data = {
            command: "task/queryusertaskinfo",
            loginid:getCookie('uid'),
            sessionid:getCookie('sid'),
            uid:getCookie('uid'),
            page:1,
            reqnum:20,
            tasktype:filtertasktype,
        };
        function callback (res) {
            var labnum = 0;
            for(var i = 0; i < res.taskcountlist.length; i++){
                labnum += res.taskcountlist[i].taskcount;
            }
            if(res.tasklist.length != 0 || res.taskcountlist.length != 0 || labnum != 0) vm.noTodo = false;
            else if(res.tasklist.length == 0 || res.taskcountlist.length == 0) vm.noTodo = true;
            vm.tasklist = res.tasklist;
            vm.taskcountlist = res.taskcountlist;
            vm.taskcount = res.taskcount;
        };
        post('/task/queryusertaskinfo',data,callback,errcodefn,errfn);
    }

    function getUserInfo(data){//安卓接受用户信息函数
        isiosready=true
        var info = data;
        if(data && data.UserInfo) {
            info = data.UserInfo;
        }
        if(typeof info === 'string') {
            info = JSON.parse(info);
        }
        setCookie("uid",info.userid)
        setCookie("sid",info.sessionid)
        setCookie('name',info.username)
        judgeready()//只有在vm初始化好，并且受到安卓返回的用户信息后才调用
        vm.querymsg()
        querytasktype()
        todoListLoad()
        jump_msxxq()
    };

    function mousedownFn(elem){
        $(elem).css('backgroundColor','#efefef');
    };
    function mouseupFn(elem){
        $(elem).css('backgroundColor','white');
    };
    function judgeready(){
        if(isvmready && isiosready){
            queryMsgNum()//查询消息条数
        }
    }
    function querytasktype (){
        var data = {
            command:"task/querytasktype",
            loginid:getCookie('uid'),
            sessionid:getCookie('sid'),
        };

        function callback (result) {
            var list = [];
            if(result.length <= 0){
                return;
            }
            var typelist = result.tasktypelist;
            typelist.unshift({taskname:'全部',tasktype:''});
//            for(var i = 0;i<typelist.length;i++){
//                list.push(typelist[i].taskname);
//            }
//            list.unshift('全部');
            new EasyPicker({
                input: '#picker',
                data: typelist,
                callback: function(item) {
                    filtertasktype = item.tasktype;
                    todoListLoad();
                }
            });
        };
        post('/task/querytasktype',data,callback,errcodefn,errfn);
    }

//    window.onerror=function(a,b,c){
//        alert(a+b+c)
//    }
</script>
</body>
</html>
