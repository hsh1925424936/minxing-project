<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
    <title>签到</title>
    <script src="../../js/vue.js"></script>
    <script src="../../js/jquery-1.11.3.js"></script>
    <script src="../../layer/xie/layer1.js"></script>
    <script src="../../js/futuredoctorapp/common.js"></script>
    <script src="../../js/futuredoctorapp/vueComponent.js"></script>
    <script src="../../bootstrap-3.3.5-dist/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="../../css/futuredoctorapp/common.css">
    <link rel="stylesheet" href="../../css/futuredoctorapp/vueComponent.css">
    <link rel="stylesheet" href="../../bootstrap-3.3.5-dist/css/bootstrap.min.css">
    <style>
        body{
            background-color: #F2F2F2;
        }
        .container{ padding-left:0;padding-right:0}
        #userInfo{
            background-color: white;
            margin:0;
            padding:6px 5px;
        }
        #userInfo dl{
            padding-top:8px;
        }
        div.signBtn{
            width:150px;
            height:150px;
            background-image:url('../../images/futuredoctorapp/signbtns.png');
            background-position:-150px 0;
            background-size:cover;
            margin:0 auto;
            color:white;
        }
        div.signBtn>p{
            padding-top:30%;
            font-size:32px;
            margin-bottom:0;
        }
        #sign dd>span{
            position:relative;
            top:1px;
        }
        #sign{
            padding-top:40px;
        }
        #courseInfo>div>div{
            text-align: center;
            padding-top:10px;
            padding-bottom:10px;
        }
        #courseInfo>div p{
            font-size:12px;
            color:#A4A4A4;
            margin-bottom:2px;
        }
        #courseInfo>div span{
            color:#545454;
        }
        #courseInfo>div{
            margin:0;
        }
        #courseInfo{
            padding:0 20px;
        }
        u.getwifiname{
            color:#6CACD2;
        }
        #myModal{
            margin-top:30%;
        }
    </style>
</head>
<body>
    <div class="container" v-cloak id="container">
        <headerbox :thistitle="headerTitle" :titlenum="titlenum" :showback="showback" :showreload="showreload" id="header"></headerbox>
        <div id="userInfo" class="row">
            <div class="col-xs-3">
                <img src="../../images/futuredoctorapp/icon-wode-touxiang.png" alt="">
            </div>
            <div class="col-xs-8" style="padding-left:0">
                <dl class="m0">
                    <dt class="f14">{{ name }}</dt>
                    <dd class="f12gray" v-show="danwei">
                        <span>单位:</span>
                        <span>{{ danwei }}</span>
                    </dd>
                    <dd class="f12gray" v-show="keshi">
                        <span>当前科室:</span>
                        <span>{{ keshi }}</span>
                    </dd>
                </dl>
            </div>
        </div>
        <div id="sign">
            <dl class="text-center">
                <dt class="f14">
                    <div class="signBtn" ontouchstart="mousedownfn(this)" ontouchend="tosign(this)">
                        <p>{{ signstatus }}</p>
                        <span>{{ clock }}</span>
                    </div>
                </dt>
                <!--<dd class="f12gray mt20">
                    <p class="m0 hide">
                        <img src="../../images/futuredoctorapp/qiandao-wangluo.png" alt="">
                        <span>已进入Wi-Fi考勤范围</span>
                    </p>
                    <p class="m0">
                        <img src="../../images/futuredoctorapp/qiandao-gantan.png" alt="">
                        <span>当前不在Wi-Fi考勤范围</span>
                        <br>
                        <span>请将Wi-Fi连接至:{{ wifiname }}</span>
                    </p>
                </dd>-->
            </dl>
        </div>
        <div id="courseInfo">
            <div class="row"  style="border-bottom:1px solid #E9E9E9">
                <div class="col-xs-6" style="border-right:1px solid #E9E9E9">
                    <p>课程</p>
                    <span>{{ coursename }}</span>
                </div>
                <div class="col-xs-6">
                    <p>授课老师</p>
                    <span v-for="value in teachers">{{ value.name }}&nbsp;&nbsp;</span>
                </div>
            </div>
            <div class="row">
                <div class="col-xs-6" style="border-right:1px solid #E9E9E9">
                    <p>地点</p>
                    <span>{{ courseplace }}</span>
                </div>
                <div class="col-xs-6">
                    <p>上课时间</p>
                    <span>{{ coursedate }}</span></br>
                    <span>{{ coursetime }}</span>
                </div>
            </div>
        </div>
        <signfooter :signactive="signactive" :signnavimg="signnavimg" :tabsrc="tabsrc" v-show="showfooter"></signfooter>
        <!-- 模态框（Modal）提示wifi -->
        <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-body">
                        <span class="glyphicon glyphicon-exclamation-sign text-danger"></span>
                        <span>请将Wi-Fi连接至：</span>
                        <br>
                        <span id="designWiFi" class="text-primary" style="padding-left:20px"></span>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary btn-block" data-dismiss="modal">我知道了</button>
                    </div>
                </div><!-- /.modal-content -->
            </div><!-- /.modal -->
        </div>
    </div>
    <script>
        registerToNative('goBack', function (data) {
            window.location.href='application.html'
        });
        var currentWiFi;
        var designWiFi;
        var scheid;
        var vm=new Vue({
            el:'#container',
            data: {
                headerTitle: '签到',
                titlenum: 0,
                signactive: [true, false],
                signnavimg: ["../../images/futuredoctorapp/nav-daka-h.png", "../../images/futuredoctorapp/nav-tongji.png"],
                showback: true,
                showreload: false,
                showfooter: false,
                tabsrc: ['tosign.html', 'signdata.html'],
                //以上是头部和底部的配置
                wifiname: '',//应该连接的wifi名称,从安卓获取
                name: getCookie('name'),//用户姓名
                coursename: '',
                courseplace: '',
                coursedate: '',
                coursetime: '',
                teachers: '',
                danwei: getCookie('danwei')==-1?false:getCookie('danwei'),//用户单位
                keshi: getCookie('keshi')==-1?false:getCookie('keshi'),//用户科室
                clock: '',//签到按钮上的时钟
                signstatus: '',
                issignnow:false,
            },
            mounted:function(){
                var self=this;
                var json={
                    command:"course/querycourseinfo",
                    timetype:5,
                    sessionid:getCookie('sid'),
                    uid:getCookie('uid'),
                    loginid:getCookie('uid'),
                    advancetime:10
                };
                function callback(res){
                    if(!res.schedules){//如果当天没有课程
                        self.signstatus='签到';
                        $('.signBtn').css('backgroundPosition','-300px 0');
                        layer.msg('当前时间没有课程');
                        return
                    }else{//如果当天有课
                        scheid=res.schedules[0].scheduleid;
                        var json={
                            command:'course/querycoursedetailinfo',
                            sessionid:getCookie('sid'),
                            loginid:getCookie('uid'),
                            scheduleid:scheid
                        };
                        function detailCallback(result){
                            self.coursename=result.coursename;
                            self.courseplace=result.roomnum;
                            self.teachers=result.teachers;
                            self.coursedate=result.startdt.slice(0,11);
                            self.coursetime=result.starttime.slice(11,16)+'-'+result.endtime.slice(11,16);
                            var cls = new Array();
                            var stus = result.students;
                            for(var i=0;i<stus.length;i++){
                                cls[i] = stus[i].clsname;
                            };
                            var norepeat = notRepeat(cls);
                            setCookie('classname', norepeat[0]);
                        };
                        post('/course/querycoursedetailinfo',json,detailCallback,errcodefn,errfn);
                        if(res.schedules[0].issigned==0){//今天的课还没有签到，才会显示到任务
                            $('.signBtn').css('backgroundPosition','-150px 0');
                            self.signstatus='签到'
                        }else{
                            $('.signBtn').css('backgroundPosition','-300px 0');
                            self.signstatus='已签到'
                        }
                    };
                }
                post("/course/querycourseinfo",json,callback,errcodefn,errfn)
            },
            methods:{

            }
        });
        vm.clock=new Date().format("hh:mm:ss");
        var timerclock=setInterval(function(){
            vm.clock=new Date().format("hh:mm:ss");
        },1000);
        Date.prototype.format = function(fmt) {
            var o = {
                "M+" : this.getMonth()+1,                 //月份
                "d+" : this.getDate(),                    //日
                "h+" : this.getHours(),                   //小时
                "m+" : this.getMinutes(),                 //分
                "s+" : this.getSeconds(),                 //秒
                "q+" : Math.floor((this.getMonth()+3)/3), //季度
                "S"  : this.getMilliseconds()             //毫秒
            };
            if(/(y+)/.test(fmt)) {
                fmt=fmt.replace(RegExp.$1, (this.getFullYear()+"").substr(4 - RegExp.$1.length));
            }
            for(var k in o) {
                if(new RegExp("("+ k +")").test(fmt)){
                    fmt = fmt.replace(RegExp.$1, (RegExp.$1.length==1) ? (o[k]) : (("00"+ o[k]).substr((""+ o[k]).length)));
                }
            }
            return fmt;
        }//调用：var time1 = new Date().format("yyyy-MM-dd hh:mm:ss");
        function mousedownfn(elem){//手按住签到按钮的效果
            if($(elem).css('backgroundPosition')=='-300px 0px'){
                return
            };
            $(elem).css('backgroundPosition','0 0')
        };
        function tosign(elem){//签到接口
            if($(elem).css('backgroundPosition')=='-300px 0px'){
                return
            };
            $(elem).css('backgroundPosition','-150px 0');
            if(navigator.userAgent.indexOf("iPhone")!=-1){//如果是苹果系统，保存登录信息,保存wifi状态

                invokeNative('GetWiFiStatus', {'WIFIStatus': 'outSend'}, function (responseData) {
                    var rd = JSON.parse(responseData);

                    currentWiFi = rd.currentWiFi;
                    designWiFi = rd.designWiFi;
                    if(!currentWiFi || !designWiFi){
                        layer.msg("当前时间段签到人数较多，造成网络拥堵,请联系老师手动签到");
                        return
                    };
                    if(currentWiFi!=designWiFi){
                        $('#designWiFi').text(designWiFi);
                        $('#myModal').modal();
                        return
                    };
                    if(currentWiFi==designWiFi){
                        var data={
                            command:"sign/signin",
                            loginid:getCookie('uid'),
                            uid:getCookie('uid'),
                            sessionid:getCookie('sid'),
                            scheduleid:scheid
                        };
                        function callback(res){
                            $(elem).css('backgroundPosition','-300px 0');
                            vm.signstatus='已签到'
                        };
                        post("/sign/signin",data,callback,errcodefn,errfn);
                    }
                });
            } else {
                invokeNative('GetWiFiStatus', "GetWiFiStatus", function (responseData) {
                    var rd = JSON.parse(responseData);

                    currentWiFi = rd.currentWiFi;
                    designWiFi = rd.designWiFi;
                    if(!currentWiFi || !designWiFi){
                        layer.msg("当前时间段签到人数较多，造成网络拥堵,请联系老师手动签到");
                        return
                    };
                    if(currentWiFi!=designWiFi){
                        $('#designWiFi').text(designWiFi);
                        $('#myModal').modal();
                        return
                    };
                    if(currentWiFi==designWiFi){
                        var data={
                            command:"sign/signin",
                            loginid:getCookie('uid'),
                            uid:getCookie('uid'),
                            sessionid:getCookie('sid'),
                            scheduleid:scheid
                        };
                        function callback(res){
                            $(elem).css('backgroundPosition','-300px 0');
                            vm.signstatus='已签到'
                        };
                        post("/sign/signin",data,callback,errcodefn,errfn);
                    }
                });
            }
        };
        function goBack(){//返回任务页面
            window.location.href='application.html';
        };
        function confirmWifi(){

            if(navigator.userAgent.indexOf("iPhone")!=-1){//如果是苹果系统，保存登录信息,保存wifi状态

                invokeNative('GetWiFiStatus', {'WIFIStatus': 'outSend'}, function (responseData) {
                    var rd = JSON.parse(responseData);

                    currentWiFi = rd.currentWiFi;
                    designWiFi = rd.designWiFi;
                });
            } else {
                invokeNative('GetWiFiStatus', "GetWiFiStatus", function (responseData) {
                    var rd = JSON.parse(responseData);

                    currentWiFi = rd.currentWiFi;
                    designWiFi = rd.designWiFi;
                });
            }
        }
    </script>
</body>
</html>