<!DOCTYPE html>
<html>
	<head>
		<script type="text/javascript" src="../../js/istudy/layout.js" ></script>
		<meta charset="UTF-8">
		<title></title>
		<style>
			.kt-answer-con {height: 60%; background: url(../../images/istudy/dianwo.png) no-repeat center; background-size: 60%;}
			.kt-answer-tip,.kt-answer-info { font-weight: bold; height: 20%; font-size: 24px; text-align: center; line-height: 300%; padding-top: 10%;}
			.kt-answer-info {display: none; color: #cd3301;}
			.sign_bg { display: block;}
			.kt-answer-time { position: fixed; left: 0; top: 0; z-index: 99; width: 100%; height: 100%; color: #fff; font-size: 150px; text-align: center;}
		</style>	
	</head>
	<body>
		<div class="sign_bg"></div>
		<div id="header">
			<headerbox thistitle="抢答"></headerbox>
		</div>
		<div class="kt-answer-time"></div>
		<div class="kt-answer-con"></div>
		<div class="kt-answer-tip">点击屏幕，抢答啦~</div>
		<div class="kt-answer-info">
			<p></p>
			<p></p>
		</div>
		<audio src = '../../images/istudy/yaoyiyao.mp3' id="yaoyiyao" style="display: none" ></audio>
		<script src="../../js/istudy/vueComponent.js"></script>
		<script type="text/javascript">
			var questionid="";
			var bShake = true;
			var SHAKE_THRESHOLD = 3000;
      var last_update = 0;
      var x = y = z = last_x = last_y = last_z = 0;
			init();
      function init() {
        if (window.DeviceMotionEvent) {
          window.addEventListener('devicemotion', deviceMotionHandler, false);
        } else {
          alert('抱歉，您的设备不支持摇一摇功能');
        }
      }
	    function deviceMotionHandler(eventData) {
       	var acceleration = eventData.accelerationIncludingGravity;
        var curTime = new Date().getTime();
        if ((curTime - last_update) > 100) {
          var diffTime = curTime - last_update;
          last_update = curTime;
          x = acceleration.x;
          y = acceleration.y;
          z = acceleration.z;
          var speed = Math.abs(x + y + z - last_x - last_y - last_z) / diffTime * 10000;
          if (speed > SHAKE_THRESHOLD) {
          	if (!bShake) {
          		bShake=true;
          		toshake();
          	}
          }
          last_x = x;
          last_y = y;
          last_z = z;
        }
      }
			window.onload = function () {
				'use strict';
				wxcommon(1);
				$('.kt-answer-time ').css({'line-height': $('.kt-answer-time').css('height')});
				Api.R({
					isShade: 1,
					url: "/question/hasraceanswer",
					json: {
						"1": {
							command: "question/hasraceanswer",
							scheduleid: getCookie('gy_istudy_scid'),
							sessionid: getCookie('gy_t'),
							loginid: getCookie('gy_u')
						}
					},
					fn: function(result){
						if(result["1"].errcode!=0){
							uselayer(3, result["1"].errdesc);
							setTimeout(function(){
								window.history.go(-1);
							},2000)
							return;
						}
						questionid=result["1"].qid;
						var oTime = document.getElementsByClassName('kt-answer-time')[0];
						oTime.style.display = 'none';
						document.getElementsByClassName('sign_bg')[0].style.display = 'none';
						bShake = false;
						$('.kt-answer-con').on('click',toshake);
					},
					error: function(str){
						uselayer(3,'请求失败，请重新抢答！');
						setTimeout(function(){
							window.history.go(-1);
						},2000)
					}
				});
			};
			function toshake() {
				document.getElementById('yaoyiyao').play();
				Api.R({
					isShade: 1,
					url: "/question/raceanswer",
					json: {
						"1": {
							command: "question/raceanswer",
							sessionid: getCookie('gy_t'),
							scheduleid: getCookie('gy_istudy_scid'),
							loginid: getCookie('gy_u'),
							uid:getCookie('gy_u'),
							qid:questionid
						}
					},
					fn: function(result){
						if(result["1"].errcode!=0){
							uselayer(3, result["1"].errdesc);
							setTimeout(function(){
								window.history.go(-1);
							},2000)
							return;
						}
						var message = result["1"].errcode==0 ? '恭喜你抢到答题权限！' : '抢答题目失败！';
						var oTip = $('.kt-answer-tip')[0];
						var oInfo = $('.kt-answer-info')[0];
						var aP = oInfo.getElementsByTagName('p');
						oTip.style.display = 'none';
						oInfo.style.display = 'block';
						aP[0].innerHTML = '';
						aP[1].innerHTML = message;
						setTimeout(function () {
							window.history.go(-1);
						},2000);
					},
					error: function(str) {
						uselayer(3, '抢答题目请求失败, 请重新抢答！');
					}
				});
			};
		</script>
	</body>
</html>



