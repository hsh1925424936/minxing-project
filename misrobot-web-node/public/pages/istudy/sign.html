<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>签到</title>
    <script src="../../js/jquery-3.1.1.min.js"></script>
    <script src="../../layer/xie/layer1.js"></script>
    <link rel="stylesheet" href="../../css/istudy/signon.css">
    <link rel="stylesheet" href="../../css/istudy/iconfont.css">
    <link rel="stylesheet" href="../../css/istudy/demo.css">
    <style>
        body{font-family: "Microsoft YaHei"}
    </style>
</head>
<body>
<div id="shadow" class="hide">
    <div id="inputBox" class="show">
        <p class="tipsText">您可以输入教室编号，加入本教室课程</p>
        <input type="text" id="roomNum">
        <p class="btns">
            <button class="joinBtn btn-white">取消</button>
            <button class="joinBtn btn-blue" id="comfirmJoin">加入</button>
        </p>
    </div>
    <div id="errorBox" class="hide">
        <div class="errorMsg">
            <span class="icon anticon icon-exclamationcircle" style="color:#FF6600;font-size:22px;"></span>
            <ul id="errorToggle">
                <li>教室编号输入错误</li>
                <li>输入的教室编号错误，请重新输入</li>
            </ul>
        </div>
        <p class="btns">
            <button class="joinBtn btn-white">取消</button>
            <button class="joinBtn btn-blue" id="again">重新输入</button>
        </p>
    </div>
</div><!--shadow遮罩层-->
<header id="header" class="show">
    <p>签 到</p>
    <span id="joinClass" class="hide">加入课堂</span>
    <img src="../../images/istudy/refreshnew.png" alt="" onclick="showCourse()" id="reload">
    <b id="pageBack" class="icon anticon icon-left hide"></b>
</header>
<p id="netError" class="hide"><!--网络异常报错，默认不显示-->
    <span class="icon anticon icon-exclamationcircle" style="color:#FF6600;font-size:16px;">
    </span>抱歉，网络异常，请稍后再次签到
</p>
<div class="time show"><!--日期栏，一直显示-->
    <span class="icon anticon icon-calendar" style="font-size:18px;color:white;"></span>
    <span id="date"></span>
</div>
<div id="content" class="show"><!--当天有课程时显示的课程信息内容框-->
    <!--<div class="courseMsg">
        <ul class="courseMsgList">
            <li class="courseName">
                <b>肺科</b>
                <span class="yellowSign">已签到</span>
            </li>
            <li class="coursePlace">授课地点：626教室</li>
            <li class="courseTime">授课时间：9:00-12:00</li>
        </ul>
        <p class="blueSign">签到</p>
    </div>-->
</div>
<div id="noCourse" class="hide"><!--当天没有课程时显示-->
    <img src="../../images/istudy/noCourse.png" alt="">
    <p class="nothing">当前时间没有课程安排</p>
</div>
<div id="footer" class="show">
    <p>
        <span id="signRecordLink">签到记录</span>
    </p>
    <ul>
        <li><strong>提 示：</strong></li>
        <li class="hide">1、您可以点击右上角的“加入课堂”参加任何一个课堂;</li>
        <li>&nbsp;&nbsp;&nbsp;&nbsp;上课前10分钟可以开始签到</li>
    </ul>
</div>
<div id="signRecordBox" class="hide"></div>
<script src="../../js/istudy/wificonfig.js"></script>
<script src="../../js/istudy/signon.js"></script>
<script>
    var flag=-1;
    var userid="";//变量用于保存安卓/苹果传来的uid
    var sessionid="";//变量用于保存安卓/苹果传来的sid
    function setUserInfo(msg){//安卓接受用户信息函数
        flag=0;
        if(typeof(msg)=="string"){
            msg=JSON.parse(msg)
        };
        userid=msg.userid;
        sessionid=msg.sessionid;
        setCookie("gy_u",userid);
        setCookie("gy_t",sessionid);
        setCookie('u_name',msg.username);
        showCourse()//从安卓获取到了uid,sessionid后，再查询课程信息
        //Android:  JavaScriptGetUserInfo   js调用外部方法获取登录信息
        //ios: GetUserInfo
    };
    function setupWebViewJavascriptBridge(callback) {
        if (window.WebViewJavascriptBridge) { return callback(WebViewJavascriptBridge); }
        if (window.WVJBCallbacks) { return window.WVJBCallbacks.push(callback); }
        window.WVJBCallbacks = [callback];
        var WVJBIframe = document.createElement('iframe');
        WVJBIframe.style.display = 'none';
        WVJBIframe.src = 'wvjbscheme://__BRIDGE_LOADED__';
        document.documentElement.appendChild(WVJBIframe);
        setTimeout(function() { document.documentElement.removeChild(WVJBIframe) }, 0)
    };
    if(navigator.userAgent.indexOf("iPhone")!=-1){//如果是苹果系统，保存登录信息,保存wifi状态
        setupWebViewJavascriptBridge(function(bridge) {
            bridge.registerHandler('setUserInfoForiOS', function (data) {
                userid=JSON.parse(data.UserInfo).userid;
                username=JSON.parse(data.UserInfo).username;
                sessionid=JSON.parse(data.UserInfo).sessionid;
                setCookie("gy_u",userid);
                setCookie("gy_t",sessionid);
                setCookieIOS('u_name',username);
                showCourse()//从ios获取到了uid,sessionid后，再查询课程信息
            });
            bridge.callHandler('GetWiFiSSID', {'WIFIStatus': 'outSend'}, function responseCallback(responseData) {
                wifiName=responseData;
            })
        })
    };
    if (navigator.userAgent.indexOf("Android") != -1 || navigator.userAgent.indexOf('Linux') != -1) {
        wifiName= window.JavaInterface.JavaScriptGetWiFiStatus("GetWiFiSSID");//如果是GMC,data就等于GMC
    };
    var time=new Date();//创建时间对象
    var now={//now对象保存现在的时间，分钟
        h:time.getHours(),
        m:time.getMinutes(),
    };
    var nowMinutes=now.h*60+now.m;//今天已经过了多少分钟
    window.onerror=function(msg,url,line){
        alert("错误："+msg+"url:"+url+"行数："+line);
    };
    var cloak=setInterval(function(){//计算当前分钟数的定时器
        nowMinutes++;
    },60000);
    getTime();//获取当前年，月，日，周几并赋值给头部日期栏
    var timerToSign=setInterval(isCourseNow,60000);//每隔一分钟判断一次现在时间哪堂课可以签到了
    $(".btn-white").click(function(){//输入教室有错误时，点击取消按钮返回到课程签到列表。
        $("#shadow").attr("class","hide");
    });
    $("#joinClass").click(function(){//点击屏幕右上角的“加入课程”，显示遮罩层和输入教室编号框。
        $("#shadow").attr("class","show");
    });
    $("#again").click(function(){//点击重新输入时清空输入框，完成窗口切换到输入教室编号。
        $("#inputBox").attr("class","show");
        $("#roomNum").val("");
        $("#errorBox").attr("class","hide");
    });
    $("#pageBack").click(function(){//点击头部左边回退按钮，退出签到记录模块。按钮自己也消失。
        $(this).fadeOut();
        $("#signRecordBox").attr("class","hide");
        $("#header>p").html("签 到");
    });
    $("#comfirmJoin").click(function(){//点击蓝色"加入"按钮后发送ajax请求，
        var inputRoomNum=$("#roomNum").val();//用户输入的教室号
        //加入课程接口
        //输入参数：command:sign/joincls,roomnum教室编号,sessionid,uid,loginid
        var json={
            command:"sign/joincls",
            roomnum:inputRoomNum,
            sessionid:sessionid,
            uid:userid,
            loginid:userid
        };
        function callback (){//如果加入课程成功，就刷新页面，已加入的课程显示已签到
            window.location.reload();
        };
        function errorfn(obj){
            if(obj.errcode==9904){
                layer.msg("登录信息失效，请重新登录！");
                setTimeout(function(){
                    logout()
                },3000)
            } else{
                layer.msg(obj.errdesc)
            }
        };
        if(inputRoomNum.length!=0){
            postJson("/sign/joincls",json,callback,errorfn)
        }
        else{
            alert("请输入教室号")
        }
    });
    $("#signRecordLink").click(function(){//点击签到记录链接，页面显示签到记录块，头部出现回退按钮。
        $("#header>p").html("签到记录");
        var headerh=$("#header").innerHeight()+$("div.time").innerHeight();
        var bodyh=$("body").height();
        $("#signRecordBox").attr("class","show");
        $("#pageBack").fadeIn();
        $("#signRecordBox").css({
            "top":headerh+"px",
            "height":bodyh-headerh+"px",
        });
        var json={
            command:"course/querycourseinfo",
            timetype:1,
            sessionid:sessionid,
            uid:userid,
            loginid:userid
        };
        function callback(response){
            var isSignedRecord=-1;//-1表示没有记录
            if(response.schedules){//如果当天有课
                for(var i=0;i<response.schedules.length;i++){
                    if(response.schedules[i].issigned==1){//循环到当前一节课，如果是已签到状态
                        isSignedRecord=1;//1表示有签到记录
                        var contentDiv=$("<div data-issigned="+response.schedules[i].issigned+" class='courseMsg white'></div>");
                        contentDiv.html(
                                "<ul class='courseMsgList'><li class='courseName'><b>"+response.schedules[i].coursename+"</b> <span class=yellowSign>已签到</span></li><li class='coursePlace'>授课地点："+response.schedules[i].roomnum+"教室</li><li class='courseTime'>授课时间："+courseST[i]+"-"+courseET[i]+"</li></ul>"
                        );
                        if($("#signRecordBox div.courseMsg").length==0){
                            $("#signRecordBox").append(contentDiv)
                        }
                    }
                }
            }
            if(isSignedRecord==-1){//如果循环完后没发现已签到的课
                if($("#signRecordBox div").length==0){
                    $("#signRecordBox").append("<div class='noSignRecord'><img src='../../images/istudy/noCourse.png'> <p class='nothing'>没有签到记录</p></div>")
                }
            }
        };
        function errorfn(obj){
            if(obj.errcode==9904){
                layer.msg("登录信息失效，请重新登录！")
                setTimeout(function(){
                    logout()
                },3000)
            } else{
                layer.msg(obj.errdesc)
            }
        };
        postJson("/course/querycourseinfo",json,callback,errorfn);
    });
    function setCookieIOS(name,value) {//苹果手机setCookie方法
        document.cookie=name+"="+encodeURIComponent(value);
    };
</script>
</body>
</html>