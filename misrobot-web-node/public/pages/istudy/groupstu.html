<!DOCTYPE html>
<html>
	<head>
		<script type="text/javascript" src="../../js/istudy/layout.js" ></script>
		<meta charset="UTF-8">
		<title></title>
		<style>
			.kt-group-title { height: 10%; padding-top: 5%; text-align: center;}
			.kt-group-title h4 {  color:#333; text-align: center;}
			.kt-group-title span { float: right;  font-size: 18px; color: #7e7e7e; padding-right: 1em;}
			.kt-group-con { width: 100%; height:66%; overflow-y: auto;}
			.kt-group-con li { float: left; margin: 0 5.5%; width: 22%; height: 150px;font-size: 14px; color: #020202;}
			.kt-group-con li img { display: block; margin: 0 auto 6px; height: 70px; width: 70px; border-radius: 50%;}
			.kt-group-con li p { width: 100%; height: 24px; overflow: hidden;  word-wrap: break-word; word-break:break-all; text-align: center }
			.kt-group-con li span {display: none;}
			.kt-group-con li.active { color: #6c84b4;}
			.kt-group-con li.active span { display: block;}
			.kt-group-foot { height: 15%; padding: 6% 7%;}
			.kt-group-foot input { padding: 2%;  width: 35%; border: none; background: #6c83b5; border-radius: 4px; color: #fff; font-size: 16px;}
			.kt-group-foot input.active { background: #ccc;}
			.kt-group-foot-btn { display: none;}
			.kt-group-foot-btn input { width: 56%; display: block; margin: 0 auto;}
			.kt-group-foot { display: none}
		</style>
	</head>
	<body>
		<div class="sign_bg"></div>
		<div id="header">
			<headerbox thistitle="分组信息"></headerbox>
		</div>
		<div class="kt-group-title clearfix"></div>
		<ul class="kt-group-con center clearfix">
		</ul>
		<div class="kt-group-foot clearfix">
			<div class="kt-group-foot-menu clearfix">
				<input type="button" value="申请组长" class="kt-group-leader" style="float: left;" />
				<input type="button" value="申请记录员" class="kt-group-recorder" style="float: right;" />
			</div>
			<div class="kt-group-foot-btn">
				<input type="button" value="完成" />
			</div>
		</div>
		<script src="../../js/istudy/vueComponent.js"></script>
		<script>
			var sgid="";//分组id
			var sgindex="";//组号
			window.onload = function () {
				'use strict';
				wxcommon(1);
				Api.R({
					isShade: 1,
					url: "/group/querygroupinfo",
					json: {
						"1": {
							command: "group/querygroupinfo",
							scheduleid: getCookie('gy_istudy_scid'),
							sessionid: getCookie('gy_t'),
							//stdid: getCookie('gy_u'),
							loginid: getCookie('gy_u')
						}
					},
					fn: function(result) {
						if(result["1"].errcode!=0) {
							uselayer(3, result["1"].errdesc);
							return;
						}
						if (result["1"].groupresult==null) {
							$('.kt-group-title').html('<h4>暂未分组</h4>');
							$('.kt-group-foot').css('display','none');
						} else {
							var groupNum=0;
							for(var i=0;i<result["1"].groupresult.length;i++){
								if(result["1"].groupresult[i].stdid==getCookie('gy_u')){//找到自己所在的小组
									sgindex=result["1"].groupresult[i].sgindex;
									sgid=result["1"].groupresult[i].sgid;
								}
							}
							for(var i=0;i<result["1"].groupresult.length;i++){
								if(result["1"].groupresult[i].sgindex==sgindex){//找到自己这组有多少人
									groupNum++;
								}
							}
							$('.kt-group-title').html('<h4>第'+ sgindex +'组</h4><span>共'+ groupNum +'人</span>	');
							$('.kt-group-foot').css('display','block');
						}
						$('.kt-group-con').html('');
						var arr = (result["1"].groupresult!=null) ? result["1"].groupresult : result["1"].signedlist;
						for (var i = 0 ; i < arr.length; i++) {
							if(arr==result["1"].groupresult){//如果已分组
								if(arr[i].sgindex!=sgindex){//过滤掉非本组成员
									continue
								}
							}
							if ( result["1"].groupresult && arr[i].role==1) {
								$('.kt-group-leader').attr('disabled','disabled');
								$('.kt-group-leader').css('background','#ccc');
								if (arr[i].stdid== getCookie('gy_u')) {
									$('.kt-group-recorder').attr('disabled','disabled');
									$('.kt-group-recorder').css('background','#ccc');									
								}
							}
							if (result["1"].groupresult && arr[i].role==2) {
								$('.kt-group-recorder').attr('disabled','disabled');
								$('.kt-group-recorder').css('background','#ccc');
								if (arr[i].stdid==getCookie('gy_u')) {
									$('.kt-group-leader').attr('disabled','disabled');
									$('.kt-group-leader').css('background','#ccc');									
								}							
							}
							if (result["1"].groupresult==null ) {
								var str =
										'<li class="" _id="'+arr[i].stdid+'">'
										+'<img src="'+(arr[i].imageurl==undefined?'../../images/istudy/feifei.png': arr[i].imageurl)+'" />'
										+'<p>'+arr[i].name+'</p>'
										+'<span></span>'
										+'<input type="hidden" value="'+arr[i].stdid+'" />'
										+'</li>';
							} else {
								var str =
										'<li class="'+(arr[i].role== 0?'':'active')+'" _id="'+arr[i].stdid+'">'
										+'<img src="'+(arr[i].imageurl==undefined?'../../images/istudy/feifei.png':arr[i].imageurl)+'" />'
										+'<p>'+arr[i].name+'</p>'
										+'<span>'+(arr[i].role==1?'组长':'记录员')+'</span>'
										+'<input type="hidden" value="'+arr[i].stdid+'" />'
										+'</li>';
							}

							$('.kt-group-con').append(str);
						}

						$('.kt-group-leader').click(function () {
							uselayer(2,'确定要申请组长吗？',function () {
								applyrole('1');
							});
							
						});
						$('.kt-group-recorder').click(function () {
							uselayer(2,'确定要申请记录员吗？',function () {
								applyrole('2');
							});
						});	

					},
					error: function(str) {
						uselayer(3, "获取分组信息失败！");
					}
				});

				function applyrole(role){
					Api.R({
						isShade: 1,
						url: "/group/chooserole",
						json: {
							"1": {
								command: "group/chooserole",
								stdid: getCookie("gy_u"),
								role: role,
								sessionid: getCookie('gy_t'),
								loginid: getCookie('gy_u'),
								sgid:sgid,
								sgindex:sgindex
							}
						},
						fn: function(result){
							if(result["1"].errcode!=0){
								uselayer(3, result["1"].errdesc);
								return;
							}
							window.location.reload();
						},
						error: function(str){
							uselayer(3, '申请失败，请重新申请！');
							return;
						}
					});
				}
			}
		</script>
	</body>
</html>



