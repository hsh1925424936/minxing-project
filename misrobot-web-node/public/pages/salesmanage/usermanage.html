<!DOCTYPE html>
<html>
	<head>
		<script type="text/javascript" src="../../js/salesmanage/layout.js" ></script>
		<link rel="stylesheet" href="../../css/salesmanage/tablepagecommon.css" type="text/css" />
		<meta charset="UTF-8">
		<title>用户管理</title>
		<style>
			.new_user1{
				margin-bottom:10px;
			}

			/*弹出编辑和新增对话框*/
			.yes-no-dialog2 h3{
				padding-top:30px; padding-bottom:20px;
			}
			.yes-no-dialog2 .input_con{
				min-height:30px; color:#333333;
			}
			.yes-no-dialog2 .input_con .inputtext{
				width:100%; height:46px; border:1px solid #cccccc; border-radius:5px; text-align:center;
				margin-bottom:10px;
			}
			.yes-no-dialog2 .checkbox_con{
				margin-bottom:20px;
			}
			.user-defined-checkbox{
				float:left;
			}
			.yes-no-dialog2 .checkbox_con>label{
				display:block; float:left; line-height:17px;
				margin-left:5px;
			}

			.yes-no-dialog2 .btn_con{
				padding-bottom:40px;
			}

			/*适配手机端*/
			@media screen and (max-width: 800px) {
				.usertable tr th:nth-child(1),tr th:nth-child(3),tr td:nth-child(1),tr td:nth-child(3){
					display:none;
				}
				#paging{
					display:none;
				}
				.yes-no-dialog2 .input_con .inputtext{
					height:38px;
				}
				.usertable .edit span {
				    width: 25%;
				}
			}
			/*适配pc端*/
			@media screen and (min-width: 800px) {
				.user-defined-checkbox{
					width:24px; height:24px;
				}
				.yes-no-dialog2 .checkbox_con>label{
					line-height:23px;
				}
			}
				
		</style>

	</head>
	<body>
		<div class="_container" id='vue_control' v-cloak>
			<button class="blue_btn new_user new_user1" @click="newuser">新增</button>
			<div class="table_con">
				<div class="table_inner">
					<table class="usertable">
						<tr>
							<th>用户名</th><th>姓名</th><th>权限</th><th>剩余天数</th><th>编辑</th>
						</tr>
						<!-- <tr>
							<td>yangyang@misrobot.com</td>
							<td>杨洋</td>
							<td>普通用户</td>
							<td>10天</td>
							<td class="edit"><span class="toedit" @click="toedit">编辑</span><i>|</i><span class="todelete" @click="todelete">删除</span><i>|</i><span class="toactive" @click="toactive">激活</span></td>
						</tr> -->

						<tr v-for="(value,i) in allusers">
							<td>{{value.loginname}}</td>
							<td>{{value.username}}</td>
							<td>{{value.type}}</td>
							<td>{{value.activatedays}}天</td>
							<td class="edit">
								<span class="toedit" @click="toedit(value.userid,value.loginname,value.username,value.type)">编辑</span><i>|</i><span class="todelete" @click="todelete(value.userid,value.username)">删除</span><i>|</i><span class="toactive" @click="toactive(value.userid)">激活</span>
							</td>
						</tr>
						
					</table>
				</div>
				<!-- 分页 -->
				<div id="paging">
					
				</div>
				<button class="phone_blue_btn new_user" @click="newuser">新增</button>
			</div>
			
			<div class="yes-no-dialog yes-no-dialog2"><!--新增和编辑对话框-->
				<h3>编辑</h3>
				<div class="input_con">
					<input type="text" v-model.trim="dialog.loginname" class="inputtext usernameinput" placeholder="用户名" />
					<input type="text" v-model.trim="dialog.username" class="inputtext" placeholder="姓名" />
					<input type="password" v-model.trim="dialog.pwd" class="inputtext" :placeholder="isedit ? '修改密码(可不填)' : '密码'" />
					<div class="checkbox_con clearfix">
						<div class="user-defined-checkbox">
							<input type="checkbox" v-model="dialog.administrator" id='isadministrator'>
						</div>
						<label for="isadministrator">管理员</label>
					</div>
				</div>
				<div class="btn_con clearfix">
					<button class="yes_btn">确定</button>
					<button class="no_btn">取消</button>
				</div>
			</div>

		</div>

		
		
	</body>

	<script type="text/javascript">
		var vm;
		onload = function(){
			vm=new Vue({
				el:"#vue_control",
				data:{
					allusers:[],
					dialog:{//弹窗的编辑和新增对话框中的数据
						loginname:'',
						username:'',
						pwd:'',
						administrator:false,//是否为管理员
					},
					isedit:false//记录当前是否编辑状态
					
				},
				methods:{
					toactive:function(userid){
						var self = this;
						open_dialog1({
							title:'激活',
							content:'激活后增加100天使用期权，确定要激活吗？',
							yesbtnname:'激活',
							yes:function(){
								my_require.R({
									isShade:1,
									url:'/mismarketing/updateactivite',
									data:{
										command:"mismarketing/updateactivite",
										loginuserid:getCookie('userid'),
										useridlist:[{userid:userid}]
									},
									callback:function(base){
										layer.msg('激活成功！');
										self.get_all_user_depend_device();//刷新列表
										parent.vm.activenum();//刷新父页面激活管理标签显示的人数
									}
								});
							}
						});
					},
					todelete:function(userid,username){//删除用户
						if( userid == getCookie('userid') ){
							layer.msg('请不要删除自己的账号!');
							return false;
						}
						var self = this;
						open_dialog1({
							title:'删除',
							content:'确定要删除'+username+'吗？',
							yesbtnname:'删除',
							yes:function(){
								my_require.R({
									isShade:1,
									url:'/mismarketing/deleteadminuser',
									data:{
										command:"mismarketing/deleteadminuser",
										loginuserid:getCookie('userid'),
										userid:userid
									},
									callback:function(base){
										layer.msg('删除成功！');
										self.get_all_user_depend_device();//刷新列表
										parent.vm.activenum();//刷新父页面激活管理标签显示的人数
									}
								});
							}
						});
					},
					toedit:function(userid,loginname,username,type){
						var self = this;
						self.dialog.pwd = '';
						self.isedit = true;
						self.dialog.loginname = loginname;
						self.dialog.username = username;
						if(type == '管理员'){
							self.dialog.administrator = true;
						}else{
							self.dialog.administrator = false;
						}
						open_dialog2({
							title:'编辑',
							content:'.yes-no-dialog2',
							new:false,
							yes:function(index){
								var type;
								if ( self.dialog.administrator ){
									type = 0;//是管理员
								}else{
									type = 1;
								}
								if(self.dialog.username == ''){
									layer.msg('请填写姓名！');
									return false;
								}
								var _data = {
									command:"mismarketing/updateadmininfo",
									loginuserid:getCookie('userid'),
									loginname:self.dialog.loginname,
									username:self.dialog.username,
									type:type,
									userid:userid
								};
								if( self.dialog.pwd != '' ){
									_data.pwd = self.dialog.pwd;
								}
								my_require.R({
									isShade:1,
									url:'/mismarketing/updateadmininfo',
									data:_data,
									callback:function(base){
										layer.msg('修改成功！');
										self.get_all_user_depend_device();//刷新列表
										parent.vm.activenum();//刷新父页面激活管理标签显示的人数
										layer.close(index);
										self.dialog.administrator = false;
										self.dialog.username = '';
										self.dialog.loginname = '';
										self.dialog.pwd = '';
									}
								});
							}
						});
					
					},
					newuser:function(){
						var self = this;
						self.dialog.pwd = '';
						self.isedit = false;
						self.dialog.administrator = false;
						self.dialog.username = '';
						self.dialog.loginname = '';
						self.dialog.pwd = '';
						open_dialog2({
							title:'新增',
							content:'.yes-no-dialog2',
							new:true,
							yes:function(index){
								var type;
								if ( self.dialog.administrator ){
									type = 0;//是管理员
								}else{
									type = 1;
								}
								if(self.dialog.username == ''){
									layer.msg('请填写姓名！');
									return false;
								}
								if(self.dialog.loginname == ''){
									layer.msg('请填写用户名！');
									return false;
								}
								if(self.dialog.pwd == ''){
									layer.msg('请填写密码！');
									return false;
								}
								my_require.R({
									isShade:1,
									url:'/mismarketing/addadmininfo',
									data:{
										command:"mismarketing/addadmininfo",
										loginuserid:getCookie('userid'),
										username:self.dialog.username,
										loginname:self.dialog.loginname,
										pwd:self.dialog.pwd,
										type:type
									},
									callback:function(base){
										layer.msg('新增成功！');
										self.get_all_user_depend_device();//刷新列表
										parent.vm.activenum();//刷新父页面激活管理标签显示的人数
										layer.close(index);
									}
								});
							}
						});
					},

					get_all_user:function(curr,length){//获取所有的用户(传入的是当前的页数,每页的条数)
						var self = this;
						my_require.R({
							isShade:1,
							url:'/mismarketing/getalladminuser',
							data:{
								command:"mismarketing/getalladminuser",
								userid:getCookie('userid'),
								requestpage:curr,
								sizeperpage:length
							},
							callback:function(base){//登录成功
								self.allusers = base.mismarketingUserAdmins;
								layui.use(['laypage', 'layer'], function(){
									var laypage = layui.laypage;
									laypage({
										cont: 'paging',
										pages: Math.ceil(base.counts/length),
										first: false,
										last: false,
										skin: '#2088ca',
										curr: location.hash.replace('#!fenye=', ''),
										hash: 'fenye',//自定义hash值
										jump: function(obj,first){
											if(!first){
												self.get_all_user(obj.curr,length);
											}
										}
									});
								});
								
							}
						});
					},
					get_all_user_depend_device:function(){
						changepage('!fenye=1');
						if( IsPC() ){
							this.get_all_user(1,15);
						}else{
							this.get_all_user(1,10000);
						}

					}
				},

				created:function(){
					
				},
				mounted:function(){
					my_checkbox_change();
					var self = this;
					layui.use('layer', function(){
						var layer = layui.layer;
						self.get_all_user_depend_device();
					});
						
				},
				updated:function(){
					my_checkbox_change();
				},
				watch:{
					
				}
			})			
		}

		function open_dialog2(opt){//打开对话框
			$('.yes-no-dialog2 .no_btn').unbind();
			$('.yes-no-dialog2 .yes_btn').unbind();

			$('.yes-no-dialog2>h3').html(opt.title);
			layer.open({
				type: 1,
				closeBtn: 0,
				shade:'transparent',
				title:false,
				area: 'auto',
				maxWidth:'700px',
				move:'.yes-no-dialog2 h3',
				skin: 'layui-layer-nobg', //没有背景色
				shadeClose: false,
				content: $('.yes-no-dialog2'),
				success: function(layero, index){
					$('.yes-no-dialog2 .no_btn').bind('click',function() {
						layer.close(index);
					});
					$('.yes-no-dialog2 .yes_btn').bind('click',function() {
						opt.yes(index);
					});
				}
			});
		}

	</script>
</html>