<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="x-ua-compatible" content="IE=5;IE=7;IE=8;IE=9;" />
    <title>Title</title>
    <script src="../../js/jquery-1.11.3.js"></script>
    <script src="../../js/vue.min.js"></script>
    <script src="../../js/skillcontestweb/methods.js"></script>
    <style>
        *{
            margin:0;
            padding:0;
            list-style-type:none;
        }
        body,html{
            height:100%;
            font-family: microsoft yahei;
            background-color:#3DAADF;
            color:white;
        }
        #time{
            text-align:right;
            padding:30px;
        }
        #content{
            width:38%;
            margin:170px auto;
            text-align:center;
            overflow:hidden;
        }
        #content>p{
            margin:20px 0;
            font-size:20px;
        }
        #code{
            margin-top:40px;
            opacity:0;
            position:absolute;
            top:300px;
            left:-200px;
            height:20px;
            font-size:10px;
        }
        #view{
            overflow:hidden;
            border-top:1px solid #aaa;
            border-left:1px solid #aaa;
            background-color:#ddd;
            width:366px;
            margin:0 auto;
            color:#555;
            font-weight:bold;
            font-size:44px;
        }
        #view>li{
            float:left;
            width:60px;
            height:60px;
            line-height:60px;
            text-align:center;
            border-right:1px solid #aaa;
            border-bottom:1px solid #aaa;
        }
        .white{
            background-color:white;
        }
        .gray{
            background-color:#ddd;
        }
        #shadow{
            width:100%;
            height:100%;
            background-color:rgba(0,0,0,0.4);
            position:fixed;
            top:0;
            left:0;
            z-index:99;
        }
        .show{
            display:block;
        }
        .hide{
            display:none;
        }
        #errorBox{
            width:28%;
            height:26%;
            background-color: white;
            border-radius: 10px;
            position:absolute;
            left:36%;
            top:37%;
        }
        #errorBox>p.boxHead{
            background-color:#E85B40;
            color:white;
            text-align:center;
            height:40px;
            line-height:40px;
            position:relative;
            border-radius: 10px 10px 0 0;
        }
        p.boxHead>i{
            position:absolute;
            right:10px;
            top:10px;
            border:1px solid #aaa;
            height:20px;
            width:20px;
            text-align:center;
            line-height:20px;
            font-style:normal;
            border-radius:3px;
            cursor:pointer;
        }
        p.errorMsg{
            text-align:center;
            color:#555;
            padding:44px 0;
        }
        p.btnBlue{
            margin:0 auto;
            width:166px;
            height:36px;
            background-color:#3C9CCF;
            border-radius:5px;
            color:white;
            line-height:36px;
            text-align:center;
            cursor:pointer;
        }
        [v-cloak] { display: none }
    </style>
</head>
<body>
    <div id="time"></div>
    <div id="errMsg"></div>
    <div id="content">
        <h1>请输入站内信息机上显示的校验码</h1>
        <p>请输入六位数字校验码</p>
        <ul id="view" v-cloak="">
            <li class="white">{{msg.slice(0,1)}}</li>
            <li>{{msg.slice(1,2)}}</li>
            <li>{{msg.slice(2,3)}}</li>
            <li>{{msg.slice(3,4)}}</li>
            <li>{{msg.slice(4,5)}}</li>
            <li>{{msg.slice(5,6)}}</li>
        </ul>
        <input type="text" id="code" maxlength="6" v-model="msg">
    </div>
    <div id="shadow" class="hide">
        <div id="errorBox" class="hide">
            <p class="boxHead">
                <span>错误提示</span>
                <i id="cha">×</i>
            </p>
            <p class="errorMsg">校验码错误，请核对后再输入。</p>
            <!--服务器连接超时，请稍后再试。-->
            <div>
                <p id="ok" class="btnBlue">我知道了</p>
            </div>
        </div>
    </div>
</body>
<script>
    var vm=new Vue({//引入vue对象
        el:"#content",
        data:{
            msg:"",
        }
    });
    var duration=""//设备绑定有效期period,后台返回
    var devID="";//设备id
    var code="";//用户输入的6位校验码
    function bindDevice(){
        if(devID.length!=0){//获取devID成功的情况下才发出请求
            var json={
                command:"device/register",
                validcode:code,
                deviceid:devID,
            };
            function okCode(obj){//msg
                window.location.href="testConfirm.html";
                duration=obj.period;
            };
            function errorCode(){
                $("#errorBox").attr("class","show");
            };
            function errConnect(){
                $("#errorBox").attr("class","show");
                $("p.errorMsg").html("数据传输出错，请稍后再试");
            };
            postJson("/device/register",json,okCode,errorCode,errConnect);
        }
        else{
            $("#errMsg").html("获取deviceid失败");
        }
    };
    window.onload=function(){
        $("#code").focus();//输入框自动获焦
        devID = window.external.get_cfg("js.device_id");//调用外部c++方法，获取本机deviceid
        //pushHeatBeat();
        //var timerHeartBeat=setInterval(pushHeatBeat,60000);//每5分钟调用一次心跳函数
    };
    function getTime(){//获取系统当前时间，显示到右上角
        var date=new Date();
        var h=date.getHours().toString();
        var m=date.getMinutes().toString();
        (h.length==1)&&(h="0"+h);
        (m.length==1)&&(m="0"+m);
        $("#time").html(h+":"+m);
    };
    getTime();
    var timer=setInterval(getTime,60000);
    $("#view").click(function(){//点6个小方格，输入框也可获焦
        $("#code").focus();
    });
    $("#code").bind("input",function(){
        var length=$(this).val().length;
        $("#view>li").attr("class","gray");
        $("#view>li:eq("+length+")").attr("class","white");
        if(length==6){
            $("#shadow").attr("class","show");
            code=$(this).val();
            bindDevice();
        }
    });
    $("#cha,#ok").click(function(){//关闭shadow层
        $("#errorBox,#shadow").attr("class","hide");
        window.location.reload();
    });
</script>
</html>