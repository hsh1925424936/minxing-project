<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>课件</title>
    <script src="../../js/jquery-3.1.1.min.js"></script>
    <script src="../../js/vue.js"></script>
    <script src="../../js/element.js"></script>
    <script src="../../js/assistant/c_common.js"></script>
    <script src="../../js/scmp/common.js"></script>
    <script src="../../layer/xie/layer1.js"></script>
    <link rel="stylesheet" href="../../css/element.css">
    <style>
        /*base style*/
        *{margin:0;padding:0}
        ul{list-style-type: none}

        #container{padding:10px}
        .localfile{
            width:20%;
            margin: 0 auto;
            display:flex;
            justify-content: center;
        }
        .nopre{
            width:20%;
            margin: 0 auto;
            text-align: center;
            height:300px;
            font-size:32px;
            color:#ddd;
            line-height: 300px;
        }
        .filelist{
            display: flex;
            flex-wrap: wrap;
        }
        .fileimg{
            width:100px;
            height:100px;
            background-size:100%;
            background-repeat: no-repeat;
            display:block;
            margin:0 auto;
        }
        .filename{
            margin-top:10px;
        }
        .filelist li{
            width:12.5%;
            text-align: center;
            margin-bottom:20px;
        }
        .search{
            display:flex;
            align-items: center;
            margin-bottom: 20px;
        }
        .searchinput{
            width:20%;
            margin-right:20px;
        }
        .fileimg_box{
            background-image: url('../../images/assistant/fd.png')!important;
        }
        .fileimg_ppt{
            background-image: url('../../images/assistant/pptimg.png')!important;
        }
        .fileimg_doc{
            background-image: url('../../images/assistant/doc.png')!important;
        }
        .fileimg_excel{
            background-image: url('../../images/assistant/Excel.png')!important;
        }
        .fileimg_jpg{
            background-image: url('../../images/assistant/jpgimg.png')!important;
        }
        .fileimg_pdf{
            background-image: url('../../images/assistant/pdf.png')!important;
        }
        .fileimg_sp{
            background-image: url('../../images/assistant/sp.png')!important;
        }
        .fileimg_yp{
            background-image: url('../../images/assistant/yinping.png')!important;
        }
        .fileimg_txt{
            background-image: url('../../images/assistant/txt.png')!important;
        }
        .fileimg_rar{
            background-image: url('../../images/assistant/rarimg.png')!important;
        }
        .fileimg_default{
            background-image: url('../../images/assistant/default.png');
        }
        .emptyfile{
            text-align: center;
            padding:10px 0;
            color:#383838;
            font-size:18px;
        }
        .returntomain{
            margin-bottom:20px;
        }
        .pagenation{
            display: flex;
            justify-content: flex-end;
            margin:20px 0;
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="header">
            <el-tabs v-model="activeName" @tab-click="handleClick">
                <el-tab-pane label="我的备课" name="first">
                    <div class="nopre" v-show="false">您还没有备课</div>
                    <el-button @click="currentPagesel=1 && getfilelistsel(0,1,10)" type="primary" class="returntomain">返回主目录</el-button>
                    <p v-show="prefilelist.length==0" class="emptyfile">文件夹为空</p>
                    <ul class="filelist">
                        <li v-for="(value,index) in prefilelist">
                            <i class="fileimg fileimg_default"
                               :class="{
                                fileimg_box:value.file_class==100,
                                fileimg_sp:value.file_class==1,
                                fileimg_yp:value.file_class==2,
                                fileimg_jpg:value.file_class==3,
                                fileimg_ppt:value.file_suffix=='.pptx',
                                fileimg_doc:value.file_suffix=='.doc' || value.file_suffix=='.docx',
                                fileimg_excel:value.file_suffix=='.xls' || value.file_suffix=='.xlsx',
                                fileimg_pdf:value.file_suffix=='.pdf',
                                fileimg_txt:value.file_suffix=='.txt',
                                fileimg_rar:value.file_suffix=='.rar' || value.file_suffix=='.zip'
                                }" @dblclick="openfile(value)">
                            </i>
                            <p class="filename">{{value.name | filename}}</p>
                        </li>
                    </ul>
                    <div class="pagenation">
                        <el-pagination layout="prev, pager, next" :total="pagetotalnumsel" @current-change="topagesel" :current-page.sync="currentPagesel"></el-pagination>
                    </div>

                </el-tab-pane>
                <el-tab-pane label="全部课件" name="second">
                    <div class="search">
                        <el-input
                            placeholder="全课件库搜索，输入名称关键字"
                            icon="search"
                            v-model="searchfile"
                            :on-icon-click="handleIconClick" class="searchinput">
                        </el-input>
                        <span>您的课件库有{{totalcount}}个文件</span>
                    </div>
                    <el-button @click="currentPage=1 && getfilelist(0,null,1,10)" type="primary" class="returntomain">返回主目录</el-button>
                    <p v-show="filelistall.length==0" class="emptyfile">文件夹为空</p>
                    <ul class="filelist">
                        <li v-for="(value,index) in filelistall">
                            <i class="fileimg fileimg_default"
                               :class="{
                                fileimg_box:value.fileClass==100,
                                fileimg_sp:value.fileClass==1,
                                fileimg_yp:value.fileClass==2,
                                fileimg_jpg:value.fileClass==3,
                                fileimg_ppt:value.suffix=='.pptx',
                                fileimg_doc:value.suffix=='.doc' || value.suffix=='.docx',
                                fileimg_excel:value.suffix=='.xls' || value.suffix=='.xlsx',
                                fileimg_pdf:value.suffix=='.pdf',
                                fileimg_txt:value.suffix=='.txt',
                                fileimg_rar:value.suffix=='.rar' || value.suffix=='.zip'
                                }" @dblclick="openfile(value)">
                            </i>
                            <p class="filename">{{value.filename | filename}}</p>
                        </li>
                    </ul>
                    <div class="pagenation">
                        <el-pagination layout="prev, pager, next" :total="pagetotalnum" @current-change="topage" :current-page.sync="currentPage"></el-pagination>
                    </div>
                </el-tab-pane>
            </el-tabs>
        </div>
        <div class="localfile">
            <el-button type="primary" size="large" @click="openlocal()">打开本地文件</el-button>
        </div>
    </div>
<script>
    gotC.init({
        fn:function(){
            window.vm=new Vue({
                el:'#container',
                data:{
                    activeName:'first',
                    searchfile:'',
                    prefilelist:[],
                    filelistall:[],
                    selnum:0,
                    totalcount:0,
                    //分页
                    currentPagesel:1,
                    pagetotalnumsel:0,
                    currentPage:1,
                    pagetotalnum:0,
                    event:document.createEvent('MessageEvent')
                },
                filters:{
                    filename(val){
                        if(val.length>=11){
                            return val.slice(0,10)+'...'
                        }else{
                            return val
                        }
                    }
                },
                watch:{
                    'activeName'(val,oldval){
                        if(val=='first'){
                            this.getfilelistsel(0,1,10)
                        }else{
                            this.getfilelist(0,null,1,10)
                        }
                    },
                    'currentPage'(val,oldval){
                        this.getfilelist(0,null,val,10)
                    },
                    'currentPagesel'(val,oldval){
                        val = val || 1;
                        this.getfilelistsel(0,val,10)
                    }
                },
                created:function(){
                    sendonload();
                },
                mounted:function(){
                    this.getfilelistsel(0,1,10)
                },
                methods:{
                    handleClick:function(tab, event) {
                        console.log(tab, event);
                    },
                    handleIconClick:function(ev) {
                        this.getfilelist(null,this.searchfile,1,10)
                    },
                    getfilelistsel:function(parentid,page,size){//查询已加入的文件
                        var self=this
                        var data={
                            command:'pre/queryselectedfile',
                            sessionid: getCookie('sid'),
                            loginid:getCookie('uid'),
                            uid:getCookie('uid'),
                            scheduleid:getCookie('scheduleid'),
                            reqnum:10,
                            page:page,
                            fileclass:-1
                        }
                        if(parentid){
                            data.parentid=parentid
                        }
                        function callback(res){
                            self.prefilelist=res.list
                            self.selnum=parseInt(res.count)
                            self.pagetotalnumsel=parseInt(res.count)
                        }
                        post('/pre/queryselectedfile',data,callback,errcodefn,errfn)
                    },
                    getfilelist:function(parentid,key,page,size){//查询全部文件
                        var self=this
                        var data={
                            command:'pre/schedulefilelist',
                            sessionid: getCookie('sid'),
                            loginid:getCookie('uid'),
                            uid:getCookie('uid'),
                            reqnum:10,
                            page:page,
                            file_class:-1,//-1:全部，0：其它，1：视频，2：音屏，3：图片，4：文档
                            filestatus:0
                        }
                        if(parentid){
                            data.parent_id=parentid
                        }
                        if(key){
                            data.key_word=key
                        }
                        function callback(res){
                            self.filelistall=res.filelist
                            self.totalcount=res.filelist.length
                            self.pagetotalnum=parseInt(res.totalnum)
                        }
                        post('/pre/schedulefilelist',data,callback,errcodefn,errfn)
                    },
                    topage:function(pagenum){
                        this.currentPage=pagenum
                    },
                    topagesel:function(pagenum){
                        this.currentPagesel=pagenum
                    },
                    openfile:function(obj){
                        if(this.activeName=='first'){//我的备课
                            if(obj.file_class==100){//打卡文件夹
                                this.getfilelistsel(obj.id,1)
                            }else{//打开单个文件
                                var targeturl=obj.fdfs_path
                                if(obj.file_suffix=='.xls' || obj.file_suffix=='.xlsx' || obj.file_suffix=='.pptx' || obj.file_suffix=='.doc' || obj.file_suffix=='.docx' || obj.file_suffix=='.ppt'){
                                    targeturl='https://view.officeapps.live.com/op/embed.aspx?src='+targeturl
                                }else if(obj.fileClass==1){
                                    targeturl='http://'+location.host+'/pages/assistant/show-video.html?path='+targeturl;
                                }
                                var data1={
                                    command:"openUpUrl",
                                    url:targeturl,
                                    fileName:obj.filename,
                                }
                                var event1 = new MessageEvent('callMe', { 'view': window, 'bubbles': false, 'cancelable': false, 'data': JSON.stringify(data1) })
                                document.dispatchEvent(event1)
                            }
                        }else{//全部课件
                            if(obj.fileClass==100){//打卡文件夹
                                this.getfilelist(obj.id,null,1)
                            }else{//打开单个文件
                                var targeturl=obj.filepath
                                if(obj.suffix=='.xls' || obj.suffix=='.xlsx' || obj.suffix=='.pptx' || obj.suffix=='.doc' || obj.suffix=='.docx' || obj.file_suffix=='.ppt'){
                                    targeturl='https://view.officeapps.live.com/op/embed.aspx?src='+targeturl
                                }else if(obj.fileClass==1){
                                    targeturl='http://'+location.host+'/pages/assistant/show-video.html?path='+targeturl;
                                }
                                var data2={
                                    command:"openUpUrl",
                                    url:targeturl,
                                    fileName:obj.filename,
                                }
                                var event2 = new MessageEvent('callMe', { 'view': window, 'bubbles': false, 'cancelable': false, 'data': JSON.stringify(data2) })
                                document.dispatchEvent(event2)
                            }
                        }
                    },
                    openlocal:function(){
                        var event = new MessageEvent('callMe', { 'view': window, 'bubbles': false, 'cancelable': false, 'data': '{"command":"openLocalFile"}' });
                        document.dispatchEvent(event);
                    }
                }
            })
        },
        current_course_info:true//是否需要获取课程信息
    })
</script>
</body>
</html>
