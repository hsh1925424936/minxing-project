<!DOCTYPE html>
<html>
	<head>
		<script type="text/javascript" src="../../js/assistant/layout.js" ></script>
		<meta charset="UTF-8">
		<title>新建题目</title>
		<style type="text/css">
			body{
				padding-bottom:0;
			}
			.mainOuter{
				width:700px; height:440px; padding-left:30px; padding-right:30px;
			}
			.topCon{
				width:100%; height:60px;
				color:rgb(51,51,51);
			}
			.topCon h2{
				height:100%; float:left; line-height:60px; font-size:19px;
			}
			.topCon span{
				width:22px; height:22px; float:right; display:block; position:relative;
				top:50%; margin-top:-11px; cursor:pointer;
				background-image:url('../../images/assistant/guanbi-tanchuang.png');
				background-size:100% 100%;
				background-repeat:no-repeat;
			}
			.topCon img{
				width:100%; height:100%; display:none;
			}
			.topCon span:hover img{
				display:block;
			}

			.radioOuter_left{
				width:26%; float:left; height:100%;
			}
			.radioOuter_right{
				width:74%; float:left; height:100%;
			}
			.radioOuter{
				width:100%; height:34px; margin-bottom:10px; font-size:14px;
			}
			.radioCon{
				height:100%; float:left; margin-right:36px;
			}
			.radioCon div{
				float:left; width:18px; height:18px;
				background-image:url('../../images/assistant/dianxuan.png');
				border-radius:15px;
				background-size:100% 100%; background-repeat:no-repeat;
				margin-right:7px; position:relative; margin-top:-9px; top:50%;
				cursor:pointer;
			}
			.radioCon span{
				width:100%; height:100%; display:none;
				background-image:url('../../images/assistant/dianxuan-h.png');
				border-radius:15px;
				background-size:100% 100%; background-repeat:no-repeat;
			}
			.radioCon p{
				float:left; height:100%; line-height:34px;
			}
			.typeOuter{
				margin-bottom:10px; width:100%; height:34px; font-size:14px;
			}
			.mainOuter h5{
				width:26%; height:100%; line-height:34px;
				font-size:14px; text-align:right; float:left; padding-right:10px;
			}
			.typeOuter input{
				float:left; width:380px; height:100%;
				border-radius:3px; border:1px solid #c3c3c3;
			}
			.myselect{
				float:left; width:380px; height:100%; text-align:center; line-height:34px;
				border:1px solid #c3c3c3; box-sizing:border-box; border-radius:3px;
				cursor:pointer; background-color:white;
				position:relative;
			}
			/*.myselect:hover{
				border:1px solid #999999; background-color:#f5f5f5;
			}*/
			.myselect>p{
				width:85%; height:100%; float:left; margin-right:28px;
			}
			.myselect>img{
				display:block; float:left; width:12px; height:8px; margin-top:14px;
			}
			.myselect select{
				position:absolute; width:100%; border-radius:3px;
				top:46px; z-index:1; border:1px solid #c3c3c3; font-size:16px;
				display:none; text-align:center;
			}
			.myselect select option{
				padding-top:3px; padding-bottom:3px;
			}
			.myselect select option:hover{
				background-color:#dcdcdc;
			}
			.typeOuter input{
				padding-left:5px;
			}
			.answerOuter{
				width:100%; display:none;
			}
			.answerCon{
				float:left; width:73%;
			}
			.answerCon>span{
				width:108px; height:34px; float:left; display:block; margin-right:10px;
				background-size:100% 100%; background-repeat:no-repeat; cursor:pointer;
			}
			.rightSpan{
				background-image:url('../../images/assistant/zhengque.png');
			}
			.wrongSpan{
				background-image:url('../../images/assistant/cuowu.png');
			}
			.answerCon>span>img{
				width:100%; height:100%; display:none;
			}
			.essay_textarea{
				float:left; width:380px; height:108px;
				border-radius:3px; border:1px solid #c3c3c3; padding-left:5px;
			}
			.answerCon select{
				float:left; width:128px; height:34px;
				border-radius:3px; border:1px solid #c3c3c3; text-align:center;
				padding-left:45px; font-size:18px;
			}
			.optionOuter{
				width:380px; height:145px; float:left; overflow-y:auto;
			}
			.itemBox{
				width:100%; border:1px solid #c3c3c3; border-radius:3px;
				background-color:#CCCCCC; margin-bottom:10px;
			}
			.itemBox span{
				display:block; float:left; width: 9%; height:22px;
			    font-size:15px; text-align:center; line-height:22px;
			}
			.item_textarea{
				display:block; float:left; width:91%;
				padding-left:10px; font-size:14px;
				padding-top:3px; line-height:16px; padding-bottom:3px;
				height:22px;
			}
			.addAndDel{
				width:22px; float:left; margin-left:10px;
			}
			.addAndDel span{
				background-repeat:no-repeat; background-size:100% 100%;
				display:block; width:22px; height:22px; margin-bottom:20px;
				cursor:pointer;
			}
			.minus_span{
				background-image:url(../../images/assistant/xiangjian.png);
			}
			.addAndDel span:hover img{
				display:block;
			}
			.addAndDel img{
				width:100%; height:100%; display:none;
			}
			.add_span{
				background-image:url(../../images/assistant/xiangjia.png);
			}

			.footerBtn{
				width:100%; height:38px; position:absolute; bottom:20px; right:30px;
			}
			.footerBtn button{
				display:block; float:right; width:112px; height:38px; border-radius:3px;
				font-size:16px; text-align:center; line-height:38px; box-sizing:border-box;
			}
			.closeBtn,.saveandnew{
				border:1px solid #c3c3c3; background-color:#ffffff;
			}
			.saveandnew{
				margin-right:10px;
			}
			.closeBtn:hover,.saveandnew:hover{
				background-color:#f2f2f2; border:1px solid #999999;
			}
			.saveBtn{
				background-color:#0496ca; margin-right:20px; color:white;
			}
			.saveBtn:hover{
				background-color:#0487b5;
			}
		</style>	
		
		
	</head>
	<body>
		<div class="mainOuter">
			<div class="topCon">
				<h2>新建题目</h2>
				<span class="closeSpan">
					<img src="../../images/assistant/guanbi-tanchuang-h.png">
				</span>
				
			</div>

			<div class="radioOuter">
				<div class="radioOuter_left"></div>
				<div class="radioOuter_right">
					<div class="radioCon" name='problemtype' index="0">
						<div><span style="display:block;"></span></div>
						<p>选择题</p>
					</div>
					<div class="radioCon" name='problemtype' index="1">
						<div><span></span></div>
						<p>判断题</p>
					</div>
					<!-- <div class="radioCon" name='problemtype' index="2">
						<div><span></span></div>
						<p>问答题</p>
					</div> -->
				</div>
			</div>

			<div class="typeOuter">
				<h5>题目分类:</h5>
				<!-- <select>
					<option>胸腔穿刺</option>
					<option>腹腔穿刺</option>
					<option>骨髓穿刺</option>
				</select> -->
				<div class="myselect">
					<p>请选择训练项</p><img src="../../images/assistant/sanjiao-xia.png">
					<select size="6" style="display: none;" class="learnType">
						<option>胸腔穿刺</option>
						<option>无菌术</option>
						<option>洗胃术</option>
						<option>灌肠术</option>
						<option>腹腔穿刺</option>
						<option>骨髓穿刺</option>
						<option>其他</option>
					</select>
				</div>
			</div>

			<div class="typeOuter">
				<h5>题目:</h5>
				<input type="text" placeholder="请输入题目" class="problemName">
			</div>

			<!-- 选择 -->
			<div class="answerOuter choose clearfix" style="display:block;">
				<h5>答案:</h5>
				<div class="answerCon">
					<div class="optionOuter">
						<div class="itemBox clearfix" index="1">
							<span>A</span>
							<textarea class="item_textarea" placeholder="请输入选项" rows="1" oninput="resize_textarea(this)" onkeydown="resize_textarea(this)"></textarea>
						</div>

						<div class="itemBox clearfix" index="2">
							<span>B</span>
							<textarea class="item_textarea" placeholder="请输入选项" rows="1" oninput="resize_textarea(this)" onkeydown="resize_textarea(this)"></textarea>
						</div>

						<div class="itemBox clearfix" index="3">
							<span>C</span>
							<textarea class="item_textarea" placeholder="请输入选项" rows="1" oninput="resize_textarea(this)" onkeydown="resize_textarea(this)"></textarea>
						</div>

						<div class="itemBox clearfix" index="4">
							<span>D</span>
							<textarea class="item_textarea" placeholder="请输入选项" rows="1" oninput="resize_textarea(this)" onkeydown="resize_textarea(this)"></textarea>
						</div>
					</div>
					<div class="addAndDel">
						<span class="minus_span">
							<img src="../../images/assistant/xiangjian-h.png">
						</span>
						<span class="add_span">
							<img src="../../images/assistant/xiangjia-h.png">
						</span>
					</div>
				</div>

				<h5>正确答案:</h5>
				<div class="answerCon">
					<select class="chooseSelect">
						<option value="A">A</option>
						<option value="B">B</option>
						<option value="C">C</option>
						<option value="D">D</option>
					</select>
				</div>
			</div>

			<!-- 判断 -->
			<div class="answerOuter judge clearfix">
				<h5>正确答案:</h5>
				<div class="answerCon">
					<span class="rightSpan"><img src="../../images/assistant/zhengque-h.png"></span>
					<span class="wrongSpan"><img src="../../images/assistant/cuowu-h.png"></span>
				</div>
			</div>

			<!-- 问答 -->
			<div class="answerOuter essay clearfix">
				<h5>正确答案:</h5>
				<div class="answerCon">
					<textarea class="essay_textarea" placeholder="请输入问题答案"></textarea>
				</div>
			</div>

			<div class="footerBtn">
				<button class="closeBtn">取消</button>
				<button class="saveandnew">保存并新增</button>
				<button class="saveBtn">保存</button>
			</div>

		</div>

	</body>
	
	<script type="text/javascript">
		var ABC = {1:"A",2:"B",3:"C",4:"D",5:"E",6:"F",7:"G"};
		var abc = {1:"a",2:"b",3:"c",4:"d",5:"e",6:"f",7:"g"};

		//自定义的radiobutton 需要给radioCon一个name
		$('.radioCon').click(function() {
			var radioCon_name = $('.radioCon').attr('name');
			$('.radioCon[name='+radioCon_name+']').find('span').css('display', 'none');
			$(this).find('span').css('display', 'block');
		});

		//单选框点击显示和隐藏相应的题目类型的元素
		$('.radioCon').click(function() {
			var index = $(this).attr('index');
			$('.answerOuter').css('display', 'none');
			$('.answerOuter').eq(index).css('display', 'block');
		});

		$('.answerCon>span').click(function() {
			$('.answerCon>span>img').css('display', 'none');
			$(this).find('img').css('display', 'block');
		});

		$('.closeBtn').unbind("click");
		$('.closeSpan').unbind("click");
		$('.closeBtn').click(function() {
			parent.location.reload();
		});
		$('.closeSpan').click(function() {
			parent.location.reload();
		});

		function resize_textarea(textarea){//动态调整textarea的大小
			var rows = 1;
			var height = '22px';
			if( textarea.scrollHeight > 25 ){
				rows = 2;
				height = '38px';
			}
			
			if( textarea.scrollHeight < 39 && textarea.rows == 2 ){
				rows = 1;
				height = '22px';
				textarea.rows = rows;
				$(textarea).css('height', height);
				resize_textarea(textarea);
				return false;
			}
			textarea.rows = rows;
			$(textarea).css('height', height);
		}

		$('.minus_span').click(function() {
			var index = $('.itemBox:last').attr('index');
			if(index<4){
				return false;
			}
			$('.itemBox:last').remove();
			$('.chooseSelect option:last').remove();
		});

		$('.add_span').click(function() {
			var index = $('.itemBox:last').attr('index');
			if(index>4){
				return false;
			}
			index++;
			$('.optionOuter').append(
				'<div class="itemBox clearfix" index="'+index+'">'+
					'<span>'+ABC[index]+'</span>'+
					'<textarea class="item_textarea" placeholder="请输入选项" rows="1" oninput="resize_textarea(this)" onkeydown="resize_textarea(this)"></textarea>'+
				'</div>'
			);
			$('.chooseSelect').append(
				'<option value="'+ABC[index]+'">'+ABC[index]+'</option>'
			);
		});

		//自定义的select
		$('.myselect').click(function(event) {
			if( $(this).find('select').css('display') == 'none' ){
				$(this).find('select').css('display', 'block');
			}else{
				$(this).find('select').css('display', 'none');
			}
			 event.stopPropagation();
		});
		$(document).click(function() {
			$('.myselect select').css('display', 'none');
		});
		$('.myselect select').change(function() {
			var text = $(this).find('option:selected').html();
			$(this).siblings('p').html(text);
		});

		function addlearnType(){//题目分类下拉框从后台获取选项
			var json = {
				'1':{
					command:'learn/querylearninfo', //接口地址
					sessionid:getCookie('sid'),
					loginid:getCookie('loginid'),
					canaddquestion:'1'
				}
			};

			Api.dataToJava({
				json:{
					url:'/learn/querylearninfo', //一次性走几个接口
					data:JSON.stringify(json)
				},
				fn:function (base) {
					base = base[1]; //取接口的第一个返回值
					console.log(base);
					
					//判断接口是否走成功， errcode为0是成功
					if (base.errcode!=0) {
						uselayer(3,base.errdesc);
						return false;
					}
					var learnids = base.learnids;//训练项数组
					$('.learnType').html('');
					var str = '';
					for ( var i = 0; i < learnids.length; i++ ){
						str += '<option value="'+learnids[i].learnid+'">'+learnids[i].name+'</option>';
					}
					str += '<option value="-1">其他</option>';
					$('.learnType').html(str);
					$('.myselect p').html('请选择训练项');
				}
			});
		}

		function addquestion(whichBtn){//新增题目的方法  whichBtn告诉函数是执行保存还是保存并新增
			var questionitem = null;//选择题每个选项和对应的内容
			var learnid = $('.learnType').val();//训练项id
			if ( learnid == null ){
				uselayer(3,'请选择训练项!');
				return false;
			}
			var name = $('.problemName').val();//题目名称
			if( name.trim() == '' ){
				uselayer(3,'请输入题目!');
				return false;
			}
			var cateid;//题目类型
			var answer;//题目答案
			if( $('.choose').css('display') == 'block' ){//单选
				questionitem = [];
				cateid = 1;
				answer = $('.chooseSelect').val();
				if( answer == null ){
					uselayer(3,'请选择题目答案!');
					return false;
				}
				$('.item_textarea').each(function() {
					if( $(this).val().trim() == '' ){
						uselayer(3,'请输入选项内容!');
						return false;
					}
					var itemname = ABC[$(this).parent().attr('index')];
					var content = $(this).val();
					questionitem.push({itemname:itemname,content:content});
				});

			}else if( $('.judge').css('display') == 'block' ){//判断
				cateid = 4;
				if( $('.rightSpan img').css('display') == 'block' ){
					answer = 1;
				}else if( $('.wrongSpan img').css('display') == 'block' ){
					answer = 0;
				}else{
					uselayer(3,'请选择本题答案！');
					return false;
				}
			}else{//问答
				cateid = 5;
				answer = $('.essay_textarea').val();
				if ( answer.trim() == '' ){
					uselayer(3,'请填写题目的答案!');
					return false;
				}
			}

			var json = {
				'1':{
					command:'question/addquestion', //接口地址
					learnid:learnid,
					scheduleid:getCookie('scheduleid'),
					cateid:cateid,
					name:name,
					answer:answer,
					uid:getCookie('uid'),
					questionitem:questionitem,
					sessionid:getCookie('sid'),
					loginid:getCookie('loginid')
				}
			};
			Api.dataToJava({
				json:{
					url:'/question/addquestion', //一次性走几个接口
					data:JSON.stringify(json)
				},
				fn:function (base) {
					base = base[1]; //取接口的第一个返回值
					console.log(base);
					
					//判断接口是否走成功， errcode为0是成功
					if (base.errcode!=0) {
						uselayer(3,'创建题目失败!<br/>'+base.errdesc);
						return false;
					}
					uselayer(3,'创建题目成功!',function(){
						if( whichBtn == 'save' ){
							//关闭弹窗并刷新页面
							parent.location.reload();
						}else{
							//不关闭弹窗
							window.location.reload();
						}
						
					});
					
				}
			});
		}

		$('.saveBtn').click(function() {
			addquestion('save');//点击保存后点击弹窗
		});
		$('.saveandnew').click(function() {
			addquestion('saveandnew');//点击保存过后不关闭弹窗
		});

		addlearnType();//题目分类下拉框从后台获取选项
	</script>

</html>
