<!DOCTYPE html>
<html>
	<head>
		<script type="text/javascript" src="../../js/assistant/layout.js" ></script>
		<script type="text/javascript" src="../../js/echarts.min.js" ></script>
		<script type="text/javascript" src="../../js/assistant/overTexts.js" ></script>
		<meta charset="UTF-8">
		<title>抢答</title>
		<style type="text/css">
			body{
				background-color:#ECECEC;
			}
			
			.topBar {
				width:100%; height:60px; background-color:#f5f5f5; border-top:1px solid #dcdcdc;
				border-bottom:1px solid #dcdcdc; font-size:14px;
			}
			.topBarInner{
				width:1024px; height:100%; margin:auto;
			}
			.topBar button {
			    display:block; float:right; position:relative;
			    top:50%; margin-top:-18px; height:38px; text-align:center; line-height:36px;
			    border:1px solid #0496C9; box-sizing:border-box; border-radius:3px;
			    
			}
			.return1{
				width:118px; background-color:#0496ca; color:white;
			}
			.return1:hover{
				background-color:#0487b5;
			}

			.mainCon{
				width:1024px; height:620px; margin:auto; margin-top:20px;
			}
			.mainCon>div{
				background-color:white;
			}
			.leftOuter{
				width:49.5%; height:100%; float:left; padding-left:15px; padding-right:15px;
			}
			.problemOuter{
				width:100%; height:55%; border-bottom:1px solid #EEEEEE; box-sizing:border-box;
			}
			.sub_tit{
				width:100%; height:66px; font-size:18px; line-height:66px;
			}
			.problemCon{
				width:100%; padding:10px;
			}
			.problemCon span{
				display:block; border-radius:18px; width:28px; height:28px;
				float:left; text-align:center; line-height:28px; font-size:12px;
				color:white; margin-right:10px;
			}
			.judge_span{
				background-color:#0495CA;
			}
			.choice_span{
				background-color:#2CC877;
			}
			.essay_span{
				background-color:#FFC928;
			}
			.problemCon p{
				float:left; font-size:14px; line-height:20px; padding-top:5px;
				width:410px;
			}

			.hidden_left{
				width:100%; float:left; padding-left:50px;
				color:rgb(51,51,51); max-height:225px; overflow-y:auto; 
			}
			.hidden_left>p{
				width:100%; font-size:16px;
				line-height:20px; padding-top:10px;
			}
			.hidden_left>h4{
				width:100%; line-height:18px; font-size:14px; padding-top:5px; padding-bottom:5px;
			}
			.show_answer{
				display:block; font-size:13px; margin-top:5px;
			    height:28px; text-align:center; line-height:26px;
			    border:1px solid #0496C9; box-sizing:border-box; border-radius:3px;
			    width:68px; background-color:#0496ca; color:white;
			}
			.show_answer:hover{
				background-color:#0487b5;
			}
			.answer_hidden{display:none;}

			.timeOuter{
				width:100%; height:45%;
			}
			.timeCon{
				width:242px; height:108px; margin:auto; margin-top:10px;
				text-align:center; line-height:108px; margin-bottom:25px;
				font-size:60px; letter-spacing:20px; position:relative;
			}
			.timeBox{
				width:100%; height:100%; position:absolute; z-index:3;
				left:0; top:0;
			}
			.timebg_con{
				width:100%; height:100%; position:absolute; z-index:1;
				left:0; top:0;
			}
			.timebg_con>h4{
				width:48px; height:100%; float:left; background-color:#cccccc;
			}
			.timebg_con>h4:nth-child(1){
				margin-left:-6px;
			}
			.timebg_con>h4:nth-child(2){
				margin-left:7px;
			}
			.timebg_con>h4:nth-child(3){
				margin-left:40px;
			}
			.timebg_con>h4:nth-child(4){
				margin-left:8px;
			}
			.status_txt{
				text-align:center; font-size:16px; color:rgb(4,150,202);
			}
			.voteOuter{
				display:none;
			}
			.voteChartOuter{
				width:100%; height:200px; border:1px solid #ccc;
				padding-left:50px; padding-right:50px;
			}
			.vote_count_down{
				float:right; height:100%; font-size:14px;
			}
			.vote_count_down span{
				font-size:17px;
			}

			.rightOuter{
				width:49.5%; height:100%; float:right; padding-left:15px; padding-right:15px;
			}
			.status1{
				width:100%; height:100%; line-height:620px; text-align:center; font-size:30px;
			}
			.status2{
				width:265px; line-height:50px; text-align:left; font-size:30px;
				color:#0495CA; margin:auto; margin-top:250px; display:none;
			}
			.status3{
				width:100%; height:100%; display:none;
			}
			.answer_area{
				width:100%; height:420px; border:1px solid #ccc;
				border-radius:3px;
			}
			.answer_area_1{
				text-align:center; line-height:460px; font-size:50px; color:#0495CA;
			}
			.answer_area_2{
				line-height:26px; font-size:16px; text-indent:2em; padding:15px;
				overflow-y:auto;
			}
			

			.status3 button{
				display:block; height:38px; text-align:center; line-height:36px;
			    box-sizing:border-box; border-radius:3px;
			    width:118px; margin-left:360px; background-color:#2CC779; color:white;
			    margin-top:15px;
			}
			
		</style>


	</head>
	<body>
		<div class="topBar">
			<div class="topBarInner">
				<button type="button" class="return1">返回</button>
			</div>
		</div>

		<div class="mainCon">
			<div class="leftOuter">
				<div class="problemOuter">
					<h3 class="sub_tit">题目描述</h3>
					<div class="problemCon clearfix">
						<span class="choice_span">
							选
						</span>
						<p>
							疑为胸腔包虫病患者，穿刺可引起感染扩散，不宜穿刺。( )
						</p>
					</div>
					<div class="hidden_left">
						<h4>A、锁骨中线第2肋间</h4>
						<h4>B、锁骨中线第2肋间</h4>
						<h4>C、锁骨中线第2肋间</h4>
						<h4>D、锁骨中线第2肋间</h4>
						<h4>E、锁骨中线第2肋间</h4>
						<button type="button" class="show_answer">标准答案</button>
						<p class="answer answer_hidden">
							正确答案内容
						</p>
					</div>
				</div>

				<!-- 倒计时时钟 -->
				<div class="timeOuter">
					<div class="count_dowmOuter">
						<h3 class="sub_tit">倒计时</h3>
						<div class="timeCon">
							<div class="timeBox">
								<span class="minute">01</span><span>:</span><span class="second">00</span>
							</div>
							<div class="timebg_con">
								<h4></h4>
								<h4></h4>
								<h4></h4>
								<h4></h4>
							</div>
						</div>

						<h3 class="status_txt">抢答中...</h3>
					</div>

				</div>

				<div class="voteOuter">
					<h3 class="sub_tit">
						投票统计
						<p class="vote_count_down">
							投票倒计时&nbsp;&nbsp;:&nbsp;&nbsp;<span class="minute2">01</span><span>:</span><span class="second2">00</span>
						</p>
					</h3>
					<div class="voteChartOuter">
						
					</div>
				</div>
					
			</div>
			<div class="rightOuter">
				<div class="status1">
					抢答中......
				</div>
				<div class="status2">
					第一组抢到答题权<br/>请答题
				</div>
				<div class="status3">
					<h3 class="sub_tit">第一组答案</h3>
					<p class="answer_area answer_area_1">
						问答题的内容问答题的内容问答题的内容问答题的内容问答题的内容问答题的内容问答题的内容问答题的内容问答题的内容问答题的内容问答题的内容问答题的内容问答题的内容问答题的内容问答题的内容问答题的内容
					</p>
					
					<button class="start_vote">发起投票</button>
				</div>
			</div>
		</div>
	</body>
	
	<script type="text/javascript">
		var t; //抢答倒计时的定时器
		var t1; //轮询投票的结果的定时器
		var t2;//投票的计时器
		var scheduleid = GetQueryString('scheduleid');
		var qid = GetQueryString('qid');
		var questionbaseid = GetQueryString('questionbaseid');
		var sgindex;//被投票组号
		var stdid;//被投票学生id
		var voteid;//投票id
		var cateid = GetQueryString('cateid');
		
		$('.start_vote').click(function() {//开始投票
			$(this).attr('disabled', 'disabled');
			$(this).css('background-color', '#CCCCCC');
			$('.timeOuter').css('display', 'none');
			$('.voteOuter').css('display', 'block');
			writeAnswer({obj:$('.voteChartOuter')[0]});
			t2 = setInterval(function(){
				count_dowon($('.minute2'),$('.second2'));
				if( $('.minute2').html() == 0 && $('.second2').html() == 0 ){
					clearInterval(t1);
				}
			},1000);
		});

		function show_hidden_answer(){//显示和隐藏答案
			$('.show_answer').click(function() {
				if( $('.answer').hasClass('answer_hidden') ){
					$('.answer').removeClass('answer_hidden');
				}else{
					$('.answer').addClass('answer_hidden');
				}
			});
		}
		

		//倒计时的方法
		function count_dowon(minuteEle,secondEle){
			var minute = minuteEle.html();
			var second = secondEle.html();
			second--;
			if(second < 0 && minute > 0){
				second = 59;
				minute--;
			}else if(second < 0 && minute == 0){
				clearInterval(t);
				clearInterval(t2);
				return false;
			}
			minute = addzero(parseInt(minute));
			second = addzero(parseInt(second));
			minuteEle.html(minute);
			secondEle.html(second);
		}

		var myChart;
		function writeAnswer(opt) {//选择的答案统计图表
			myChart = echarts.init(opt.obj);
			var option = {
			    color: ['#3398DB'],
			    tooltip : {
			        trigger: 'item',
			        axisPointer : {            // 坐标轴指示器，坐标轴触发有效
			            type : 'shadow'        // 默认为直线，可选为：'line' | 'shadow'
			        },
			        show:false
				},
			    grid: {
			        left: '3%',
			        right: '4%',
			        bottom: '3%',
			        containLabel: true
			    },
			    xAxis : [
			        {
			            type : 'category',
			            data : [''],
			            axisTick: {
			                alignWithLabel: true
			            },
			            axisLine:{
			            	lineStyle:{
			            		color:'#ccc'
			            	}
			            },
			            axisLabel:{
			            	textStyle:{
			            		color:'black',
			            	}
			            }
			        }
			    ],
			    yAxis : [
			        {
			            type : 'value',
			            axisLine:{
			            	lineStyle:{
			            		color:'#ccc'
			            	}
			            },
			            axisLabel:{
			            	textStyle:{
			            		color:'black'
			            	}
			            },
			            name:'票数',
			            minInterval: 5,
			            max:40
			        }
			    ],
			    series : [
			        {
			            name:'答案统计',
			            type:'bar',
			            barWidth: '30%',
			            label:{
			            	normal:{
			            		show:true,
			            		position:'top',
			            		 textStyle: {
                                    color: '#000',
                                    fontSize:18
                                },
                                formatter:function(a){
									return a.data.value;
								}
			            	}
			            },
			            data:[0]
			        }
			    ]
			};

			myChart.setOption(option);
		};

		$('.return1').click(function() {
			closeProject();
			history.go(-1);
        });

        function show_problem(){//显示问题
        	$('.problemOuter').html('');
			var json = {
				'1':{
					command:'question/querysinglequestion', //接口地址
					questionbaseid:questionbaseid,
					sessionid:getCookie('sid'),
					loginid:getCookie('loginid')
				}
			};

			Api.dataToJava({
				json:{
					url:'/question/querysinglequestion', //一次性走几个接口
					data:JSON.stringify(json)
				},
				fn:function (base) {
					base = base[1]; //取接口的第一个返回值
					console.log(base);
					
					//判断接口是否走成功， errcode为0是成功
					if (base.errcode!=0) {
						uselayer(3,base.errdesc);
						return false;
					}

					var str = '<h3 class="sub_tit">题目描述</h3>';
					// var cateid = problem_list[0].cateid;
					if( cateid == 1 || cateid == 2 ){//单选或者多选
						str +=
						'<div class="problemCon clearfix">'+
							'<span class="choice_span">'+
								'选'+
							'</span>'+
							'<p>'+
								base.name+'( )'+
							'</p>'+
						'</div>'+
						'<div class="hidden_left">';
							for ( var j = 0; j < base.questionitem.length; j++ ){
								var name = base.questionitem[j].itemname;
								var content = base.questionitem[j].content;
								str +=
								'<h4>'+name+'、'+content+'</h4>';
							}
							str += '<button type="button" class="show_answer">标准答案</button>';
							str +=
							'<p class="answer answer_hidden">'+base.answer+'</p>'+
						'</div>';
					}else if ( cateid == 5 ){//问答题
						// str +=
						// '<div class="problemCon clearfix">'+
						// 	'<span class="essay_span">'+
						// 		'问'+
						// 	'</span>'+
						// 	'<p>'+
						// 		problem_list[0].name+
						// 	'</p>'+
						// '</div>'+
						// '<div class="hidden_left">'+
						// 	'<button type="button" class="show_answer">标准答案</button>'+
						// 	'<p class="answer answer_hidden">'+problem_list[0].answer+'</p>'+
						// '</div>';
						// $('.radioOuter').css('display', 'block');
						// $('.answer_area').removeClass('answer_area_1');
						// $('.answer_area').addClass('answer_area_2');
					}else if ( cateid == 4 ){//判断题
						var answer = '正确';
						if( base.answer == 0 ){
							answer = '错误';
						}
						str +=
						'<div class="problemCon clearfix">'+
							'<span class="judge_span">'+
								'判'+
							'</span>'+
							'<p>'+
								base.name+
							'</p>'+
						'</div>'+
						'<div class="hidden_left">'+
							'<button type="button" class="show_answer">标准答案</button>'+
							'<p class="answer answer_hidden">'+answer+'</p>'+
						'</div>';
					}
					
					$('.problemOuter').html(str);
					//$('.problemOuter').attr('cateid',cateid);
					show_hidden_answer();//显示和隐藏答案按钮的事件注册
				}
			});
		}

		function qiangda(){
			var minute = GetQueryString('minute');
			var second = GetQueryString('second');
			$('.minute').html(minute);
			$('.second').html(second);
			t = setInterval(function(){
				count_dowon($('.minute'),$('.second'));
				if( $('.minute').html() == 0 && $('.second').html() == 0 ){
					$('.status3').attr('isover','1');//标记抢答的倒计时结束了
				}
			},1000);
			
			query_qiangda();//轮询是否有抢答
		}

		function query_qiangda(){//查询是否有抢答
			if ( $('.status3').attr('isover') == 1 ){//倒计时已经结束了,退出查询
				$('.status1').html('对不起，倒计时结束！');
				$('.status2').html('对不起，倒计时结束！');
				return false;
			}
			setTimeout(function(){
				var json = {
					'1':{
						command:'question/queryraceinfo', //接口地址
						qid:qid,
						scheduleid:scheduleid,
						sessionid:getCookie('sid'),
						loginid:getCookie('loginid')
					}
				};

				Api.dataToJava({
					json:{
						url:'/question/queryraceinfo', //一次性走几个接口
						data:JSON.stringify(json)
					},
					fn:function (base) {
						base = base[1]; //取接口的第一个返回值
						console.log(base);
						
						//判断接口是否走成功， errcode为0是成功
						if (base.errcode!=0) {
							
						}

						if( !base.sgindex && !base.stdid ){//还没有抢到
							query_qiangda();//再次查询
							return false;
						}
						
						//抢到之后改变页面显示
						$('.status_txt').html('答题中...');
						if( base.sgindex ){//小组抢到
							$('.status2').html('第'+base.sgindex+'组抢到答题权<br/>请答题');
							$('.status3 .sub_tit').html('第'+base.sgindex+'组答案');
							sgindex = base.sgindex;
						}else if( base.stdid ){//学生抢到
							$('.status2').html(base.name+'抢到答题权<br/>请答题');
							$('.status3 .sub_tit').html(base.name+'的答案');
							stdid = base.stdid;
						}
						$('.status1').css('display', 'none');
						$('.status2').css('display', 'block');

						query_answer();//抢到之后查询答案
					}
				});
			},3000);
		}

		function query_answer(){//抢到之后查询答案
			if ( $('.status3').attr('isover') == 1 ){//倒计时已经结束了,退出查询
				$('.status1').html('对不起，倒计时结束！');
				$('.status2').html('对不起，倒计时结束！');
				return false;
			}
			setTimeout(function(){
				var json = {
					'1':{
						command:'question/querystudentanswer', //接口地址
						qid:qid,
						scheduleid:scheduleid,
						sessionid:getCookie('sid'),
						loginid:getCookie('loginid')
					}
				};

				Api.dataToJava({
					json:{
						url:'/question/querystudentanswer',
						data:JSON.stringify(json)
					},
					fn:function (base) {
						base = base[1]; //取接口的第一个返回值
						console.log(base);
						
						//判断接口是否走成功， errcode为0是成功
						if (base.errcode!=0) {
							uselayer(3,base.errdesc);
							return false;
						}

						if( base.answerresult.length == 0 ){//还没有答题
							query_answer();//再次查询答案
							return false;
						}
						
						//改变样式
						$('.status_txt').html('答题结束');
						if( cateid == 1 || cateid == 5 ){//单选,问答
							$('.answer_area ').html(base.answerresult[0].answer);
						}else if( cateid == 4 ){//判断
							var answer = '正确';
							if( base.answerresult[0].answer == 0 ){
								answer = '错误';
							}
							$('.answer_area ').html(answer);
						}
						
						$('.status2').css('display', 'none');
						$('.status3').css('display', 'block');

						if ( $('.status3').attr('isover') != 1 ){//答题先结束把倒计时关闭(倒计时还没结束时)
							clearInterval(t);
						}

					}
				});
			},3000);
		}

		function start_vote(){//动态显示投票结果
			$('.start_vote').click(function() {//发起投票
				var deadline = 60;
				var json = {
					'1':{
						command:'question/announcevote', //接口地址
						qid:qid,
						scheduleid:scheduleid,
						deadline:deadline,
						sessionid:getCookie('sid'),
						loginid:getCookie('loginid')
					}
				};

				if( sgindex ){
					json[1].sgindex = sgindex;//抢到的小组组号
				}else{
					json[1].stdid = stdid;//抢到的学生id
				}
				Api.dataToJava({
					json:{
						url:'/question/announcevote', //一次性走几个接口
						data:JSON.stringify(json)
					},
					fn:function (base) {
						base = base[1]; //取接口的第一个返回值
						console.log(base);
						
						//判断接口是否走成功， errcode为0是成功
						if (base.errcode!=0) {
							uselayer(3,'发起投票失败<br/>'+base.errdesc);
							return false;
						}
						uselayer(3,'发起投票成功！');
						voteid = base.voteid;
						t1 = setInterval(function(){
							show_vote();
						},3000);//定时刷新投票的结果

					}
				});
			});
		}

		function show_vote(){//显示投票结果
			console.log('execute show_vote');
			var json = {
				'1':{
					command:'question/queryvotecount', //接口地址
					voteid:voteid,
					sessionid:getCookie('sid'),
					loginid:getCookie('loginid')
				}
			};

			Api.dataToJava({
				json:{
					url:'/question/queryvotecount', //一次性走几个接口
					data:JSON.stringify(json)
				},
				fn:function (base) {
					base = base[1]; //取接口的第一个返回值
					console.log(base);
					
					//判断接口是否走成功， errcode为0是成功
					if (base.errcode!=0) {
						uselayer(3,base.errdesc);
						return false;
					}

					var option = myChart.getOption();
					option.series[0].data[0] = base.count;
					myChart.setOption(option);

				}
			});
		}

    	show_problem();//显示问题
		qiangda();
		start_vote();//开始投票
		openProject();

	</script>

</html>
