<!DOCTYPE html>
<html>
	<head>
		<script type="text/javascript" src="../../js/assistant/layout.js" ></script>
		<meta charset="UTF-8">
		<title>从题库中选择题目</title>
		<style type="text/css">
			body{
				padding-bottom:0;
			}
			.mainOuter{
				width:850px; height:480px; padding-left:30px; padding-right:30px;
			}
			.topCon{
				width:100%; height:60px;
				color:rgb(51,51,51);
			}
			.topCon h2{
				height:100%; float:left; line-height:60px; font-size:19px;
			}
			.topCon span{
				width:22px; height:22px; float:right; display:block; position:relative;
				top:50%; margin-top:-11px; cursor:pointer;
				background-image:url('../../images/assistant/guanbi-tanchuang.png');
				background-size:100% 100%;
				background-repeat:no-repeat;
			}
			.topCon img{
				width:100%; height:100%; display:none;
			}
			.topCon span:hover img{
				display:block;
			}

			.firstLine{
				width:100%; height:34px; font-size:13px; margin-bottom:10px;
			}
			.firstLineLeft{
				width:316px; height:100%; float:left;
			}
			/*.firstLineLeft span{
				height:100%; float:left; line-height:34px; display:block;
				width:40%;
			}
			.firstLineLeft select{
				width:60%; height:100%; float:left; border-radius:3px;
				border:1px solid #c3c3c3;
			}*/
			.myselect{
				width:100%; height:100%; text-align:center; line-height:34px;
				border:1px solid #c3c3c3; box-sizing:border-box; border-radius:3px;
				cursor:pointer; background-color:white;
				position:relative;
			}
			/*.myselect:hover{
				border:1px solid #999999; background-color:#f5f5f5;
			}*/
			.myselect>p{
				width:85%; height:100%; float:left; margin-right:18px;
			}
			.myselect>img{
				display:block; float:left; width:12px; height:8px; margin-top:14px;
			}
			.myselect select{
				position:absolute; width:100%; border-radius:3px;
				top:46px; z-index:1; border:1px solid #c3c3c3; font-size:16px;
				display:none; text-align:center;
			}
			.myselect select option{
				padding-top:3px; padding-bottom:3px;
			}
			.myselect select option:hover{
				background-color:#dcdcdc;
			}
			.firstLine h3{
				width:370px; height:100%; float:right; line-height:34px;
				font-size:13px;
			}

			.stuOuter{
				width:100%; height:270px; 
			}
			.table1{
				width:316px; height:100%; font-size:14px; border:1px solid #cccccc;
				float:left;
			}
			.table2{
				width:370px; height:100%; font-size:14px; border:1px solid #cccccc;
				float:right;
			}
			.th{
				width:100%; height:38px; background-color:#EEEEEE; border-bottom:1px solid #cccccc;
				padding-top:11px; padding-bottom:11px;
			}
			.trCon{
				height:220px; overflow-y:auto; 
			}
			.tr{
				width:100%; min-height:30px; border-bottom:1px solid #cccccc;
				padding-top:6px; padding-bottom:6px;
			}
			.tr:hover{
				background-color:#F5F5F5;
			}

			.td{
				min-height:16px; line-height:16px; text-align:center; float:left;
			}

			.table1 .td:nth-child(1){
				width:18%;
			}
			.table1 .td:nth-child(2){
				width:68%;
			}
			.table1 .td:nth-child(3){
				width:14%;
			}

			.table2 .td:nth-child(1){
				width:10%;
			}
			.table2 .td:nth-child(2){
				width:21%;
			}
			.table2 .td:nth-child(3){
				width:57%;
			}
			.table2 .td:nth-child(4){
				width:12%;
			}
			
			.td:nth-child(1) span{
				width:16px; height:16px; display:block; border:1px solid #cccccc;
				border-radius:2px; margin:auto; background-color:white; cursor:pointer;
			}
			.td:nth-child(1) img{
				width:100%; height:100%; display:none;
				-moz-user-select: none; 
				-webkit-user-select: none; 
				-ms-user-select: none; 
				-khtml-user-select: none; 
				user-select: none;
			}

			.th .td:nth-child(2),.th .td:nth-child(3),.td:nth-child(4){
				border-left:1px solid #B2B2B2;
			}

			.addordelete{
				float:left; width:80px; margin-top:76px;
				margin-left:11px; margin-right:11px;
			}
			.addordelete button{
				width:100%; height:38px; border-radius:3px; border:1px solid #999999;
				text-align:center; line-height:38px; font-size:14px;
				background-color:white; margin-bottom:10px;
			}
			.btnDisabled{
				opacity:0.6;
			}

			.footerBtn{
				width:100%; height:38px; margin-top:35px; 
			}
			.footerBtn button{
				display:block; float:right; width:112px; height:38px; border-radius:3px;
				font-size:16px; text-align:center; line-height:38px; box-sizing:border-box;
			}
			.closeBtn{
				border:1px solid #c3c3c3; background-color:#ffffff;
			}
			.closeBtn:hover{
				background-color:#f2f2f2; border:1px solid #999999;
			}
			.saveBtn{
				background-color:#0496ca; margin-right:20px; color:white;
			}
			.saveBtn:hover{
				background-color:#0487b5;
			}
		</style>	
		
		
	</head>
	<body>
		<div class="mainOuter">
			<div class="topCon">
				<h2>从题库选择题目</h2>
				<span class="closeSpan">
					<img src="../../images/assistant/guanbi-tanchuang-h.png">
				</span>
				
			</div>

			<div class="firstLine">
				<div class="firstLineLeft">
					<!-- <span>请选择训练项:</span>
					<select>
						<option>胸腔穿刺</option>
						<option>无菌术</option>
						<option>洗胃术</option>
						<option>灌肠术</option>
						<option>其他</option>
					</select> -->
					<div class="myselect">
						<p>请选择训练项:</p><img src="../../images/assistant/sanjiao-xia.png">
						<select size="6" style="display: none;" class="learnType">
							<option>胸腔穿刺</option>
							<option>无菌术</option>
							<option>洗胃术</option>
							<option>灌肠术</option>
							<option>腹腔穿刺</option>
							<option>骨髓穿刺</option>
							<option>其他</option>
						</select>
					</div>
				</div>
				<h3>已选择的题目:</h3>
				
			</div>
		
			<div class="stuOuter">
				
				<div class="mytable table1">
					<div class="th">
						<div class="td">
							<span class="checkboxall">
								<img src="../../images/assistant/gouxuan-h.png">
							</span>
						</div>
						<div class="td">
							题目
						</div>
						<div class="td">
							题型
						</div>
					</div>

					<div class="trCon trCon1">
						<div class="tr clearfix">
							<div class="td">
								<span class="checkbox">
									<img src="../../images/assistant/gouxuan-h.png">
								</span>
							</div>
							<div class="td">
								判断题内容判断题内容判断题内容
							</div>
							<div class="td">
								判
							</div>
						</div>
						<div class="tr clearfix">
							<div class="td">
								<span class="checkbox">
									<img src="../../images/assistant/gouxuan-h.png">
								</span>
							</div>
							<div class="td">
								问答题内容问答题内容问答题内容
							</div>
							<div class="td">
								问
							</div>
						</div>
						<div class="tr clearfix">
							<div class="td">
								<span class="checkbox">
									<img src="../../images/assistant/gouxuan-h.png">
								</span>
							</div>
							<div class="td">
								选择题内容选择题内容选择题内容
							</div>
							<div class="td">
								选
							</div>
						</div>
					</div>

				</div>

				<div class="addordelete">
					<button class="addBtn btnDisabled" disabled>增加>></button>
					<button class="delBtn btnDisabled" disabled><<删除</button>
				</div>

				<div class="mytable table2">
					<div class="th">
						<div class="td">
							<span class="checkboxall">
								<img src="../../images/assistant/gouxuan-h.png">
							</span>
						</div>
						<div class="td">
							类别
						</div>
						<div class="td">
							题目
						</div>
						<div class="td">
							题型
						</div>
					</div>

					<div class="trCon trCon2">
						<div class="tr clearfix">
							<div class="td">
								<span class="checkbox">
									<img src="../../images/assistant/gouxuan-h.png">
								</span>
							</div>
							<div class="td">
								胸腔穿刺
							</div>
							<div class="td">
								题目题目题目题目题目题目题目
							</div>
							<div class="td">
								选
							</div>
						</div>
						<div class="tr clearfix">
							<div class="td">
								<span class="checkbox">
									<img src="../../images/assistant/gouxuan-h.png">
								</span>
							</div>
							<div class="td">
								胸腔穿刺
							</div>
							<div class="td">
								题目题目题目题目题目题目题目
							</div>
							<div class="td">
								选
							</div>
						</div>
					</div>

				</div>

			</div>

			<div class="footerBtn">
				<button class="closeBtn">取消</button>
				<button class="saveBtn">保存</button>
			</div>

		</div>

	</body>
	
	<script type="text/javascript">
		var presentProblemOrigin = [];//存放原先的本次课的题目数组
		var presentProblem = [];//存放修改过后的本次课的题目数组
		var allProblem = [];//存放所有题目的数组
		var learnids = [];//存放训练项数组

		function checkbox_click(){//绑定子复选框点击事件
			//自定义的复选框
			$('.checkbox').click(function() {
				if( $(this).attr('selected') == 'selected' ){//取消选择
					$(this).removeAttr('selected');
					$(this).find('img').css('display', 'none');
					$(this).parents('.tr').removeAttr('style');//取消这一行的颜色
				}else{
					$(this).attr('selected', 'selected');
					$(this).find('img').css('display', 'block');
					$(this).parents('.tr').css('background-color', '#F5F5F5');//加上这一行的颜色
				}

				var hasNot = 0;//如果有未选择的复选框，变量为1
				$(this).parents('.trCon').find('.checkbox').each(function() {
					if( $(this).attr('selected') == 'selected' ){
					}else{
						hasNot = 1;
					}
				});
				var checkboxall = $(this).parents('.mytable').find('.checkboxall');
				if(hasNot == 1 && checkboxall.attr('selected') == 'selected'){
					checkboxall.removeAttr('selected');//取消全选复选框
					checkboxall.find('img').css('display', 'none');
				}else if(hasNot == 0 && !checkboxall.attr('selected')){
					checkboxall.attr('selected', 'selected');//选中全选复选框
					checkboxall.find('img').css('display', 'block');
				}

			});
		}
		function checkbox_cancel(){//解绑子复选框点击事件
			$('.checkbox').unbind('click');
		}
		
		$('.checkboxall').click(function() {//全选复选框的点击事件
			if( $(this).attr('selected') == 'selected' ){//取消选择全选复选框
				$(this).removeAttr('selected');
				$(this).find('img').css('display', 'none');
				$(this).parents('.mytable').find('.checkbox[selected=selected]').click();//把子复选框也取消选择
			}else{
				$(this).attr('selected', 'selected');//选中全选复选框
				$(this).find('img').css('display', 'block');
				$(this).parents('.mytable').find('.checkbox').each(function() {//把子复选框也选中
					if( $(this).attr('selected') == 'selected' ){
					}else{
						$(this).click();
					}
				});

			}
		});

		//当左边的框点击时删除按钮变灰，当右边的框点击时增加按钮变灰
		$('.table1').click(function() {
			canAdd();
		});

		$('.table2').click(function() {
			canDel();
		});

		function canAdd(){//判断当前能否导入题目,并相应改变导入按钮的状态
			if( $('.table1').find('.checkbox[selected=selected]').length < 1 ){
				$('.addBtn').attr('disabled', 'disabled');
				$('.addBtn').addClass('btnDisabled');
			}else{
				$('.addBtn').removeAttr('disabled');
				$('.addBtn').removeClass('btnDisabled');
			}
		}

		function canDel(){//判断当前能否删除题目,并相应改变导入按钮的状态
			if( $('.table2').find('.checkbox[selected=selected]').length < 1 ){
				$('.delBtn').attr('disabled', 'disabled');
				$('.delBtn').addClass('btnDisabled');
			}else{
				$('.delBtn').removeAttr('disabled');
				$('.delBtn').removeClass('btnDisabled');
			}
		}

		function my_select(){//自定义的select事件的注册(界面显示效果相关的)
			$('.myselect').click(function(event) {
				if( $(this).find('select').css('display') == 'none' ){
					$(this).find('select').css('display', 'block');
				}else{
					$(this).find('select').css('display', 'none');
				}
				 event.stopPropagation();
			});
			$(document).click(function() {
				$('.myselect select').css('display', 'none');
			});
			$('.myselect select').change(function() {
				var text = $(this).find('option:selected').html();
				$(this).siblings('p').html(text);
			});
		}

		function addlearnType(){//题目分类下拉框从后台获取选项
			var json = {
				'1':{
					command:'learn/querylearninfo', //接口地址
					sessionid:getCookie('sid'),
					loginid:getCookie('loginid'),
					canaddquestion:'1'
				}
			};

			Api.dataToJava({
				json:{
					url:'/learn/querylearninfo', //一次性走几个接口
					data:JSON.stringify(json)
				},
				fn:function (base) {
					base = base[1]; //取接口的第一个返回值
					console.log(base);
					
					//判断接口是否走成功， errcode为0是成功
					if (base.errcode!=0) {
						uselayer(3,base.errdesc);
						return false;
					}
					learnids = base.learnids.slice(0);//训练项数组
					$('.learnType').html('');
					var str = '';
					//str += '<option value="0">全部</option>';
					for ( var i = 0; i < learnids.length; i++ ){
						str += '<option value="'+learnids[i].learnid+'">'+learnids[i].name+'</option>';
					}
					str += '<option value="-1">其他</option>';
					$('.learnType').html(str);
					my_select();//自定义的select事件的注册
					learnType_change();//下拉框改变时刷新数据

					getPresentProblem();//获取当堂课的题目
				}
			});
		}

		function getPresentProblem(){//获取当堂课的题目
			var json = {
				'1':{
					command:'question/queryquestions', //接口地址
					scheduleid:getCookie('scheduleid'),
					sessionid:getCookie('sid'),
					loginid:getCookie('loginid')
				}
			};

			Api.dataToJava({
				json:{
					url:'/question/queryquestions', //一次性走几个接口
					data:JSON.stringify(json)
				},
				fn:function (base) {
					base = base[1]; //取接口的第一个返回值
					console.log(base);
					
					//判断接口是否走成功， errcode为0是成功
					if (base.errcode!=0) {
						uselayer(3,base.errdesc);
						return false;
					}

					presentProblemOrigin = base.questionsresult.slice(0);
					presentProblem = base.questionsresult.slice(0);
					
					for ( var i = 0; i < presentProblem.length; i++ ){
						for ( var j = 0; j < learnids.length; j++ ){
							if( presentProblem[i].learnid == learnids[j].learnid ){
								presentProblem[i].learnname = learnids[j].name;
							}
						}
					}
					//默认点击下拉框的第一个选项
					var learnid = $('.learnType').find('option').eq(0).val();
					$('.myselect select').val(learnid); $('.myselect select').change();

					showPresentProblem();//显示当堂课的题目列表
				}
			});
		}

		function showPresentProblem(){//显示当堂课的题目列表
			if( $('.checkboxall').eq(1).attr('selected') ){//把之前点的全选按钮还原
				$('.checkboxall').eq(1).click();
			}
			var str = '';
			for ( var i = 0; i < presentProblem.length; i++ ){
				var cate;
				var cateid = presentProblem[i].cateid;
				if( cateid == 1 ){
					cate = '选';
				}else if( cateid == 4 ){
					cate = '判';
				}else if( cateid == 5 ){
					cate = '问';
				}
				str += 
				'<div class="tr clearfix" qid="'+presentProblem[i].qid+'">'+
					'<div class="td">'+
						'<span class="checkbox">'+
							'<img src="../../images/assistant/gouxuan-h.png" style="display: none;">'+
						'</span>'+
					'</div>'+
					'<div class="td">'+
						presentProblem[i].learnname+
					'</div>'+
					'<div class="td">'+
						presentProblem[i].name+
					'</div>'+
					'<div class="td">'+
						cate+
					'</div>'+
				'</div>';
			}
			$('.trCon2').html(str);
			checkbox_cancel();//解绑子复选框点击事件
			checkbox_click();//绑定子复选框点击事件
			canDel();//删除题目按钮变灰
		}

		function showAllProblem(){//显示题库题目列表
			if( $('.checkboxall').eq(0).attr('selected') ){//把之前点的全选按钮还原
				$('.checkboxall').eq(0).click();
			}

			var str = '';
			for ( var i = 0; i < allProblem.length; i++ ){
				var isRepeat = 0;//判断是否有已经选择过的
				for( var j = 0; j < presentProblem.length; j++  ){
					if( allProblem[i].qid == presentProblem[j].qid ){
						isRepeat = 1;
						break;
					}
				}
				if ( isRepeat == 1 ){
					continue;
				}
				var cate;
				var cateid = allProblem[i].cateid;
				if( cateid == 1 ){
					cate = '选';
				}else if( cateid == 4 ){
					cate = '判';
				}else if( cateid == 5 ){
					cate = '问'; continue;
				}
				str += 
				'<div class="tr clearfix" qid="'+allProblem[i].qid+'">'+
					'<div class="td">'+
						'<span class="checkbox">'+
							'<img src="../../images/assistant/gouxuan-h.png" style="display: none;">'+
						'</span>'+
					'</div>'+
					'<div class="td">'+
						allProblem[i].name+
					'</div>'+
					'<div class="td">'+
						cate+
					'</div>'+
				'</div>';
				allProblem[i].learnname = $('.myselect p').html();
			}
			$('.trCon1').html(str);
			checkbox_cancel();//解绑子复选框点击事件
			checkbox_click();//绑定子复选框点击事件
			canAdd();//导入题目按钮变灰
		}

		function getAllProblem(learnid){//获取所有的题目
			var learnid = learnid || null;
			var json = {
				'1':{
					command:'question/queryquestions', //接口地址
					learnid:learnid,
					sessionid:getCookie('sid'),
					loginid:getCookie('loginid')
				}
			};

			Api.dataToJava({
				json:{
					url:'/question/queryquestions', //一次性走几个接口
					data:JSON.stringify(json)
				},
				fn:function (base) {
					base = base[1]; //取接口的第一个返回值
					console.log(base);
					
					//判断接口是否走成功， errcode为0是成功
					if (base.errcode!=0) {
						uselayer(3,base.errdesc);
						return false;
					}
					allProblem = base.questionsresult;
					showAllProblem();
				}
			});
		}

		function learnType_change(){//当选择训练项下拉框改变时的方法
			$('.learnType').change(function() {
				var learnid = $('.learnType').val();
				getAllProblem(learnid);

			});
		}

		function addProblem(){//本堂课增加题目的方法
			$('.addBtn').click(function() {
				if( $('.trCon1 .checkbox[selected=selected]').length < 1 && $('.trCon1 .tr').length > 0 ){
					uselayer(3,'请选择要导入的题目!');
					return false;
				}
				if( $('.trCon1 .tr').length < 1 ){
					uselayer(3,'当前没有要导入的题目!');
					return false;
				}
				for ( var i = 0; i < $('.trCon1 .checkbox[selected=selected]').length; i++){
					var tr = $('.trCon1 .checkbox[selected=selected]').eq(i).parents('.trCon1 .tr');
					var qid = tr.attr('qid');

					for( var j = 0; j < allProblem.length; j++ ){
						if( qid == allProblem[j].qid ){
							presentProblem.push(allProblem[j]);//增加
						}
					}
					
				}
				showAllProblem();//显示当堂课的题目列表
				showPresentProblem();//显示当堂课的题目列表
			});
		}

		function deleteProblem(){//本堂课删除题目的方法
			$('.delBtn').click(function() {
				if( $('.trCon2 .checkbox[selected=selected]').length < 1 && $('.trCon2 .tr').length > 0 ){
					uselayer(3,'请选择要导入的题目!');
					return false;
				}
				if( $('.trCon2 .tr').length < 1 ){
					uselayer(3,'当前没有要导入的题目!');
					return false;
				}
				for ( var i = 0; i < $('.trCon2 .checkbox[selected=selected]').length; i++){
					var tr = $('.trCon2 .checkbox[selected=selected]').eq(i).parents('.trCon2 .tr');
					var qid = tr.attr('qid');

					for( var j = 0; j < presentProblem.length; j++ ){
						if( qid == presentProblem[j].qid ){
							presentProblem.splice(j,1);
						}
					}
				}
				showAllProblem();//显示当堂课的题目列表
				showPresentProblem();//显示当堂课的题目列表
			});
		}

		function update(){//提交删除或增加后的本堂课的题目
			//presentProblem  presentProblemOrigin
			$('.saveBtn').click(function() {
				var delqids = [];//记录被删除的题目数组
				var addqids = [];//记录被添加的题目数组
				//把修改过后的题目数组和修改之前的题目数组进行比对，找出新增的和删除的题目
				for ( var i = 0; i < presentProblemOrigin.length; i++ ){
					var ishave = 0;
					for ( var j = 0; j < presentProblem.length; j++ ){
						if ( presentProblemOrigin[i].qid == presentProblem[j].qid ){
							ishave = 1;
						}
					}
					if ( ishave == 0 ){
						delqids.push({qid:presentProblemOrigin[i].qid});
					}
					
				}
				for ( var i = 0; i < presentProblem.length; i++ ){
					var ishave = 0;
					for ( var j = 0; j < presentProblemOrigin.length; j++ ){
						if ( presentProblem[i].qid == presentProblemOrigin[j].qid ){
							ishave = 1;
						}
					}
					if ( ishave == 0 ){
						addqids.push({qid:presentProblem[i].qid});
					}
					
				}

				var json = {
					'1':{
						command:'question/choosequestions', //接口地址
						scheduleid:getCookie('scheduleid'),
						sessionid:getCookie('sid'),
						delqids:delqids,
						addqids:addqids,
						loginid:getCookie('loginid')
					}
				};
				Api.dataToJava({
					json:{
						url:'/course/choosequestions', //一次性走几个接口
						data:JSON.stringify(json)
					},
					fn:function (base) {
						base = base[1]; //取接口的第一个返回值
						console.log(base);
						
						//判断接口是否走成功， errcode为0是成功
						if (base.errcode!=0) {
							uselayer(3,'保存失败!<br/>'+base.errdesc);
							return false;
						}
						uselayer(3,'保存成功!',function(){
							parent.location.reload();
						});
						
					}
				});

			});
			
		}


        $('.trCon').html('');//清空所有的题目
    	addlearnType();//获取所有的训练项并生成下拉框
		addProblem();//点击导入题目的按钮
		deleteProblem();//点击删除题目的按钮
		update();//提交删除或增加后的本堂课的题目
	</script>

</html>
