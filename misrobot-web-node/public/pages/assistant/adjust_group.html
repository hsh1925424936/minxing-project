<!DOCTYPE html>
<html>
	<head>
		<script type="text/javascript" src="../../js/assistant/layout.js" ></script>
		<meta charset="UTF-8">
		<title>批量调整组员</title>
		<style type="text/css">
			body{
				padding-bottom:0;
			}
			.mainOuter{
				width:690px; height:500px; padding-left:30px; padding-right:30px;
			}
			.topCon{
				width:100%; height:60px;
				color:rgb(51,51,51);
			}
			.topCon h2{
				height:100%; float:left; line-height:60px; font-size:19px;
			}
			.topCon span{
				width:22px; height:22px; float:right; display:block; position:relative;
				top:50%; margin-top:-11px; cursor:pointer;
				background-image:url('../../images/assistant/guanbi-tanchuang.png');
				background-size:100% 100%;
				background-repeat:no-repeat;
			}
			.topCon img{
				width:100%; height:100%; display:none;
			}
			.topCon span:hover img{
				display:block;
			}

			.toptit{
				width:100%; height:34px; line-height:34px;
			}
			.toptit>h3,.toptit>h4{
				height:100%; float:left; font-size:14px; color:rgb(51,51,51);
			}
			.toptit h3{
				width:290px; margin-right:104px;
			}
			.toptit h4{
				width:236px;
			}

			.formCon{
				margin-top:10px; width:100%; height:34px; margin-bottom:10px; font-size:14px;
			}
			.searchCon{
				width:290px; height:34px; float:left;
				border:1px solid #CCCCCC; border-radius:3px;
			}
			.searchCon input{
				float:left; display:block; border-right:1px solid #CCCCCC; width:73%;
				height:100%; line-height:33px; padding-left:10px; padding-right:10px;
			}
			.searchCon button{
				float:left; display:block; width:27%; height:100%; text-align:center;
				line-height:33px; background-color:#EDEDED;
			}
			
			.myselect{
				float:right; top:50%; margin-top:-18px;
				width:236px; height:34px; text-align:center; line-height:32px;
				border:1px solid #c3c3c3; box-sizing:border-box; border-radius:3px;
				cursor:pointer; background-color:white;
				position:relative; font-size:16px;
			}
			.myselect:hover{
				border:1px solid #999999; background-color:#f5f5f5;
			}
			.myselect_search{/*被搜索的学生*/
				background-color:#BBBBBB;
			}
			.myselect>p{
				width:92%; height:100%; float:left; margin-right:-20px;
			}
			.myselect select{
				position:absolute; width:100%; border-radius:3px;
				top:36px; z-index:1; border:1px solid #0496C9; font-size:16px;
				display:none; text-align:center;
			}
			.myselect select option{
				padding-top:3px; padding-bottom:3px;
			}
			.myselect select option:hover{
				background-color:#dcdcdc;
			}

			.stuOuter{
				width:100%; height:270px; 
			}
			.table1{
				width:290px; height:100%; font-size:14px; border:1px solid #cccccc;
				float:left;
			}
			.th{
				width:100%; height:38px; background-color:#EEEEEE; border-bottom:1px solid #cccccc;
			}
			.trCon{
				height:220px; overflow-y:auto; 
			}
			.tr{
				width:100%; height:30px; border-bottom:1px solid #cccccc;
			}
			.tr:hover{
				background-color:#F5F5F5;
			}
			.td{
				height:16px; line-height:16px; text-align:center; float:left;
				position:relative; top:50%; margin-top:-8px;
			}

			.td:nth-child(1){
				width:18%;
			}
			.td:nth-child(2){
				width:39%;
			}
			.td:nth-child(3){
				width:43%;
			}
			
			.td:nth-child(1) span{
				width:16px; height:16px; display:block; border:1px solid #cccccc;
				border-radius:2px; margin:auto; background-color:white; cursor:pointer;
			}
			.td:nth-child(1) img{
				width:100%; height:100%; display:none;
				-moz-user-select: none; 
				-webkit-user-select: none; 
				-ms-user-select: none; 
				-khtml-user-select: none; 
				user-select: none;
			}

			.th .td:nth-child(2){
				border-right:1px solid #B2B2B2;
			}

			.tr .td:nth-child(5) span{
				margin-right:15px;
			}

			.addordelete{
				float:left; width:80px; margin-top:76px;
				margin-left:11px; margin-right:11px;
			}
			.addordelete button{
				width:100%; height:38px; border-radius:3px; border:1px solid #999999;
				text-align:center; line-height:38px; font-size:14px;
				background-color:white; margin-bottom:10px;
			}
			.btnDisabled{
				opacity:0.6;
			}
			.stuOuter select{
				width:236px; height:100%; float:right;
			}
			.stuOuter select option{
				padding-left:10px; padding-top:3px; padding-bottom:3px;
			}
			.groupresult{
				border-radius:0;
			}

			.footerBtn{
				width:100%; height:38px; margin-top:35px; 
			}
			.footerBtn button{
				display:block; float:right; width:112px; height:38px; border-radius:3px;
				font-size:16px; text-align:center; line-height:38px; box-sizing:border-box;
			}
			.closeBtn{
				border:1px solid #c3c3c3; background-color:#ffffff;
			}
			.closeBtn:hover{
				background-color:#f2f2f2; border:1px solid #999999;
			}
			.saveBtn{
				background-color:#0496ca; margin-right:20px; color:white;
			}
			.saveBtn:hover{
				background-color:#0487b5;
			}
		</style>	
		
		
	</head>
	<body>
		<div class="mainOuter">
			<div class="topCon">
				<h2>批量调整组员</h2>
				<span class="closeSpan">
					<img src="../../images/assistant/guanbi-tanchuang-h.png">
				</span>
				
			</div>
		
			<div class="toptit">
				<h3>已签到未分组学员:</h3>
				<h4>已分组学员:</h3>
			</div>

			<div class="formCon">
				<div class="searchCon">
					<input type="text" placeholder="输入学生名称进行查找" />
					<button>查找</button>
				</div>
				<div class="myselect">
					<p>第1组</p><img src="../../images/assistant/sanjiao-xian.png">
					<select size='6'>
						<option>第1组</option>
						<option>第2组</option>
						<option>第3组</option>
						<option>第4组</option>
						<option>第5组</option>
						<option>第6组</option>
						<option>第7组</option>
					</select>
				</div>
			</div>

			<div class="stuOuter">
				
				<div class="mytable table1">
					<div class="th">
						<div class="td">
							<span class="checkboxall">
								<img src="../../images/assistant/gouxuan-h.png">
							</span>
						</div>
						<div class="td">
							姓名
						</div>
						<div class="td">
							学号
						</div>
					</div>

					<div class="trCon">
						<div class="tr">
							<div class="td">
								<span class="checkbox">
									<img src="../../images/assistant/gouxuan-h.png">
								</span>
							</div>
							<div class="td name">
								刘钧
							</div>
							<div class="td">
								2014343434
							</div>
						</div>
						<div class="tr">
							<div class="td">
								<span class="checkbox">
									<img src="../../images/assistant/gouxuan-h.png">
								</span>
							</div>
							<div class="td name">
								章一星
							</div>
							<div class="td">
								2014343434
							</div>
						</div>
						<div class="tr">
							<div class="td">
								<span class="checkbox">
									<img src="../../images/assistant/gouxuan-h.png">
								</span>
							</div>
							<div class="td name">
								孙杰
							</div>
							<div class="td">
								2014343434
							</div>
						</div>
						<div class="tr">
							<div class="td">
								<span class="checkbox">
									<img src="../../images/assistant/gouxuan-h.png">
								</span>
							</div>
							<div class="td name">
								范典
							</div>
							<div class="td">
								2014343434
							</div>
						</div>
						<div class="tr">
							<div class="td">
								<span class="checkbox">
									<img src="../../images/assistant/gouxuan-h.png">
								</span>
							</div>
							<div class="td name">
								朱丹
							</div>
							<div class="td">
								2014343434
							</div>
						</div>
						<div class="tr">
							<div class="td">
								<span class="checkbox">
									<img src="../../images/assistant/gouxuan-h.png">
								</span>
							</div>
							<div class="td name">
								李明姚
							</div>
							<div class="td">
								2014343434
							</div>
						</div>
						<div class="tr">
							<div class="td">
								<span class="checkbox">
									<img src="../../images/assistant/gouxuan-h.png">
								</span>
							</div>
							<div class="td name">
								殷雄
							</div>
							<div class="td">
								2014343434
							</div>
						</div>
						<div class="tr">
							<div class="td">
								<span class="checkbox">
									<img src="../../images/assistant/gouxuan-h.png">
								</span>
							</div>
							<div class="td name">
								蔡依林
							</div>
							<div class="td">
								2014343434
							</div>
						</div>
						<div class="tr">
							<div class="td">
								<span class="checkbox">
									<img src="../../images/assistant/gouxuan-h.png">
								</span>
							</div>
							<div class="td name">
								周杰伦
							</div>
							<div class="td">
								2014343434
							</div>
						</div>
						<div class="tr">
							<div class="td">
								<span class="checkbox">
									<img src="../../images/assistant/gouxuan-h.png">
								</span>
							</div>
							<div class="td name">
								金莎
							</div>
							<div class="td">
								2014343434
							</div>
						</div>
						<div class="tr">
							<div class="td">
								<span class="checkbox">
									<img src="../../images/assistant/gouxuan-h.png">
								</span>
							</div>
							<div class="td name">
								汪苏泷
							</div>
							<div class="td">
								2014343434
							</div>
						</div>
						<div class="tr">
							<div class="td">
								<span class="checkbox">
									<img src="../../images/assistant/gouxuan-h.png">
								</span>
							</div>
							<div class="td name">
								梁静茹
							</div>
							<div class="td">
								2014343434
							</div>
						</div>
						<div class="tr">
							<div class="td">
								<span class="checkbox">
									<img src="../../images/assistant/gouxuan-h.png">
								</span>
							</div>
							<div class="td name">
								陈粒
							</div>
							<div class="td">
								2014343434
							</div>
						</div>
						<div class="tr">
							<div class="td">
								<span class="checkbox">
									<img src="../../images/assistant/gouxuan-h.png">
								</span>
							</div>
							<div class="td name">
								张杰
							</div>
							<div class="td">
								2014343434
							</div>
						</div>
						<div class="tr">
							<div class="td">
								<span class="checkbox">
									<img src="../../images/assistant/gouxuan-h.png">
								</span>
							</div>
							<div class="td name">
								吴青峰
							</div>
							<div class="td">
								2014343434
							</div>
						</div>
					</div>

				</div>

				<div class="addordelete">
					<button class="addBtn btnDisabled" disabled>增加>></button>
					<button class="delBtn btnDisabled" disabled><<删除</button>
				</div>

				<select class="form-control groupresult" multiple>
					<option>刘钧</option>
					<option>刘钧</option>
					<option>刘钧</option>
					<option>刘钧</option>
					<option>刘钧</option>
					<option>刘钧</option>
				</select>

			</div>

			<div class="footerBtn">
				<button class="closeBtn">关闭</button>
				<button class="saveBtn">保存</button>
			</div>

		</div>

	</body>
	
	<script type="text/javascript">
		var groupresult;//已经分组的学生数组
		var signedlist = [];//未分组的学生数组
		var signedlistOrigin = [];//未分组的学生数组备份(不做改变)
		var sgid;//分组id
		var scheduleid;//课程表id

		function get_scheduleid(){//查询课程表id
			scheduleid = getCookie('scheduleid');//课程表id
			showStu();//显示学生列表
		}

		//自定义的select
		$('.myselect').click(function(event) {
			if( $(this).find('select').css('display') == 'none' ){
				$(this).find('select').css('display', 'block');
			}else{
				$(this).find('select').css('display', 'none');
			}
			 event.stopPropagation();
		});
		$(document).click(function() {
			$('.myselect select').css('display', 'none');
		});
		$('.myselect select').change(function() {
			var text = $(this).find('option:selected').html();
			$(this).siblings('p').html(text);
		});

		function mycheckbox(){//自定义子复选框项注册事件
			$('.checkbox').click(function() {
				if( $(this).attr('selected') == 'selected' ){//取消选择
					$(this).removeAttr('selected');
					$(this).find('img').css('display', 'none');
					$(this).parents('.tr').removeAttr('style');//取消这一行的颜色
				}else{
					$(this).attr('selected', 'selected');
					$(this).find('img').css('display', 'block');
					$(this).parents('.tr').css('background-color', '#F5F5F5');//加上这一行的颜色
				}

				var hasNot = 0;//如果有未选择的复选框，变量为1
				$(this).parents('.trCon').find('.checkbox').each(function() {
					if( $(this).attr('selected') == 'selected' ){
					}else{
						hasNot = 1;
					}
				});
				var checkboxall = $(this).parents('.mytable').find('.checkboxall');
				if(hasNot == 1 && checkboxall.attr('selected') == 'selected'){
					checkboxall.removeAttr('selected');//取消全选复选框
					checkboxall.find('img').css('display', 'none');
				}else if(hasNot == 0 && !checkboxall.attr('selected')){
					checkboxall.attr('selected', 'selected');//选中全选复选框
					checkboxall.find('img').css('display', 'block');
				}

			});
		}

		function mycheckboxall(){//自定义父复选框项注册事件
			$('.checkboxall').click(function() {
				if( $(this).attr('selected') == 'selected' ){//取消选择全选复选框
					$(this).removeAttr('selected');
					$(this).find('img').css('display', 'none');
					$(this).parents('.mytable').find('.checkbox[selected=selected]').click();//把子复选框也取消选择
				}else{
					$(this).attr('selected', 'selected');//选中全选复选框
					$(this).find('img').css('display', 'block');
					$(this).parents('.mytable').find('.checkbox').each(function() {//把子复选框也选中
						if( $(this).attr('selected') == 'selected' ){
						}else{
							$(this).click();
						}
					});

				}
			});
		}

		

		//当左边的框点击时删除按钮变灰，当右边的框点击时增加按钮变灰
		$('.table1').click(function() {
			if( $(this).find('.checkbox[selected=selected]').length < 1 ){
				$('.addBtn').attr('disabled', 'disabled');
				$('.addBtn').addClass('btnDisabled');
			}else{
				$('.addBtn').removeAttr('disabled');
				$('.addBtn').removeClass('btnDisabled');
			}
		});
		$('.stuOuter select').click(function() {
			if( $(this).children().length < 1 || $(this).find('option:selected').length == 0 ){
				$('.delBtn').attr('disabled', 'disabled');
				$('.delBtn').addClass('btnDisabled');
			}else{
				$('.delBtn').removeAttr('disabled');
				$('.delBtn').removeClass('btnDisabled');
			}
		});

		function searchStu(){//输入学生名称进行查找
			$('.searchCon button').click(function() {
				var value = $('.searchCon input').val().trim();
				var isfind = 0; //标记是否找到对应的学生
				for ( var i = 0; i < $('.tr').length; i++ ){
					if( value == $('.tr').eq(i).find('.name').html().trim() ){
						$('.tr').removeClass('myselect_search');
						var tr = $('.tr').eq(i);
						$('.trCon').scrollTop(0);
                 		var scroll_top = tr.offset().top - tr.parent().offset().top;//滚动条需要移动的距离
                 		$('.trCon').scrollTop(scroll_top);//滚动条滚动
						tr.addClass('myselect_search');
						setTimeout(function(){
							$('.tr').removeClass('myselect_search');
						},5000);
						isfind = 1;
						break;
					}
				}
				if ( isfind == 0 ){
					uselayer(3,'未搜索到该学生!');
				}
			});
		}
		

		function showStu(){//显示学生列表
			var json = {
				'1':{
					command:'group/querygroupinfo', //接口地址
					scheduleid:scheduleid,
					sessionid:getCookie('sessionid'),
					loginid:getCookie('loginid')
				}
			};

			Api.dataToJava({
				json:{
					url:'/group/querygroupinfo', //一次性走几个接口
					data:JSON.stringify(json)
				},
				fn:function (base) {
					base = base[1]; //取接口的第一个返回值
					console.log(base);
					
					//判断接口是否走成功， errcode为0是成功
					if (base.errcode!=0) {
						uselayer(3,base.errdesc);
						return false;
					}

					groupresult = base.groupresult;//已分组列表
					signedlistOrigin = base.signedlist.slice(0);//未分组列表备份
					signedlist = base.signedlist.slice(0);//未分组列表
					sgid = base.sgid//分组id
					
					show_signedlist();//展示没有分组的人员列表

					str = '';
					for ( var i = 0; i < base.groups; i++ ){
						str += 
						'<option value="'+(i+1)+'">第'+(i+1)+'组</option>';
					}
					$('.myselect select').html(str);
					show_single_group();//通过下拉框查看不同组的成员
					$('.myselect select').val('1'); $('.myselect select').change();//第一次默认选中第一组
				}
			});
		}

		function show_signedlist(){//展示没有分组的人员列表
			//生成左边的表格
			var str = '';
			for ( var i = 0; i < signedlist.length; i++ ){
				str+= 
				'<div class="tr" stdid="'+signedlist[i].stdid+'">'+
					'<div class="td">'+
						'<span class="checkbox">'+
							'<img src="../../images/assistant/gouxuan-h.png">'+
						'</span>'+
					'</div>'+
					'<div class="td name">'+
						signedlist[i].name+
					'</div>'+
					'<div class="td code">'+
						signedlist[i].code+
					'</div>'+
				'</div>';
			}
			$('.trCon').html(str);
			mycheckbox();

			//把增加按钮变灰
			$('.addBtn').attr('disabled', 'disabled');
			$('.addBtn').addClass('btnDisabled');
		}

		function show_single_group(){//通过下拉框查看单个组的成员
			$('.myselect select').change(function() {
				var value = $(this).val();
				var str = '';
				for( var i = 0; i < groupresult.length; i++ ){
					if(value == groupresult[i].sgindex && groupresult[i].role != 1 && groupresult[i].role != 2){
						str += '<option stdid="'+groupresult[i].stdid+'" code="'+groupresult[i].code+'">'+groupresult[i].name+'</option>';
					}
				}
				$('.groupresult').html(str);
				//把删除按钮变灰
				$('.delBtn').attr('disabled', 'disabled');
				$('.delBtn').addClass('btnDisabled');
			});
		}

		function addMember(){//增加组成员
			$('.addBtn').click(function() {
				if( $('.checkbox[selected=selected]').length < 1 && $('.tr').length > 0 ){
					uselayer(3,'请选择要分组的学生');
					return false;
				}
				if( $('.tr').length < 1 ){
					uselayer(3,'当前没有未分组的学生!');
					return false;
				}
				for ( var i = 0; i < $('.checkbox[selected=selected]').length; i++){
					var tr = $('.checkbox[selected=selected]').eq(i).parents('.tr');
					var stdid = tr.attr('stdid');
					var name = tr.find('.name').html();
					var code = tr.find('.code').html();
					var sgindex = $('.myselect select').val();
					groupresult.push({stdid:stdid,name:name,code:code,sgindex:sgindex,role:0});//增加
					//减少
					for( var j = 0; j < signedlist.length; j++ ){
						if( signedlist[j].stdid == stdid ){
							signedlist.splice(j,1);
						}
					}
				}
				if( $('.checkboxall').attr('selected') ){//把之前点的全选按钮还原
					$('.checkboxall').click();
				}
				show_signedlist();//重新刷新未分组人员
				$('.myselect select').change();//重新刷新当前小组人员
			});
		}

		function deleteMember(){//删除组成员
			$('.delBtn').click(function() {
				var value = $('.groupresult').val();
				if( value == null && $('.groupresult option').length > 0 ){
					uselayer(3,'请选择要删除的学生!');
					return false;
				}
				if( $('.groupresult option').length < 1 ){
					uselayer(3,'没有可以删除的学生!');
					return false;
				}

				var option = $('.groupresult option:selected');
				var stdid = option.attr('stdid');
				var name = option.html();
				var code = option.attr('code');
				signedlist.push({stdid:stdid,name:name,code:code});
				for( var i = 0; i < groupresult.length; i++ ){
					if( groupresult[i].stdid == stdid ){
						groupresult.splice(i,1);
					}
				}

				show_signedlist();//重新刷新未分组人员
				$('.myselect select').change();//重新刷新当前小组人员
			});
		}

		function send_adjust_group(){//发送调整后的数组
			for ( var i = 0; i < groupresult.length; i++ ){
				groupresult[i].sgid = sgid;
			}
			for ( var i = 0; i < signedlist.length; i++ ){
				signedlist[i].sgid = sgid;
				signedlist[i].role = null;
			}
			var groupresultadd = [];//存放之前没有分组现在加入组里的学生
			for( var i = 0; i < signedlistOrigin.length; i++ ){
				for( j = 0; j < groupresult.length; j++ ){
					if( signedlistOrigin[i].stdid == groupresult[j].stdid ){
						groupresultadd.push(groupresult[j]);
					}
				}
			}
			var json = {
				'1':{
					command:'group/changegroup', //接口地址
					sessionid:getCookie('sessionid'),
					loginid:getCookie('loginid'),
					groupresult:groupresult,
					signedlist:groupresultadd
				}
			};
			console.log(json);
			Api.dataToJava({
				json:{
					url:'/group/changegroup', //一次性走几个接口
					data:JSON.stringify(json)
				},
				fn:function (base) {
					base = base[1]; //取接口的第一个返回值
					console.log(base);
					
					//判断接口是否走成功， errcode为0是成功
					if (base.errcode!=0) {
						uselayer(3,base.errdesc);
						return false;
					}
					//调整成功后用父页面的方法刷新父页面列表，并关闭弹窗
					uselayer(3,'调整分组成功!',function(){
						parent.show_group();//用父页面的方法刷新父页面列表
						parent.close_iframe();//关闭弹窗
					});
				}
			});
		}

		$(function() {
			$('.trCon').html(''); $('.myselect select').html(''); $('.groupresult').html('');

			c_interface.getLoginInfo({
			    fn:function(loginInfo){
			    	mycheckboxall();//自定义父复选框项注册事件
					searchStu();//输入学生名称进行查找搜索按钮的事件注册
					addMember();//增加组成员按钮的事件注册
					deleteMember();//删除组成员按钮的事件注册
					get_scheduleid();//查询课程表id
					$('.saveBtn').click(function() {
						layer.confirm(
							'分组后各组的小红花会重新计算，确定要重新分组吗？',
							{btn: ['确定','取消']},
							function(){
								send_adjust_group();//发送调整后的数组
							}
						)
						
					});
			    	console.log(loginInfo);
				}
			});
		});
	</script>

</html>
