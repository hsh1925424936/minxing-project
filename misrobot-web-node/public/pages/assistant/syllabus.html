<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
    <title>课程表</title>
    <script src="../../js/vue.js"></script>
    <script type="text/javascript" src="../../js/assistant/layout.js" ></script>
    <link rel="stylesheet" href="../../css/reset.css">
    <style>
        * {
            padding:0;
            margin:0;
        }
        body {
            overflow: auto;
        }
        .flex {
            display: flex;
            justify-content: center;
        }
        .flex-vertiacl {
            align-items: center;
        }
        .flex-item {
            flex:1 1 auto;
        }
        header {
            font-size: 18px;
            text-align: center;
            height:90px;
            background: #fff;
            color: #00A0EA;
            position: fixed;
            width:100%;
            z-index: 20;
        }
        header a {
            float: right;
            margin-right: 60px;
            display: inline-block;
            width:100px;
            height:38px;
            line-height: 38px;
            color: #fff;
            cursor: pointer;
            border:2px solid #00A0EA;
            border-radius: 5px;
            background: #00A0EA;
        }
        .totaltitle i {
            display: inline-block;
            width:18px;
            height:18px;
            vertical-align: sub;
            cursor: pointer;
        }
        .totaltitle i:first-child {
            background: url("../../images/assistant/icon-left.png") 0 0 no-repeat;
            background-size: contain;
        }
        .totaltitle i:last-child {
            background: url("../../images/assistant/icon-right.png") 0 0 no-repeat;
            background-size: contain;
        }
        .bar {
            line-height: 38px;
        }
        .bar>span {
            margin-left:60px;
        }
        .bar span {
            margin-right: 20px;
        }
        .bar ul {
            display: inline-flex;
            cursor: pointer;
            border:2px solid #00A0EA;
            border-radius: 5px;
        }
        .bar ul li {
            width:100px;
            height:38px;
        }
        .bar ul li:first-child {
            border-right:2px solid #00A0EA;
        }
        .active {
            background: #00A0EA;
            color: #fff;
        }
        section {
            min-height: 100vh;
            padding-top: 90px;
            background: #eaf1f8;
            width:100%;
            text-align: left;
        }
        .box {
            border-left:2px solid #e0e4e8;
            flex-direction:column;
            cursor: pointer;
        }
        .circle{
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #fff;
            border: 5px solid #00A0EA;
            margin-left: -10px;
        }
        .box span.time {
            color: #333;
            font-size: 20px;
            padding:0 20px;
        }
        .content {
            margin:40px 0;
            padding:50px 20px;
            position: relative;
            z-index: 1;
            overflow: hidden;
        }
        .shade {
            width:100%;
            position: absolute;
            top:0;
            bottom:0;
            right:-500px;
            background: rgba(0,0,0,0.4);
            z-index: 2;
            -webkit-transition:right .4s ease-in;
            -moz-transition:right .4s ease-in;
            transition:right .4s ease-in;
        }
        .shade a {
            display: inline-block;
            padding: 10px;
            width: 95px;
            text-align: center;
            border-radius: 5px;
            color: #fff;
            z-index: 3;
        }
        .content:hover>.shade {
            right:0;
        }
        .look {
            background: #6AD969;
        }
        .attend {
            background: #00A0EA;
        }
        .wait {
            color: #fff;
            background: #00A0EA;
            box-shadow: 5px 5px 5px #ABC1D0;
        }
        .off {
            color: #717171;
            background: #e5e9ed;
        }
        .today>.off:after {
            position: absolute;
            top:0;
            right:0;
            display: inline-block;
            content: '';
            width:86px;
            height:86px;
            background: url("../../images/assistant/icon-off.png") 0 0 no-repeat;
            background-size: contain;
        }
        .content ul {
            width:380px;
        }
        .content ul li {
            font-size: 18px;
            line-height: 25px;
        }
        .content ul li:first-child {
            font-size: 24px;
            padding-bottom: 10px;
        }
        .toweeks {
            background: #EAF1F8;
        }
        .week {
            width:1355px;
            margin:0 auto;
            padding-top: 90px;
            position: relative;
        }
        .week ul{
            width:1355px;
            height:78px;
            position: fixed;
            background: #EAF1F8;
            z-index:20;
            color: #333;
        }
        .week ul li {
            width:12.5%;
            height: 78px;
            color: #717171;
            text-align: center;
        }
        .week li span {
            line-height:25px;
        }
        .week table {
            width:1355px;
            margin-top:78px;
        }
        .week table tr td:first-child span{
            display: block;
            width: 100%;
            height: 42px;
            line-height: 42px;
            background: #fff;
            color: #333;
        }
        .week table td {
            background: #fff;
            width: 157px;
            height: 84px;
            border-right: 2px solid #EAF1F8;
            border-bottom: 2px solid #EAF1F8;
            font-size: 18px;
            text-align: center;
            display: table-cell;
            vertical-align: middle;
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }
        .week table td:hover>.shade {
            right:0;
        }
        .layui-layer-close { display: inline-block!important;}
        .none {
            flex-direction: column;
            min-height:100vh;
            background: #eaf1f8;
        }
        .none p {
            font-size: 20px;
            font-weight: bold;
            padding:20px;
        }
        .now:after {
            display: inline-block;
            vertical-align:sub;
            width:20px;
            height:20px;
            margin-left:10px;
            content: '';
            background: url("../../images/assistant/icon_jin.png") no-repeat;
            background-size: cover;
        }
        .inline {
            width:33.33%;
        }
        .lt {
            float: left;
        }
        .weekwait {
            color: #fff!important;
            background: #00A0EA!important;
        }
        .weekoff {
            color: #717171!important;
            background: #ccc!important;
        }
        .checkClass {
            position: fixed;
            width: 400px;
            z-index: 100;
            text-align: center;
            margin: auto;
            left: 0;
            right: 0;
            top: 50%;
            margin-top: -100px;
        }
        .checkClass>p {
            background: #ccc ;
            height:40px;
            line-height: 40px;
            color: #fff;
        }
        .checkClass .section {
            padding:15px;
            background: #fff;
        }
        .checkClass .section>p:first-child{
            margin-bottom:25px;
        }
        .checkClass .section>span {
            display: inline-block;
            margin-bottom:25px;
            line-height: 30px;
        }
        .checkClass .section a {
             display: inline-block;
             padding: 10px 20px;
             background: #ccc;
            cursor: pointer;
         }
        .shade-view {
            width: 100%;
            position: absolute;
            top: 0;
            bottom: 0;
            background: rgba(0,0,0,0.4);
            z-index: 99;
        }
    </style>
</head>
<body>
    <div id="course">
        <header class="flex flex-vertiacl">
            <div class="bar flex-item inline">
                <span class="lt">课程表</span>
                <ul class="lt">
                    <li :class="{active:today}" @click="resetday">今日</li>
                    <li :class="{active:toweek}" @click="resetweek">周</li>
                </ul>
            </div>
            <div class="totaltitle flex-item inline">
                <i v-if="toweek" @click="prev"></i>
                <span>
                    <template v-if="today">{{nowtime | str(0,4)}}年{{nowtime | str(6,7)}}月{{nowtime | str(8,10)}}日</template>
                    <template v-else>{{nowyear}}年{{nowmonth}}月第{{nowweek}}周</template>
                </span>
                <i v-if="toweek" @click="next"></i>
            </div>
            <div class="flex-item inline">
                <a @click="newcourse">+新建课程</a>
            </div>
        </header>
        <!--TODO Day-->
        <section class="flex" v-show="today && this.courselist.length!==0">
            <div class="box flex">
                <div class="today flex flex-vertiacl" v-for="item in courselist">
                    <i class="circle"></i>
                    <span class="time">{{item.starttime | str(11,16)}}-{{item.endtime | str(11,16)}}</span>
                    <div class="content" :class="{wait:item.classstatus==0 || item.classstatus==2 ,off: item.classstatus==1}">
                        <div class="shade flex flex-vertiacl">
                            <a class="look" v-if="item.classstatus==1">查看统计</a>
                            <a class="attend" v-else @click="startclass(item.starttime,item.scheduleid)">上课</a>
                        </div>
                        <ul>
                            <li>{{item.coursename}}</li>
                            <li><span>时间：</span><i v-for="value in item.courseorder">第{{value}}节&nbsp;&nbsp;</i></li>
                            <li><span>教室：</span><i>{{item.placename}}</i></li>
                            <li><span>班级：</span><i v-for="val in item.classlist">{{val.name}}&nbsp;&nbsp;</i></li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>
        <div class="flex flex-vertiacl none" v-show="this.courselist.length==0 && today || toweek && !weeks">
            <img src="../../images/assistant/none.png">
            <p><template v-if="today">今日无课程。</template><template v-else>当前周无课程。</template></p>
        </div>
        <!--TODO week-->
        <div class="toweeks" v-show="toweek && this.weeks">
            <div class="week">
                <ul class="flex datelist">
                    <li></li>
                    <li class="flex flex-vertiacl" v-for="item in weekdays" :class="{now:nowtime == item}">
                    <span>
                        {{item | str(0,10) | week}}<br>{{item | str(5,10)}}
                    </span>
                    </li>
                </ul>
                <table>
                    <tr v-for="(schedule,index) in schedulelist">
                        <td>
                            <span>第{{index+1}}节</span>
                            <span>{{schedule.starttime | str(0,5)}}-{{schedule.endime | str(0,5)}}</span>
                        </td>
                        <td v-for="value in schedule.applylist" :class="{weekwait:value.classstatus==0 || value.classstatus==2 ,weekoff: value.classstatus==1}">
                            <div class="shade flex flex-vertiacl" v-if="value.coursename">
                                <a class="look" v-if="value.classstatus==1">查看统计</a>
                                <a class="attend" v-else @click="startclass(value.starttime,value.scheduleid)">上课</a>
                            </div>
                            {{value.coursename}}
                        </td>
                    </tr>
                </table>
            </div>
        </div>
        <div class="shade-view" v-show="checkclass"></div>
        <div class="checkClass" v-show="checkclass">
            <p>提示</p>
            <div class="section">
                <p>欢迎回来</p>
                <span>您上次的课程《{{overdueclass.coursename}}》非正常退出，系统已保存数据。</span>
                <p><a @click="dismiss(overdueclass.scheduleid)">确定</a></p>
            </div>
        </div>
    </div>
    <script>
        window.onerror=function(a,b,c){alert(a+b+c)};
            vm = new Vue({
                el: '#course',
                data: {
                    checkclass:false,
                    overdueclass:'',
                    weeks:true,
                    scheduleid:'',
                    sid:'',
                    uid:'',
                    step: 0,
                    today: true,
                    toweek: false,
                    now: '',
                    nowtime: '',
                    nowyear: '',
                    nowmonth: '',
                    nowweek: '',
                    weekdays: ['2017-05-15', '2017-05-16', '2017-05-17', '2017-05-18', '2017-05-19', '2017-05-20', '2017-05-21'],
                    courselist: [],
                    schedulelist:[]
                },
                filters: {
                    str: function (value, start, end) {
                        if (value && typeof(value) === 'string') {
                            return value.slice(start, end)
                        }
                        return value
                    },
                    week: function (value) {
                        var year = value.split('-')[0];
                        var month = value.split('-')[1];
                        var day = value.split('-')[2];
                        if (month.toString()[0] == 0) {
                            month = month.toString().slice(1) - 1
                        } else {
                            month = month - 1
                        }
                        if (day.toString()[0] == 0) {
                            day = day.toString().slice(1)
                        }
                        var temp = new Date();
                        temp.setFullYear(year);
                        temp.setMonth(month);
                        temp.setDate(day);
                        switch (temp.getDay()) {
                            case 0:
                                value = "星期日";
                                break;
                            case 1:
                                value = "星期一";
                                break;
                            case 2:
                                value = "星期二";
                                break;
                            case 3:
                                value = "星期三";
                                break;
                            case 4:
                                value = "星期四";
                                break;
                            case 5:
                                value = "星期五";
                                break;
                            case 6:
                                value = "星期六";
                                break;
                        }
                        return value
                    }
                },
                mounted: function () {
                  var _this=this;
                  let fromurl = document.referrer;
                      fromurl.split('?');
                  if(fromurl.length == 2){
                        _this.sid = dataInfo.sessionid;
                        _this.uid = dataInfo.loginid;
                        _this.initday();
                        _this.initweek();
                        _this.checkClass();
                  }else{
                    c_interface.getLoginInfo({
                      fn:function(logininfo){
                        _this.sid=logininfo.sessionid;
                        _this.uid=logininfo.loginid;
                        _this.initday();
                        _this.initweek();
                        _this.checkClass();
                      }
                    });
                  }
                },
                methods: {
                    initday: function () {
                        var _this = this;
                        var _json = {
                            "1": {
                                command: "course/listteacherschedulebydate",
                                sessionid: _this.sid,
                                loginid: getCookie('uid'),
                                teacherid: getCookie('uid')
                            }
                        };
                        var json = JSON.stringify(_json);
                        $.ajax({
                            url: "/course/listteacherschedulebydate",
                            type: "POST",
                            data: json,
                            success: function (data) {
                                data = data["1"];
                                if (data.errcode == 0) {
                                    _this.nowtime = '';
                                    _this.nowtime = data.nowtime;
                                    if(_this.nowtime && typeof(_this.nowtime) === 'string'){
                                        _this.nowtime=_this.nowtime.slice(0, 10)
                                    }
                                    _this.courselist = '';
                                    _this.courselist = data.courselist;
                                } else if (data.errcode == 9904) {
                                    layer.msg("登录信息已失效，请重新登录");
                                } else {
                                    layer.msg(data.errdesc)
                                }
                            }
                        })
                    },
                    initweek: function (prama) {
                        var _this = this;
                        var _json = {
                            "1": {
                                command: "course/listteacherschedulebyweek",
                                sessionid:  _this.sid,
                                loginid: getCookie('uid'),
                                teacherid: getCookie('uid'),
                                step: _this.step,
                                scheduleid: prama
                            }
                        };
                        var json = JSON.stringify(_json);
                        $.ajax({
                            url: "/course/listteacherschedulebyweek",
                            type: "POST",
                            data: json,
                            success: function (data) {
                                data = data["1"];
                                if (data.errcode == 0) {
                                    _this.weeks=false;
                                    _this.nowyear = "";
                                    _this.nowyear = data.nowyear;
                                    _this.nowmonth = "";
                                    _this.nowmonth = data.nowmonth;
                                    _this.nowweek = "";
                                    _this.nowweek = data.nowweek;
                                    _this.weekdays = '';
                                    _this.weekdays = data.weekdays;
                                    _this.schedulelist = '';
                                    _this.schedulelist = data.schedulelist;
                                    $(_this.schedulelist).each(function(i,el){
                                        $(el.applylist).each(function(j,val){
                                            for ( var name in val ) {
                                                _this.weeks=true;
                                                return false
                                            }
                                            return true;
                                        });
                                    });
                                } else if (data.errcode == 9904) {
                                    layer.msg("登录信息已失效，请重新登录");
                                } else {
                                    layer.msg(data.errdesc)
                                }
                            }
                        })
                    },
                    prev: function () {
                        this.step--;
                        this.initweek()
                    },
                    next: function () {
                        this.step++;
                        this.initweek()
                    },
                    resetweek:function(){
                        this.step=0;
                        this.initweek();
                        this.toweek=true;
                        this.today=false;
                    },
                    resetday:function(){
                        this.initday();
                        this.toweek=false;
                        this.today=true;
                    },
                    newcourse: function () {
                        var _this = this ;
                        layer.open({
                            type: 2,
                            title: '新建课程',
                            shade: 0.1,
                            area: ['60%', '75%'],
                            content: './newCourse-v2_5.html?sid='+_this.sid+'&&uid='+_this.uid
                        })
                    },
                    startclass: function (prama,prama2) {
                        var _this = this;
                        _this.scheduleid='';
                        _this.scheduleid=prama2;
                        let fromurl = document.referrer;
                        fromurl.split('?');
                      if(fromurl.length == 2){

                        document.dispatchEvent(eventMsg3);
                        document.dispatchEvent(eventMsg2);

                        var _json = {
                          "1": {
                            command: "course/istimetohaveaclass",
                            sessionid:_this.sessionid,
                            loginid: getCookie('uid'),
                            scheduleid:_this.scheduleid
                          }
                        };
                        var json = JSON.stringify(_json);
                        $.ajax({
                          url: "/course/istimetohaveaclass",
                          type: "POST",
                          data: json,
                          success: function (data) {
                            data = data["1"];
                            if (data.errcode == 0) {
                              if (data.state==3){
                                layer.confirm('当前未到达上课时间，是否确定提前上课？', {
                                  title: '请确认是否提前上课',
                                  btn: ['确定', '取消'] //按钮
                                }, function () {
                                  start();
                                });
                              }else if(data.state==0 || data.state==1 || data.state==2){
                                start();
                              }
                            } else if (data.errcode == 9904) {
                              layer.msg("登录信息已失效，请重新登录");
                            } else {
                              layer.msg(data.errdesc)
                            }
                            sendInfo(data);
                          }
                        });
                        function start(){
                          var _json = {
                            "1": {
                              command: "course/teacherschedulebegin",
                              sessionid: _this.sessionid,
                              loginid: getCookie('uid'),
                              teacherid: getCookie('uid'),
                              scheduleid:_this.scheduleid
                            }
                          };
                          var json = JSON.stringify(_json);
                          $.ajax({
                            url: "/course/teacherschedulebegin",
                            type: "POST",
                            data: json,
                            success: function (data) {
                              data = data["1"];
                              if (data.errcode == 0) {
                                content.setStartClass();
                              } else if (data.errcode == 9904) {
                                layer.msg("登录信息已失效，请重新登录");
                              } else {
                                layer.msg(data.errdesc)
                              }
                            }
                          })
                        }

                      }else{
                        c_interface.sendInfo({
                          fn:function(content){
                            content.SendCommand(0,_this.scheduleid);
                            var _json = {
                              "1": {
                                command: "course/istimetohaveaclass",
                                sessionid: _this.sid,
                                loginid: getCookie('uid'),
                                scheduleid:_this.scheduleid
                              }
                            };
                            var json = JSON.stringify(_json);
                            $.ajax({
                              url: "/course/istimetohaveaclass",
                              type: "POST",
                              data: json,
                              success: function (data) {
                                data = data["1"];
                                if (data.errcode == 0) {
                                  if (data.state==3){
                                    layer.confirm('当前未到达上课时间，是否确定提前上课？', {
                                      title: '请确认是否提前上课',
                                      btn: ['确定', '取消'] //按钮
                                    }, function () {
                                      start();
                                    });
                                  }else if(data.state==0 || data.state==1 || data.state==2){
                                    start();
                                  }
                                } else if (data.errcode == 9904) {
                                  layer.msg("登录信息已失效，请重新登录");
                                } else {
                                  layer.msg(data.errdesc)
                                }
                              }
                            })

////                                    var now = '';
////                                    now = _this.nowtime.replace(new RegExp("-", "gm"), "/");
////                                    now = (new Date(_this.nowtime)).getTime();
////                                    var thistime = '';
////                                    thistime = prama.replace(new RegExp("-", "gm"), "/");
////                                    thistime = (new Date(prama)).getTime();
////                                    if (now < thistime - 600000) {
////                                        layer.confirm('当前未到达上课时间，是否确定提前上课？', {
////                                            btn: ['确定', '取消'] //按钮
////                                        }, function () {
////                                            start();
////                                        });
////                                    } else {
////                                        start();
////                                    }
                            function start(){
                              var _json = {
                                "1": {
                                  command: "course/teacherschedulebegin",
                                  sessionid: _this.sid,
                                  loginid: getCookie('uid'),
                                  teacherid: getCookie('uid'),
                                  scheduleid:_this.scheduleid
                                }
                              };
                              var json = JSON.stringify(_json);
                              $.ajax({
                                url: "/course/teacherschedulebegin",
                                type: "POST",
                                data: json,
                                success: function (data) {
                                  data = data["1"];
                                  if (data.errcode == 0) {
                                    content.setStartClass();
                                  } else if (data.errcode == 9904) {
                                    layer.msg("登录信息已失效，请重新登录");
                                  } else {
                                    layer.msg(data.errdesc)
                                  }
                                }
                              })
                            }
                          }
                        });
                      }
                    },
                    checkClass:function(){
                        var _this = this;
                        var _json = {
                            "1": {
                                command: "course/queryexceptioncourse",
                                sessionid: _this.sid,
                                loginid: getCookie('uid'),
                                teacherid: getCookie('uid')
                            }
                        };
                        var json = JSON.stringify(_json);
                        $.ajax({
                            url: "/course/queryexceptioncourse",
                            type: "POST",
                            data: json,
                            success: function (data) {
                                data = data["1"];
                                if (data.errcode == 0) {
                                    if (data.schedulelist.length>0) {
                                        _this.overdueclass=data.schedulelist[0];
                                        _this.checkclass=true;
                                    }
                                } else if (data.errcode == 9904) {
                                    layer.msg("登录信息已失效，请重新登录");
                                } else {
                                    layer.msg(data.errdesc)
                                }
                            }
                        })
                    },
                    dismiss(prama){
                        var _this = this;
                        var _json = {
                            "1": {
                                command: "course/teacherscheduleend",
                                sessionid: _this.sid,
                                loginid: getCookie('uid'),
                                teacherid: getCookie('uid'),
                                scheduleid: prama
                            }
                        };
                        var json = JSON.stringify(_json);
                        $.ajax({
                            url: "/course/teacherscheduleend",
                            type: "POST",
                            data: json,
                            success: function (data) {
                                data = data["1"];
                                if (data.errcode == 0) {
                                    _this.checkclass=false;
                                } else if (data.errcode == 9904) {
                                    layer.msg("登录信息已失效，请重新登录");
                                } else {
                                    layer.msg(data.errdesc)
                                }
                            }
                        })
                    }
                }
            });
    </script>
</body>
</html>
<script>
    $(window).scroll(function(event){
        var scorllleft = document.body.scrollLeft;
        console.log(scorllleft);
        if (scorllleft==0){
            $('.datelist').removeAttr("style");
        }else {
            $('.datelist').css("left","-"+scorllleft+'px');
        }
    });


    window.onload = function () {

       c_json =null;
       eventMsg = new MessageEvent('callMe', {'data':'{"command":"getLoginInfo"}'});
       eventMsg2 = new MessageEvent('callMe', {'data':'{"command":"setMainInfo"}'});
       eventMsg3 = new MessageEvent('callMe', {'data':c_json});

      document.dispatchEvent(eventMsg);
      console.log(eventMsg);
      function sendInfo(data){
        $.ajax({
          url: "/course/teacherschedulebegin",
          type: "POST",
          data: JSON.stringify({
            '1': {
              command: "course/teacherschedulebegin",
              sessionid: getCookie('sid'),
              loginid: getCookie('uid'),
              scheduleid:data.scheduleid
            }
          }),
          success: function (data) {
            c_json = {
              "command":"setCurrentCourseInfo",
              "currentCourseInfo":{
                "scheduleid":data.scheduleid,
                "courseid":data.courseid,
                "coursename":data.coursename,
                "starttime":data.starttime,
                "endtime":data.endtime,
                "roomnum":data.roomnum,
                "issigned":0,
                "teachers":[
                  {"uid":data.uid,"name":data.name,"role":3}
                ],
                "learnids":[
                  {"learnid":data.learnid,"name":data.name}
                ]
              }
            }
          }
        })
      }
    };
    var dataInfo = null;
    function setLoginInfo(data) {
      dataInfo = data;
    }
</script>
