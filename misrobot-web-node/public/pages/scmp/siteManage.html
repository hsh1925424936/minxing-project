<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>场地管理</title>
		<link rel="stylesheet" href="../../bootstrap-3.3.5-dist/css/bootstrap.min.css" />
		<link rel="stylesheet" href="../../assets/bootstrap/bootstrap-datepicker/css/bootstrap-datepicker.css" />
		<link rel="stylesheet" href="../../css/scmp/classManage.css" />
		<link rel="stylesheet" href="../../css/element.css">
		<link rel="stylesheet" href="../../css/scmp/elecommon.css">
		<style>
			[v-cloak] {display:none}
			.directToPage{padding-top: 0 !important;}
			.search-wrap .form-group{margin-right: 100px;}
			section .addBtn{margin-left: 20px;}
			.right{float: right;}
			.left{float: left;}
			
			section .table-responsive td button{display: inline-block;float: none;}
			
			.delete_sure{overflow: auto;z-index: 5;}
			.delete_sure .buildtop{margin-top: 70px;}
			.delete_sure .buildname{width: 30%;}
			.delete_sure .buildtext{width: 70%;}
			.delete_sure .buildleft{right: 200px;}
			.delete_sure .buildright{right: 80px;}
			.c_classMessage .col-sm-8 select{width: 100%;}
			.delete_sure .btn{position: relative;margin-right: 30px;left: 250px;margin-top: 50px;}
			
			.message-left{height: auto;text-align: left;}
			
			.site{width: 800px;height: 700px;}
			.site .setbrand{position: relative;margin-left: 20px;display: inline-block;cursor: pointer;border: 1px solid #ccc;padding: 5px;color: #fff;background-color: #337ab7;}
			.title{text-align: left;padding-left: 20px;margin-bottom: 20px;}
			.titlestyle1{margin-top: 200px;}
			.titlestyle2{margin-top: 250px;}
			.site .name{width: 16%;text-align: left;padding-left: 5%;float: none;vertical-align: top;}
			.site .content{width: 30%;margin-bottom: 20px;float: none;display: inline-block;}
			.site .content .contentinput{width: 100%;}
			.site .addsite{border: none;}
			.site .detail{width: 100%;}
			.asset{cursor: pointer;color: #337ab7;font-weight: bold;}
			.assettable{width: 90%;margin: 50px auto;}

		</style>
	</head>

	<body>

		<section id="testpaperManage" v-cloak>
			<p>场地管理</p>
			<!--*********************************按钮  搜索部分************************************-->
			<div class="center search-wrap">
				<form class="form-inline" style="float:none;">
					<div class="form-group">
						<label>楼栋	：</label>
						<select class="form-control" v-model="pageconf.name" @change="watchbuildname">
							<option value=""> 全部楼栋 </option>
							<option v-for="item in buildlist" :value="item.name">{{item.name}}</option>
						</select>
					</div>
					<!--<button type="button" class="btn btn-primary addBtn" @click="addNewBuild()">新建楼栋</button>-->
					<button type="button" class="btn btn-primary addBtn" @click="addNewSite()">新建房间</button>
				</form>
			</div>
			<!--************************************************表格 信息**************************************-->
			<div class="table-responsive">
				<table class="table table-bordered table-striped">
					<tr>
						<th>楼栋</th>
						<th>楼层</th>
						<th>房号</th>
						<th>房间名称</th>
						<th>管理者</th>
						<th>类别</th>
						<th>物品库存数量</th>
						<th>修改时间</th>
						<th>操作</th>
					</tr>
					<tr v-for="(item, index) in placelist">
						<td>{{item.build}}</td>
						<td>{{item.floor}}</td>
						<td>{{item.roomnum}}</td>
						<td>{{item.name}}</td>
						<td>{{item.adminname}}</td>
						<td>{{item.catename}}</td>
						<td class="asset" @click="queryassets(item.id)">{{item.assetstotal}}</td>
						<td>{{item.updatetime}}</td>
						<td>
							<button type="button" class="btn btn-primary btn-xs" @click="edit(item.id)">编辑</button>
							<button type="button" class="btn btn-primary btn-xs" @click="deletesite(item.id)">删除</button>
						</td>
					</tr>

				</table>
			</div>
			
			<!--************************************************新增**************************************-->
			<div class="delete_sure site" v-show="assetshow">
				<div class="c_studentTop">
					<p>物品库存</p>
					<p @click="remove">
						<span class="glyphicon glyphicon-remove"></span>
					</p>
				</div>
				<div class="c_classMessage">
					<table class="table table-bordered table-striped assettable">
						<tr>
							<th>序号</th>
							<th>资产编码</th>
							<th>资产名称</th>
							<th>物品类型</th>
							<th>责任人</th>
						</tr>
						<tr v-for="(item, index) in assetslist" style="overflow: auto;">
							<td>{{index+1}}</td>
							<td>{{item.code}}</td>
							<td>{{item.name}}</td>
							<td>{{item.catename}}</td>
							<td>{{item.resperson}}</td>
						</tr>
	
					</table>
				</div>
				<button class="btn btn-default buildright" style="left: 350px;" type="submit" @click="remove">关闭</button>
			</div>
			
			<div class="delete_sure" v-show="addbuildshow">
				<div class="c_studentTop">
					<p>新建楼栋</p>
					<p @click="remove">
						<span class="glyphicon glyphicon-remove"></span>
					</p>
				</div>
				<div class="c_classMessage">
					<div class="message-left">
						<form role="form">
							<div class="form-group buildtop">
								<label for="uname" class="col-sm-4 control-label buildname">楼栋名称:</label>
								<div class="col-sm-8 buildtext">
									<input type="text" class="form-control" v-model="buildname">
								</div>
							</div>
						</form>
					</div>
				</div>
				<button class="btn btn-primary buildleft" type="submit" @click="sureadd">确定</button>
				<button class="btn btn-default buildright" type="submit" @click="remove">取消</button>
			</div>
			
			<div class="delete_sure site" v-show="addsiteshow">
				<div class="c_studentTop">
					<p v-if="editaddstatu == 0">新建场地</p>
					<p v-else>编辑场地</p>
					<p @click="remove">
						<span class="glyphicon glyphicon-remove"></span>
					</p>
				</div>
				<div class="c_classMessage">
					<div class="message-left">
						<form role="form">
							<div class="form-group" style="">
								<h3 class="title">基本信息</h3>
								<label for="uname" class="col-sm-4 control-label name">楼栋:</label>
								<div class="col-sm-8 content">
									<select class="form-control" v-model="newbuildname">
										<option value=""> 请选择楼栋 </option>
										<option v-for="item in buildlist" :value="item.name">{{item.name}}</option>
									</select>
								</div>
								<label for="uname" class="col-sm-4 control-label name">楼层:</label>
								<div class="col-sm-8 content">
									<input onkeyup="if(this.value.length==1){this.value=this.value.replace(/[^1-9]/g,'')}else{this.value=this.value.replace(/\D/g,'')}" onafterpaste="if(this.value.length==1){this.value=this.value.replace(/[^1-9]/g,'')}else{this.value=this.value.replace(/\D/g,'')}" class="form-control contentinput" v-model="newfloor">
								</div>
								<label for="uname" class="col-sm-4 control-label name">房号:</label>
								<div class="col-sm-8 content">
									<input class="form-control contentinput" v-model="newroomnum">
								</div>
								<label for="uname" class="col-sm-4 control-label name">类别:</label>
								<div class="col-sm-8 content">
									<select class="form-control" v-model="newcateid">
										<option value=""> 请选择类别 </option>
										<option v-for="item in roomcatelist" :value="item.cateid">{{item.catename}}</option>
									</select>
								</div>
								<label for="uname" class="col-sm-4 control-label name">场地名称:</label>
								<div class="col-sm-8 content">
									<input type="text" class="form-control contentinput" v-model="newsitename">
								</div>
								<label for="uname" class="col-sm-4 control-label name">管理员:</label>
								<div class="col-sm-8 content">
									<input list="browsers" class="form-control" style="width: 100%;" v-model="teachername" @keyup="teacherinput">
									<datalist id="browsers">
									    <option v-for="item in teacherlist" :value="item.name">
									</datalist>
								</div>
								<span class="setbrand" @click="brandstatuBtn">设置电子门牌</span>
								<div class="detail" v-show="brandshow">
									<h3 class="title">场地功能描述</h3>
									<div class="detailbox" v-for="(item,index) in detaillist">
										<label for="uname" class="col-sm-4 control-label name">标题{{index+1}}:</label>
										<div class="col-sm-8 content" style="margin-right: 40%;">
											<input type="text" class="form-control contentinput" v-model="item.title">
										</div>
										<label for="uname" class="col-sm-4 control-label name">内容:</label>
										<div class="col-sm-8 content" style="width: 60%;">
											<textarea style="height: 120px;" type="text" class="form-control contentinput" v-model="item.content"></textarea>
										</div>
										<span class="detailBtn" v-if="index!=detaillist.length-1||index==3" @click="deleteDetailBtn(index)">-</span>
										<span class="detailBtn" v-if="index==detaillist.length-1&&detaillist.length<4" @click="addDetailBtn()">+</span>
									</div>
									
									<h3 class="title">场地图片</h3>
									<div class="col-sm-8 content" style="width: 100%;">
										<div class="imgbox">
											<el-upload
											  class="avatar-uploader"
											  action="/file/upload"
											  :show-file-list="false"
											  :on-success="upimg1"
											  :before-upload="beforeAvatarUpload">
											  <img v-if="img1url" :src="img1url" class="avatar">
											  <i v-else class="el-icon-plus avatar-uploader-icon"></i>
											</el-upload>
										</div>
										<div class="imgbox">
											<el-upload
											  class="avatar-uploader"
											  action="/file/upload"
											  :show-file-list="false"
											  :on-success="upimg2"
											  :before-upload="beforeAvatarUpload">
											  <img v-if="img2url" :src="img2url" class="avatar">
											  <i v-else class="el-icon-plus avatar-uploader-icon"></i>
											</el-upload>
										</div>
										<div class="imgbox">
											<el-upload
											  class="avatar-uploader"
											  action="/file/upload"
											  :show-file-list="false"
											  :on-success="upimg3"
											  :before-upload="beforeAvatarUpload">
											  <img v-if="img3url" :src="img3url" class="avatar">
											  <i v-else class="el-icon-plus avatar-uploader-icon"></i>
											</el-upload>
										</div>
									</div>
								</div>
							</div>
						</form>
					</div>
				</div>
				<button class="btn btn-primary" type="submit" @click="sureadd">保存</button>
				<button class="btn btn-default" type="submit" @click="remove">取消</button>
			</div>
			
			<!--************************************************分页**************************************-->
			<page_component :pageconf="pageconf" :pages="pages"></page_component>
		</section>	
	</body>
	<script src="../../js/jquery-3.1.1.min.js"></script>
	<script src="../../js/vue-2.1.6.min.js"></script>
	<script src="../../bootstrap-3.3.5-dist/js/bootstrap.min.js" type="text/javascript" charset="utf-8" class="bootstrap"></script>
	<script src="../../layer/xie/layer1.js"></script>
	<script src="../../js/scmp/common.js"></script>
	<script src="../../js/base.js"></script>
	<script src="../../js/scmp/pageComponent1.js"></script>
	<script src="../../js/element.js"></script>
	<script>
var vm = new Vue({
	el:"#testpaperManage",
	data:{
		assetshow:false,
		addbuildshow:false,
		addsiteshow:false,
		placelist:[],//场地列表
		buildlist:[],//楼栋列表
		buildid:'',//楼栋id
		buildname:'',//楼栋名称
		roomcatelist:[],//房间类型
		newbuildname:'',//新建楼栋名称
		teachername:'',//老师名字
		teacherlist:[],
		newfloor:'',
		newroomnum:'',
		newcateid:'',
		newsitename:'',//场地名称
		detaillist:[],//场地功能描述列表
		imglist:[],//图片列表
		img1url:'',
		img2url:'',
		img3url:'',
		
		imageUrl: '',
		
		brandstatu:0,//电子门牌状态
		brandshow:false,
		editaddstatu:0,//0:新增，1：编辑
		editid:'',//编辑场地id
		assetslist:[],//物品库存
		attentionlist:[],//列表
		attentionname:'',//注意事项名称
		attentiontext:'',//注意事项正文
		roomname:'',//实验室名称
		roomlist:[],//实验室列表
		addroomlist:[],//增加的实验室
		pageconf: {
			itemsPerPage:10,//默认显示10条
			current: 1, //默认显示第一页
			showItem: 10, //最多显示多少页，自己定义
			allpage: '', //总共多少页，根据请求返回结果计算
			totalnum: '', //总共条数，请求返回
			name:'',
			onchange: function(index,itemsperpage,name) {
				var data = {
					command:"site/listplace",
					sessionid:getCookie('sid'),
					loginid:getCookie('uid'),
					build:name,
					pagenum:index,
					pagepersize:itemsperpage,
				};
				function callback(res) {
					vm.placelist=res.placelist;
					vm.pageconf.totalnum=res.totalcount;
					vm.pageconf.allpage = Math.ceil(res.totalcount / itemsperpage);
				};
				post("/site/listplace", data, callback, errcodefn, errfn)
			}
		},
	},
	mounted:function(){
		this.pageconf.onchange(1,10,this.pageconf.name);
		this.querybuild();
		this.querylistplacecate();
	},
	methods:{
		handleAvatarSuccess(res, file) {
	        this.imageUrl = URL.createObjectURL(file.raw);
	        console.log(this.imageUrl)
	     },
		beforeAvatarUpload(file) {
	        const isJPG = (file.type === 'image/jpeg'||file.type === 'image/png');
	        const isLt2M = file.size / 1024 / 1024 < 2;
	
	        if (!isJPG) {
	          this.$message.error('上传图片只能是 JPG 格式!');
	        }
	        if (!isLt2M) {
	          this.$message.error('上传图片大小不能超过 2MB!');
	        }
	        return isJPG && isLt2M;
	     },
		queryassets:function(placeid){//物品库存
			this.assetshow=true;
			var data={
                command:"site/queryassetslist",
                sessionid:getCookie('sid'),
                loginid:getCookie('uid'),
                placeid:placeid
            }
            function callback(res){
            	vm.assetslist=res.assetslist;
            }
            post("/site/queryassetslist",data,callback,errcodefn,errfn)
		},
		addDetailBtn:function(){
			this.detaillist.push({
				title:'',
				content:''
			})
		},
		deleteDetailBtn:function(index){
			this.detaillist.splice(index,1)
		},
		upimg1(res, file){console.log(JSON.stringify(file))
			this.img1url=URL.createObjectURL(file.raw);
			this.imglist[0]=res.data.uri;
		},
		upimg2(res, file){
			this.img2url=URL.createObjectURL(file.raw);
			this.imglist[1]=res.data.uri;
		},
		upimg3(res, file){
			this.img3url=URL.createObjectURL(file.raw);
			this.imglist[2]=res.data.uri;
		},
		querybuild:function(){//查询实验室楼栋
            var data={
                command:"hr/querylevellist",
                sessionid:getCookie('sid'),
                loginid:getCookie('uid'),
                code:'building'
            }
            function callback(res){
            	vm.buildlist=res.levellist;
            }
            post("/hr/querylevellist",data,callback,errcodefn,errfn)
		},
		querylistplacecate:function(){
			var data={
                command:"site/listplacecate",
                sessionid:getCookie('sid'),
                loginid:getCookie('uid'),
            }
            function callback(res){
            	vm.roomcatelist=res.placecatelist;
            }
            post("/site/listplacecate",data,callback,errcodefn,errfn)
		},
		teacherinput:function(){
			if (this.teachername) {
				var data={
	                command:"cls/selectteacher",
	                sessionid:getCookie('sid'),
	                loginid:getCookie('uid'),
	                name:this.teachername
	            }
	            function callback(res){
	            	if(res.errcode==0){
	            		vm.teacherlist=res.teacherlist;
	            	}
	            }
	            post("/cls/selectteacher",data,callback,errcodefn,errfn)
			}
		},
		brandstatuBtn:function(){
			if (this.brandstatu==0) {//关闭
				this.detaillist=[];
				this.brandshow=true;
				this.brandstatu=1;
				if (this.detaillist.length==0) {
					this.addDetailBtn();
				}
			} else{
				this.imglist=[];
				this.img1url='';
				this.img2url='';
				this.img3url='';
				this.brandshow=false;
				this.brandstatu=0;
			}
		},
		edit:function(id){
			this.editaddstatu=1;
			this.brandstatu=0;
			this.brandshow=false;
			this.addsiteshow=true;
			this.newbuildname='';
			this.newfloor='';
			this.newroomnum='';
			this.newcateid='';
			this.newsitename='';
			this.detaillist=[];
			this.imglist=[];
			this.img1url='';
			this.img2url='';
			this.img3url='';
			this.editid=id;
			this.teachername='';
			var data={
				command:'site/findplace',
                sessionid:getCookie('sid'),
                loginid:getCookie('uid'),
                id:id
			}
			function callback(res){
            	vm.newbuildname=res.build;
            	vm.newfloor=res.floor;
            	vm.newroomnum=res.room_num;
            	vm.newcateid=res.cate_id;
            	vm.newsitename=res.name;
            	vm.detaillist=res.descriptions;
            	vm.imglist=res.pictureurls;
            	vm.teachername=res.adminname;
            	if (vm.detaillist.length!=0&&vm.imglist.length==3) {
					console.log(JSON.stringify(vm.imglist[0])+'-------------------------------')
					vm.brandstatu=1;
					vm.brandshow=true;
					vm.img1url=vm.imglist[0];
					vm.img2url=vm.imglist[1];
					vm.img3url=vm.imglist[2];
            	}else{
//          		alert('2')
            	}
            }
            post("/site/findplace",data,callback,errcodefn,errfn)
		},
		addNewSite:function(){
			this.brandstatu=0;console.log('---------brandstatu----------'+this.brandstatu)
			this.brandshow=false;
			this.editaddstatu=0;
			this.addsiteshow=true;
			this.newbuildname='';
			this.newfloor='';
			this.newroomnum='';
			this.newcateid='';
			this.newsitename='';
			this.detaillist=[];
			this.imglist=[];
			this.img1url='';
			this.img2url='';
			this.img3url='';
			this.teachername='';
		},
		remove:function(){
			this.addsiteshow=false;
			this.assetshow=false;
		},
		sureadd:function(){
			if (!this.newbuildname) {
				layer.msg('请选择楼栋');
				return false
			}
			if (!this.newfloor) {
				layer.msg('请输入楼层');
				return false
			}
			if (!this.newroomnum) {
				layer.msg('请输入房号');
				return false
			}
			if (!this.newcateid) {
				layer.msg('请选择类别');
				return false
			}
			if (!this.newsitename) {
				layer.msg('请输入场地名称');
				return false
			}
			if (!this.teachername) {
				layer.msg('请选择管理员');
				return false
			}
			if (this.brandstatu==1) {
				for (var i=0;i<this.detaillist.length;i++) {
					if ((!this.detaillist[i].title)||(!this.detaillist[i].content)) {
						layer.msg('请完善场地功能描述信息!');
						return false
					}
				}
				if (!this.img1url||!this.img2url||!this.img3url) {
					layer.msg('请完善场地图片信息!')
					return false
				}
			}
			var teacherid='';
			for (var i=0;i<this.teacherlist.length;i++) {
				if (this.teachername==this.teacherlist[i].name) {
					teacherid=this.teacherlist[i].id
				}
			}
//			alert(teacherid)
			let self = this
			if (this.editaddstatu==0) {//新增
				var data={
					command:'site/addplace',
	                sessionid:getCookie('sid'),
	                loginid:getCookie('uid'),
	                build:this.newbuildname,
	                floor:this.newfloor,
	                roomnum:this.newroomnum,
	                name:this.newsitename,
	                cateid:this.newcateid,
	                descriptions:this.detaillist,
	                pictureurls:this.imglist,
	                admin:teacherid
				}
				function callback(res){
	            	console.log(JSON.stringify(res))
	            	if (res.errcode==0) {
	            		vm.addsiteshow=false;
						layer.msg('新增场地成功！')
						self.pageconf.onchange(self.pageconf.current,self.pageconf.itemsPerPage,self.pageconf.name)
	            	}
	            }
	            post("/site/addplace",data,callback,errcodefn,errfn)
			}else{//编辑
				var data={
					command:'site/updateplace',
	                sessionid:getCookie('sid'),
	                loginid:getCookie('uid'),
	                id:this.editid,
	                build:this.newbuildname,
	                floor:this.newfloor,
	                roomnum:this.newroomnum,
	                name:this.newsitename,
	                cateid:this.newcateid,
	                descriptions:this.detaillist,
					pictureurls:this.imglist,
					admin:teacherid
				}
				function callback(res){
	            	console.log(JSON.stringify(res))
	            	if (res.errcode==0) {
	            		vm.addsiteshow=false;
						layer.msg('编辑场地成功！')
						self.pageconf.onchange(self.pageconf.current,self.pageconf.itemsPerPage,self.pageconf.name)
	            	}
	            }
	            post("/site/updateplace",data,callback,errcodefn,errfn)
			}
		},
		deletesite:function(id){
			var data={
                command:"site/deleteplace",
                sessionid:getCookie('sid'),
                loginid:getCookie('uid'),
                id:id
            }
            function callback(res){
            	if (res.errcode==0) {
            		layer.msg('该场地信息已删除！');
            		vm.pageconf.onchange(vm.pageconf.current,vm.pageconf.itemsPerPage,vm.pageconf.name)
            	}
            }
            post("/site/deleteplace",data,callback,errcodefn,errfn)
		},
		watchbuildname:function(){//监听roomname
			this.pageconf.current=1;
			this.pageconf.onchange(this.pageconf.current,this.pageconf.itemsPerPage,this.pageconf.name)
		},
		
	},
	watch:{
		newfloor:function(newval){
			console.log('------newflor------',this.newfloor)
			if(!(/^[0-9]+$/.test(this.newfloor))){
//	            layer.msg('请输入整数！111111111111')
	            this.newfloor=''
	        }
		}
	},
	computed: {
		pages: function() {
			var pag = [];
			if(this.pageconf.current < this.pageconf.showItem) { //如果当前的激活的项 小于要显示的条数
				//总页数和要显示的条数那个大就显示多少条
				var i = Math.min(this.pageconf.showItem, this.pageconf.allpage);
				while(i) {
					pag.unshift(i--);
				}
			} else { //当前页数大于显示页数了
				var middle = this.pageconf.current - Math.floor(this.pageconf.showItem / 2), //从哪里开始
					i = this.pageconf.showItem;
				if(middle > (this.pageconf.allpage - this.pageconf.showItem)) {
					middle = (this.pageconf.allpage - this.pageconf.showItem) + 1
				}
				while(i--) {
					pag.push(middle++);
				}
			}
			return pag
		}
	},
})
	</script>
</html>