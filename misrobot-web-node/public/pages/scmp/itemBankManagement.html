<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<link rel="stylesheet" href="../../bootstrap-3.3.5-dist/css/bootstrap.min.css" />
		<script src="../../js/jquery-1.11.3.js"></script>
		<script src="../../bootstrap-3.3.5-dist/js/bootstrap.min.js"></script>
		<script src="../../js/vue.min.js"></script>
		<script src="../../js/base.js"></script>
		<script src="../../js/scmp/common.js"></script>
		<script src="../../js/ajaxfileupload.js"></script>
		<script src="../../layer/xie/layer1.js"></script>
		<script src="../../js/scmp/pageComponent2.js"></script>
		<style scoped="scoped">
			* {
				margin: 0;
				padding: 0;
			}
			
			body,
			html {
				width: 100%;
				height: 100%;
			}
			
			a {
				text-decoration: none;
			}
			
			body {
				padding: 20px;
			}
			
			[v-cloak] {
				display: none;
			}
			
			.itemBankManagement {
				position: relative;
			}
			
			.itemBankManagement>p {
				width: 100%;
				background-color: lightgray;
				padding-left: 20px;
				height: 30px;
				line-height: 30px;
				margin-bottom: 20px;
			}
			
			.itemBankManagement>.center {
				margin: 0 20px 20px 20px;
			}
			.left {
				float: left;
			}
			.directToPage>div {
				float: right;
				width: 200px;
			}
			.pagination{
				margin-top: 0;
			}
			.pagination {
				margin-right: 20px;
				float: right;
				margin-top: 0px;
			}
			
			.fixedWidth{
				width: 100px;
				
			}
			.middle{
				vertical-align: middle !important;
				text-align: center;
			}
			.table-responsive th{
				text-align: center;
			}
			::-webkit-scrollbar{width:0px}
		</style>
	</head>

	<body>
		<div class="itemBankManagement" v-cloak>
			<p>题库管理</p>
			<div class="center search-wrap">
				<form class="form-inline">
					<div class="form-group" style="margin-bottom: 20px;">
						<label for="exampleInputName2" style="width: 70px;text-align: right;">题目名称：</label>
						<input type="text" class="form-control" v-model="pageconf.itemName" style="width: 200px;">
					</div>
					<div class="form-group" style="margin-bottom: 20px;">
						<label  for="exampleInputName2" style="width: 70px;text-align: right;">题目类型：</label>
						<select class="form-control" v-model="pageconf.type" style="width: 200px;">
							<option value="-1">全部</option>
							<option v-for="item in itemType" :value="item.pid">{{item.name}}</option>
						</select>
					</div>
					<div class="form-group" style="margin-bottom: 20px;">
						<label style="width: 70px;text-align: right;">所属学科：</label>
						<select class="form-control" v-model="pageconf.subject" style="width: 200px;">
							<option value="-1">全部</option>
							<option v-for="item in courseList" :value="item.id">{{item.name}}</option>
						</select>
					</div>
					<div class="form-group" style="margin-bottom: 20px;">
						<label style="width: 70px;text-align: right;">标签：</label>
						<input type="text" class="form-control" v-model="pageconf.label" style="width: 200px;">
						
					</div>
					<div class="form-group" style="margin-bottom: 20px;">
						<label style="width: 70px;text-align: right;">难度：</label>
						<select class="form-control" v-model="pageconf.difficult" style="width: 200px;">
							<option value="-1">全部</option>
							<option v-for="item in itemDifficulty" :value="item.pid">{{item.name}}</option>
						</select>
					</div>
					<div class="form-group" style="margin-bottom: 20px;">
						<label style="width: 70px;text-align: right;">创建人：</label>
						<input type="text" class="form-control" v-model="pageconf.person" style="width: 200px;">
					</div>
					<div class="form-group" style="margin-bottom: 20px;">
						<label style="width: 70px;text-align: right;">题目状态：</label>
						<select class="form-control" v-model="pageconf.status" style="width: 200px;">
							<option value="-1">全部</option>
							<option v-for="item in itemStatus" :value="item.pid">{{item.name}}</option>
						</select>
					</div>
					<div class="form-group" style="margin-bottom: 20px;">
						<button type="button" class="btn btn-primary" @click="search" style="float: left;">
							查询
						</button>
						<div class="dropdown load-in" style="float: left;margin-left: 20px;">
					<button class="btn btn-default dropdown-toggle " type="button" id="dropdownMenu1" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true" @click="dropdown">
   理论题导入
    <span class="caret"></span>
  </button>
					<ul class="dropdown-menu" aria-labelledby="dropdownMenu1" v-show="drop" >
						<li style="margin-left: 20px;" class="fileUpload">
							<div  style="width: 100px;height: 34px;position: relative;">
				    		<input type="file" name="file" class="uploadfile" style="width: 100px;height: 34px;position: absolute;left: 0;top: 0;opacity: 0;">
				    		导入
	    	            </div>
						</li>
						<li>
							<a href="/static/excel/theory-question.xls">导入模板下载</a>
						</li>
					</ul>
				</div>
						
					</div>
					<div class="form-group"></div>
					<div class="form-group" style="float: right;margin-right: 10px;">
						<button type="button" class="btn btn-primary" @click="addExam">
							新增题目
						</button>
					</div>
				</form>
			</div>
			<div class="table-responsive">
				<table class="table table-bordered table-striped">
					<tr>
						<th style="width: 100px;text-align: center;vertical-align: middle;">序号</th>
						<th style="text-align: center;">题目名称</th>
						<th style="width: 100px;text-align: center;vertical-align: middle;">题目类型</th>
						<th style="width: 120px;text-align: center;vertical-align: middle;">所属学科</th>
						<th style="width: 100px;text-align: center;vertical-align: middle;">标签</th>
						<th style="width: 100px;text-align: center;vertical-align: middle;">难度</th>
						<th style="width: 100px;text-align: center;vertical-align: middle;">创建人</th>
						<th style="width: 100px;text-align: center;vertical-align: middle;">题目状态</th>
						<th style="width: 140px;text-align: center;vertical-align: middle;">操作</th>
					</tr>
					<tr v-for="(index,item) in testList">
						<td style="vertical-align: middle;text-align: center;">{{index + 1}}</td>
						<td>{{item.questionname}}</td>
						<td style="vertical-align: middle;text-align: center;">{{item.questiontypeid | questiontype}}</td>
						<td style="vertical-align: middle;text-align: center;">{{item.coursesname}}</td>
						<td style="vertical-align: middle;text-align: center;">{{item.tag}}</td>
						<td style="vertical-align: middle;text-align: center;">{{item.difficult}}</td>
						<td style="vertical-align: middle;text-align: center;">{{item.creator}}</td>
						<td style="vertical-align: middle;text-align: center;">{{item.status | statuname}}</td>
						<td style="vertical-align: middle;text-align: center;">
							<button type="button" class="btn btn-primary btn-xs" @click="lookBtn(index,item.id,item.questiontypeid)" id={{index}}>
								查看
							</button>
							<button type="button" class="btn btn-primary btn-xs" @click="modify(item.questiontypeid,item.id)">
								编辑
							</button>
							<button type="button" class="btn btn-primary btn-xs" @click="deleteItem(item.id)">
								删除
							</button>

						</td>

					</tr>
				</table>
			</div>
			<page_component :pageconf="pageconf" :pages="pages"></page_component>
		</div>
		<div class="popUp" v-show="popup" style="position: absolute;left: 0;top: 0;width: 100%;height: 100%;background-color: rgba(0,0,0,0.3);z-index: 9999;">
			<div id="popUp" style="width: 500px;height: 200px;position: absolute;margin: auto;left: 0;right: 0;top: 0;bottom: 0;background-color: white">
				<p style="height: 40px;line-height: 40px;background-color: #F2F2F2;">
					<span style="margin-left: 20px;">新增题目</span>
					<img src="../../images/assistant/guanbi-tanchuang-h.png" alt="" @click="cancel" style="width: 20px;float: right;margin-top: 10px;margin-left: 20px;"/>
				</p>
				<form class="form-horizontal" style="margin: 20px;">
					<div>
						<div class="form-group" style="overflow: hidden;">
							<label class="col-md-3 control-label" style="height: 34px;line-height: 23px;float: left;">题目类型 ：</label>
							<div class="col-md-8" style="width: 300px;float: left;">
								<select class="form-control " v-model="examType">
									<option value="0">单选题</option>
									<option value="1">多选题</option>
									<option value="2">判断题</option>
									<option value="3">问答题</option>
									<option value="4">组合题</option>
									<option value="5">操作题</option>
								</select>
							</div>
						</div>
					</div>
				</form>
				<div style="margin-top: 30px;text-align: center;">
					<button @click="sure" class="btn btn-primary" style="margin-right: 30px;">确定</button>
					<button @click="cancelBtn" class="btn btn-default">取消</button>
				</div>
			</div>
		</div>
	</body>
	<script type="text/javascript">
		var vm = new Vue({
			el: '.itemBankManagement',
			data: {
				drop:false,
				list: '',
				itemType:'',
				itemDifficulty:'',
				itemStatus:'',
				questionid: '',
				testList: [],
				courseList: [],
				pageconf: {
					itemName:'',
					type:'',
					subject:'',
					label:'',
					person:'',
					difficult:'',
					status:'',
					itemsPerPage: 10,
					current: 1, //默认显示第一页
					showItem: 5, //最多显示多少页，自己定义
					allpage: '', //总共多少页，根据请求返回结果计算
					totalnum: '', //总共条数，请求返回
					onchange: function(index, itemsperpage,a,b,c,d,e,f,g) { //ajax,index表示查看第几页,itemsperpage表示每页多少条
					
						changepage('page=' + index + '&number=' + itemsperpage);
						var _this = this;
						var _json = {
							"1": {
								command: "question/queryquestionlist",
								sessionid: getCookie('sid'),
								loginid: getCookie('uid'),
								page: index,
								reqnum: itemsperpage,
								questionname:a,
								questiontypeid:b,
								creator:c,
								status:d,
								courseid:e,
								tag:f,
								difficult:g
							}
						};
						var json = JSON.stringify(_json);
						$.ajax({
							url: "/question/queryquestionlist",
							type: "POST",
							data: json,
							success: function(data) {
								console.log(data)
								data = data["1"];
								if(data.errcode == 0) {
									vm.testList = [];
									vm.testList = data.questionlist;
									for (let i=0;i<vm.testList.length;i++) {
										vm.testList[i].difficult='';
									}
									vm.pageconf.totalnum = data.allcount;
									vm.pageconf.allpage = Math.ceil(data.allcount / itemsperpage);
								} else if(data.errcode == 9904) {
									layer.msg("登录信息已失效，请重新登录");
								}
							},
							error: function() {
								errfn();
							}
						})
					}
				}
			},
			mounted() {
				
			},
			created: function() {
				var self=this;
				self.pageconf.status=-1;
				
				self.pageconf.onchange(findurltype('page'), findurltype('number'),self.pageconf.itemName,self.pageconf.type,self.pageconf.person,'',self.pageconf.subject,self.pageconf.label,self.pageconf.difficult);
				self.selectCourse();
				self.typeList();
				self.statusList();
				self.difficultyList();
				$('.fileUpload').on('change', '.uploadfile', function(){
					var val = $('.uploadfile').val();
					if(!val) return;
					var data={
		            	command:'question/importtheoreticalquestions',
		            	sessionid:getCookie('sid'),
		            	loginid:getCookie('uid'),
		            }
		            function callback(res){
		            	
		            	$('.uploadfile').val('');
		            	console.log(res)
		            	if (res && res.errcode==000000) {
		            		layer.msg('导入成功')
		            	    self.drop=false;
		            	self.pageconf.onchange(1, 10,'','','','','','',''); 
		            	}else{
		            		layer.msg(res.errdesc)
		            	}
		            	
	           		}
					importExcel($('.uploadfile'),data,callback, function(){
						$('.uploadfile').val('');
					})
				});

//				$('.uploadfile').on('change',function () {
//					
//		            
//	        	});
			},
			filters: {
				statuname: function(value) {
					if(value == 1) {
						return '可使用'
					} else if(value == 0) {
						return '编辑中'
					}
				},
				questiontype: function(value) {
					switch(value) {
						case 1:
							return '单选题';
							break;
						case 2:
							return '多选题';
							break;
						case 3:
							return '不定项选择题';
							break;
						case 4:
							return '判断题';
							break;
						case 5:
							return '问答题';
							break;
						case 6:
							return '组合题';
							break;
						case 7:
							return 'osce操作题';
							break;
						case 8:
							return 'learn训练操作题';
							break;
					}
				}
			},
			computed: {
				pages: function() {
					var pag = [];
					if(this.pageconf.current < this.pageconf.showItem) { //如果当前的激活的项 小于要显示的条数
						//总页数和要显示的条数那个大就显示多少条
						var i = Math.min(this.pageconf.showItem, this.pageconf.allpage);
						while(i) {
							pag.unshift(i--);
						}
					} else { //当前页数大于显示页数了
						var middle = this.pageconf.current - Math.floor(this.pageconf.showItem / 2), //从哪里开始
							i = this.pageconf.showItem;
						if(middle > (this.pageconf.allpage - this.pageconf.showItem)) {
							middle = (this.pageconf.allpage - this.pageconf.showItem) + 1
						}
						while(i--) {
							pag.push(middle++);
						}
					}
					return pag
				}
			},
			methods: {
				dropdown(){
					this.drop=true;
				},
				search:function(){
					let newType=this.pageconf.type;
					let newSubject=this.pageconf.subject;
					let newDifficult=this.pageconf.difficult;
					let newStatus=this.pageconf.status;
					if(this.pageconf.type==-1){
						
						newType='';
					}
					if(this.pageconf.subject==-1){
						newSubject='';
					}
					if(this.pageconf.difficult==-1){
						newDifficult='';
					}
					if(this.pageconf.status==-1){
						newStatus='';
					}
           this.pageconf.onchange(1, 10,this.pageconf.itemName,newType,this.pageconf.person,newStatus,newSubject,this.pageconf.label,newDifficult);
          this.pageconf.current=1
				},
				selectCourse: function() {
					var self = this;
					var data = {
						command: 'cls/selectCourses',
						sessionid: getCookie('sid'),
						loginid: getCookie('uid')
					}

					function callback(res) {
						self.courseList = res.courseslist;
					}
					post('/cls/selectcourses', data, callback, errcodefn, errfn)
				},
				lookBtn: function(index, pram, type) {
					if(type == 1) {
						layer.open({
							type: 2,
							title: '查看题目-单选题',
							area: ['100%', '100%'],
							shadeClose: true,
							content: './look-danxuan.html?id=' + pram
						})
					} else if(type == 2) {
						layer.open({
							type: 2,
							title: '查看题目-多选题',
							area: ['100%', '100%'],
							shadeClose: true,
							content: './look-duoxuan.html?id=' + pram
						})
					} else if(type == 4) {
						layer.open({
							type: 2,
							title: '查看题目-判断题',
							area: ['100%', '100%'],
							shadeClose: true,
							content: './look-panduan.html?id=' + pram
						})
					} else if(type == 5) {
						layer.open({
							type: 2,
							title: '查看题目-问答题',
							area: ['100%', '100%'],
							shadeClose: true,
							content: './look-wenda.html?id=' + pram
						})
					} else if(type == 6) {
						layer.open({
							type: 2,
							title: '查看题目-组合题',
							area: ['100%', '100%'],
							shadeClose: true,
							content: './look-zuhe.html?id=' + pram
						})
					} else if(type == 7) {
						layer.open({
							type: 2,
							title: '查看题目-操作题',
							area: ['100%', '100%'],
							shadeClose: true,
							content: './look-caozuo.html?id=' + pram
						})
					}
				},
				addExam: function() {
					vm2.popup = true;
				},
				modify: function(prama, prama2) {
					var _this = this;
					_this.questionid = '';
					_this.questionid = prama2;
					var commandName = "";
//					document.documentElement.style.overflowY = 'hidden';
					if(prama == 1 || prama == 2 || prama == 4 || prama == 5) {
						commandName = 'question/querysinglequestion'
					} else if(prama == 6) {
						commandName = 'question/querycombinationquestion'
					} else if(prama == 7) {
						commandName = 'question/queryoprquestion'
					}
					var _json = {
						"1": {
							command: commandName,
							sessionid: getCookie('sid'),
							loginid: getCookie('uid'),
							questionbaseid: prama2
						}
					};
					var json = JSON.stringify(_json);
					var url = '\/' + commandName;
					$.ajax({
						url: url,
						type: "POST",
						data: json,
						success: function(data) {
							data = data["1"];
							if(data.errcode == 0) {
								_this.list = data;
								if(prama == 1) {
									layer.open({
										type: 2,
										title: '编辑题目-单选题',
										area: ['100%', '100%'],
										shadeClose: true,
										content: './modify_danxuan.html'
									})
								} else if(prama == 2) {
									layer.open({
										type: 2,
										title: '编辑题目-多选题',
										area: ['100%', '100%'],
										shadeClose: true,
										content: './modify_duoxuan.html'
									})
								} else if(prama == 5) {
									layer.open({
										type: 2,
										title: '编辑题目-问答题',
										area: ['100%', '100%'],
										shadeClose: true,
										content: './modify_wenda.html'
									})
								} else if(prama == 4) {
									layer.open({
										type: 2,
										title: '编辑题目-判断题',
										area: ['100%', '100%'],
										shadeClose: true,
										content: './modify_panduan.html'
									})
								} else if(prama == 6) {
									layer.open({
										type: 2,
										title: '编辑题目-组合题',
										area: ['100%', '100%'],
										shadeClose: true,
										content: './modify_zuhe.html'
									})
								}else if(prama == 7) {
									layer.open({
										type: 2,
										title: '编辑题目-操作题',
										area: ['100%', '100%'],
										shadeClose: true,
										content: './modify_caozuo.html'
									})
								}
							} else if(data.errcode == 9904) {
								layer.msg("登录信息已失效，请重新登录");
							}
						},
						error: function() {
							errfn();
						}
					})
				},
				deleteItem(prama) {
					var self = this;
					layer.confirm('是否确定删除？', {
						btn: ['确定', '取消'] //按钮
					}, function() {
						var data = {
							command: 'question/deletequestion',
							sessionid: getCookie('sid'),
							loginid: getCookie('uid'),
							questionid: prama
						};

						function callback(res) {
							self.pageconf.onchange(findurltype('page'), findurltype('number'));
							layer.msg('已删除当前题目');
						}
						post('/question/deletequestion', data, callback, errcodefn, errfn)
					});
				},
				typeList:function(){
					var self=this;
					var data={
						command: 'question/queryoptionlist',
						sessionid: getCookie('sid'),
						loginid: getCookie('uid'),
						levelcode: 'cateid'
					}
					function callback(res){
						console.log(res)
						self.itemType=res.optionlist;
					}
					post('/question/queryoptionlist',data,callback,errcodefn,errfn)
				},
				difficultyList:function(){
					var self=this;
					var data={
						command: 'question/queryoptionlist',
						sessionid: getCookie('sid'),
						loginid: getCookie('uid'),
						levelcode: 'difficulty'
					}
					function callback(res){
						console.log(res)
						self.itemDifficulty=res.optionlist;
					}
					post('/question/queryoptionlist',data,callback,errcodefn,errfn)
				},
				statusList:function(){
					var self=this;
					var data={
						command: 'question/queryoptionlist',
						sessionid: getCookie('sid'),
						loginid: getCookie('uid'),
						levelcode: 'questionstatus'
					}
					function callback(res){
						console.log(res)
						self.itemStatus=res.optionlist;
					}
					post('/question/queryoptionlist',data,callback,errcodefn,errfn)
				}
			}
		})
		var vm2 = new Vue({
			el: '.popUp',
			data: {
				popup: false,
				examType: 0
			},
			methods: {
				cancel: function() {
					this.popup = false;
				},
				sure: function() {
					if(this.examType == 0) {
						window.location.href = "./newq_danxuan.html"
					} else if(this.examType == 1) {
						window.location.href = "./newq_duoxuan.html"
					} else if(this.examType == 2) {
						window.location.href = "./newq_panduan.html"
					} else if(this.examType == 3) {
						window.location.href = "./newq_wenda.html"
					} else if(this.examType == 4) {
						window.location.href = "./newq_zuhe.html"
					} else if(this.examType == 5) {
						window.location.href = "./newq_caozuo.html"
					}
				},
				cancelBtn: function() {
					this.cancel();
					this.examType=0;
				}
			}
		})
	</script>

</html>