<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>设置开放时间</title>
		<script src="../../js/vue.js"></script>
		<script src="../../js/element.js"></script>
		<script src="../../js/jquery-1.11.3.js"></script>
		<script src="../../layer/xie/layer1.js"></script>
		<script src="../../js/scmp/common.js"></script>
		<link rel="stylesheet" href="../../css/element.css">
		<link rel="stylesheet" href="../../css/reset.css">
		<style type="text/css">
			.handTime{
				margin: 20px;
			}
			.handTime .next {
				text-align: center;
			}
			
			.handTime .addBtn {
				margin-right: 20px;
				margin-top: 20px;
			}
			
			.handTime .place {
				height: 40px;
				line-height: 40px;
			}
			
			.handTime .addTimeBtn {
				margin: 20px 0;
			}
			.handTime .op {
				padding: 0 80px 0 20px;
				height: 42px;
				line-height: 42px;
				border-bottom: 1px solid #eee;
				font-size: 14px;
				color: #333;
				overflow: hidden;
				background-color: #F8F8F8;
				border-radius: 2px 2px 0 0;
			}
			.handTime .oa{
				color: rgb(32, 136, 194);
				cursor: pointer;
			}
		</style>
	</head>

	<body>
		<div class="handTime">
			<p class="op">
				<span class="oa" @click="back">开放日历设置</span>
				<span>&gt;&gt;设置开放时间</span>
			</p>
			<p class="place">场地：{{getPlace}}</p>
			<el-button type="primary" class="addTimeBtn" @click="addTimeBtn">新增开放时间</el-button>
			<!--新的-->
			<div>
				<template>
					<el-table :data="timeDetail" border style="width: 100%">
						<el-table-column label="开放训练项" prop="code">
							<template scope="scope">
								<span v-for="item in timeDetail[scope.$index].learnlist">{{item.name}}&nbsp;&nbsp;</span>
							</template>
						</el-table-column>
						<el-table-column label="开放日期" prop="week">
						</el-table-column>
						<el-table-column label="时间段">
							<template scope="scope">
								<span v-for="item in timeDetail[scope.$index].times">{{item.openstarttime |filterFun }}-{{item.openendtime | filterFun }} &nbsp;&nbsp;</span>
							</template>
						</el-table-column>
						<el-table-column label="有效期" prop="dates">
						</el-table-column>
						<el-table-column label="操作">
							<template scope="scope">
								<el-button size="small" type="primary" @click="edit(scope.$index, scope.row)">修改</el-button>
								<el-button size="small" type="danger" @click="remove(scope.$index, scope.row)">删除</el-button>
							</template>
						</el-table-column>
					</el-table>
				</template>
			</div>
			<div class="next">
				<el-button type="primary" class="addBtn" @click="saveAll">保存</el-button>
				<el-button type="primary" class="addBtn" @click="cancelAll">取消</el-button>
			</div>
		</div>
	</body>
	<script type="text/javascript">
		Vue.filter('filterFun', function(val) {
			return val.substring(0, 5)
		});
		var vm = new Vue({
			el: '.handTime',
			data: {
				placeid: window.location.href.split('=')[1], //上个页面传过来的placeid
				timeDetail: [], //已有开放时间数组
				getPlace: '', //场地
				placeOpenTime: [], //修改后传给后台的数组
				dataObj:'',//修改时把数据传递给弹出框
				indexs:'',//修改时记录下标
				flag:true,
			},
			mounted() {
				this.findPlace();
				this.getTimeList();
			},
			methods: {
				back(){
					closeAll();
				},
				getTimeList: function() { //获取已有开放时间接口
					let self = this;
					var data = {
						command: "open/queryopentimelist",
						sessionid: getCookie('sid'),
						loginid: getCookie('uid'),
						placeid: self.placeid
					}

					function callback(res) {
						if(res && res.errcode == 0) {
							var weekArr = [];
							for(var i = 0; i < res.opentimelist.length; i++) {
								weekArr.push({
									newArr: res.opentimelist[i].date.split(',')
								});
							}

							for(var i = 0; i < weekArr.length; i++) {
								for(var j = 0; j < weekArr[i].newArr.length; j++) {
									if(weekArr[i].newArr[j] == 1) {
										weekArr[i].newArr[j] = '周一';
									} else if(weekArr[i].newArr[j] == 2) {
										weekArr[i].newArr[j] = '周二';
									} else if(weekArr[i].newArr[j] == 3) {
										weekArr[i].newArr[j] = '周三';
									} else if(weekArr[i].newArr[j] == 4) {
										weekArr[i].newArr[j] = '周四';
									} else if(weekArr[i].newArr[j] == 5) {
										weekArr[i].newArr[j] = '周五';
									} else if(weekArr[i].newArr[j] == 6) {
										weekArr[i].newArr[j] = '周六';
									} else if(weekArr[i].newArr[j] == 7) {
										weekArr[i].newArr[j] = '周日';
									}
								}
							}
							for(var i = 0; i < res.opentimelist.length; i++) {
								self.timeDetail.push({
									times: res.opentimelist[i].timelist,
									dates: res.opentimelist[i].starttime + '~' + res.opentimelist[i].endtime,
									id: res.opentimelist[i].openid,
//									place_id: res.opentimelist[i].place_id
                                    learnlist:res.opentimelist[i].learnlist,     
                                    holidayopen:res.opentimelist[i].holidayopen,
                                    workingdaysoff:res.opentimelist[i].workingdaysoff
								})
							}
							for(var i = 0; i < weekArr.length; i++) {
								self.$set(self.timeDetail[i], 'week', weekArr[i].newArr.join(','))
							}
						} else {
							layer.msg(res.errdesc)
						}
					}
					post('/open/queryopentimelist', data, callback, errcodefn, errfn)
				},
				findPlace: function() { //获取场地接口
					var self = this;
					var data = {
						command: "site/findplace",
						sessionid: getCookie('sid'),
						loginid: getCookie('uid'),
						id: self.placeid

					}

					function callback(res) {
						self.getPlace = res.roomnum;
					}
					post('/site/findplace', data, callback, errcodefn, errfn)
				},
				addTimeBtn: function() { //新增开放时间按钮
						layer.open({
							type: 2,
							title: '新增开放时段',
							shadeClose: false,
							shade: 0.7,
							area: ['80%', '80%'],
							content: 'xiehe_addTimeTwo.html?pram=0&placeid='+this.placeid
						});
				},
				saveAll: function() { //保存按钮
					let self = this;
					if(self.timeDetail.length == 0) {
						layer.msg('开放时间不能为空')
						return
					}
					for(let i = 0; i < self.timeDetail.length; i++) {
						let saveArr = self.timeDetail[i].week.split(',');
						for(let j = 0; j < saveArr.length; j++) {
							if(saveArr[j] == '周一') {
								saveArr[j] = '1'
							} else if(saveArr[j] == '周二') {
								saveArr[j] = '2'
							} else if(saveArr[j] == '周三') {
								saveArr[j] = '3'
							} else if(saveArr[j] == '周四') {
								saveArr[j] = '4'
							} else if(saveArr[j] == '周五') {
								saveArr[j] = '5'
							} else if(saveArr[j] == '周六') {
								saveArr[j] = '6'
							} else if(saveArr[j] == '周日') {
								saveArr[j] = '7'
							}
						}
						let learnList=[];
						for (let j=0;j<self.timeDetail[i].learnlist.length;j++) {
							learnList.push(self.timeDetail[i].learnlist[j].learnid)
						}
							self.placeOpenTime.push({
								openid: self.timeDetail[i].id,
								starttime: self.timeDetail[i].dates.split('~')[0],
								endtime: self.timeDetail[i].dates.split('~')[1],
								date: saveArr.join(','),
								timelist: self.timeDetail[i].times,
								placeid: self.placeid,
								learnlist:learnList,
                                holidayopen:self.timeDetail[i].holidayopen,
                                workingdaysoff:self.timeDetail[i].workingdaysoff
							})
					}
					let data = {
						command: "open/addopentimes",
						sessionid: getCookie('sid'),
						loginid: getCookie('uid'),
						opentimelist: self.placeOpenTime
					}

					function callback(res) {
						if(res && res.errcode == 0) {
							layer.msg("保存成功！")
							setTimeout(function() {
								self.placeOpenTime = [];
								window.parent.layer.closeAll();
							}, 1000)
							this.flag=true;
						} else {
							layer.msg(res.errdesc)
							this.flag=true;
						}
					}
					if(this.flag){
						this.flag=false;
						post('/open/addopentimes', data, callback, errcodefn, errfn)
					}
					
				},
				remove: function(indexs, row) { //删除一条信息按钮
					layer.confirm('确定删除此条开放时间吗？', {
						title: '删除',
						btn: ['确定', '取消']
					}, function() {
						vm.timeDetail.splice(indexs, 1);
						layer.msg('删除成功')
						setTimeout(function(){
							var index = layer.index; //获取当前弹层的索引号
						    layer.close(index); //关闭当前弹层F
						},500)
					}, function() {

					})
				},
				edit:function(index,row){//老的修改按钮
					this.dataObj=row;
					this.indexs=index;
					layer.open({
							type: 2,
							title: '新增开放时段',
							shadeClose: false,
							shade: 0.7,
							area: ['80%', '80%'],
							content: 'xiehe_addTimeTwo.html?pram=1&placeid='+this.placeid
					});
				},
				cancelAll:function(){//取消按钮
					closeAll()
				},
			}
		})
	</script>

</html>