<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>批量增加门禁用户</title>
    <link rel="stylesheet" href="../../css/scmp/doorControl.css">
    <script src="../../js/jquery-1.11.3.js"></script>
    <script src="../../layer/xie/layer1.js"></script>
    <script src="../../js/scmp/common.js"></script>
    <script src="../../js/vue.js"></script>
    <script src="../../bootstrap-3.3.5-dist/js/bootstrap.min.js"></script>
    <script src="../../js/scmp/jquery-ui.js"></script>
    <link rel="stylesheet" href="../../css/assistant/style.css">
    <link rel="stylesheet" href="../../bootstrap-3.3.5-dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="../../css/scmp/scmpcommon.css">
</head>
<body>
    <div class="container-fluid" v-cloak>
        <div class="setTLeft">
            <div class="search searchLeft">
                <input type="text" placeholder="输入用户名">
                <button class="btn btn-default" onclick="searchUserName(this)"> <i class="glyphicon glyphicon-search"></i> 搜索</button>
            </div>
            <ul id="users">
                <li class="userListHeader">
                    <strong class="s1">姓名</strong>
                    <b> </b>
                    <strong class="s2">工号</strong>
                </li>
                <li @click="toggleUser(index)" v-for="(value,index) in userSearched" :data-index="index">
                    <i class="notChoosed"></i>
                    <span>{{ value.name }}</span>&nbsp;&nbsp; <span>{{ value.username }}</span>
                </li>
            </ul>
        </div>
        <div class="setTCenter">
            <div>
                <button class="btn btn-default" @click="pushDoorUser()">增加 &gt;&gt;</button><br><br>
                <button class="btn btn-default" @click="pullDoorUser()">&lt;&lt; 删除</button>
            </div>
        </div>
        <div class="setTRight">
            <p>已选用户</p>
            <ul class="choosedList" id="choosedUser">
                <li @click="toggleChoosedUser(index)" v-for="(value,index) in userChoosed" :data-index="index">
                    <span>{{ value.name }}</span>&nbsp;&nbsp; <span>{{ value.username }}</span>
                </li>
            </ul>
        </div>
        <div class="bottomBtns">
            <button class="btn btn-primary" @click="saveAddUser()">确 定</button>&nbsp;&nbsp;
            <button class="btn btn-default" onclick="closeAddUser()">关 闭</button>
        </div>
    </div>

    <script>
        var choosedDoorInfo=getCookie('choosedDoorInfo');
        choosedDoorInfo=choosedDoorInfo.split('-');
        var temp=[];
        for(index in choosedDoorInfo){
            temp.push(JSON.parse(choosedDoorInfo[index]));
        };
        choosedDoorInfo=temp;
        var vm=new Vue({
            el:'.container-fluid',
            data:{
                userSearched:[],
                userChoosed:[]
            },
            methods:{
                saveAddUser:function(){
                    var self=this;
                    if(self.userChoosed.length==0){//已选不能为空
                        layer.msg("请选择需要添加的用户");
                        return
                    };
                    var sendUserList=[];//接口输入用户数组
                    for(var i=0;i<choosedDoorInfo.length;i++){
                        for(var j=0;j<self.userChoosed.length;j++){
                            sendUserList.push({
                                doorctrl_id:choosedDoorInfo[i].doorctrl_id,
                                doorctrl_sn:choosedDoorInfo[i].doorctrl_sn,
                                door_id:choosedDoorInfo[i].door_id,
                                door_num:choosedDoorInfo[i].door_num,
                                userid:self.userChoosed[j].uid,
                                name:self.userChoosed[j].name,
                                user_code:self.userChoosed[j].username,
                                cardno:self.userChoosed[j].cardno
                            })
                        }
                    };
                    var data={
                        command:"dooraccesscontrol/adddooruser",
                        sessionid:getCookie('sid'),
                        loginid:getCookie('uid'),
                        userlist:sendUserList
                    };
                    for(index in sendUserList){
                        console.log(JSON.stringify(sendUserList[index]))
                    };
                    function callback(res){
                        layer.msg('批量添加用户成功',{icon:1});
                        setTimeout(closeAll,2000)
                    };
                    post("/dooraccesscontrol/adddooruser",data,callback,errcodefn,errfn)
                },
                toggleUser:function(index){
                    $("#users li:not(.userListHeader):eq("+index+") i").toggleClass("isChoosed");
                    $("#users li:not(.userListHeader):eq("+index+")").toggleClass("grayBg");
                },
                toggleChoosedUser:function(index){
                    $("#choosedUser li:eq("+index+")").toggleClass("grayBg");
                },
                pushDoorUser:function(){//点击增加按钮，增加本门的门禁用户
                    var self=this;
                    for(var i=0;i<$("#users li.grayBg").length;i++){
                        self.userChoosed.push(
                                self.userSearched[$("#users li.grayBg:eq("+i+")").data("index")]
                        );
                    };
                    $("#users li i").each(function(){
                        $(this).removeClass("isChoosed");
                    });
                    $("#users li").each(function(){
                        $(this).removeClass("grayBg")
                    });
                },
                pullDoorUser:function(){//点击删除按钮，移除本门的门禁用户
                    var self=this;
                    for(var i=0;i<$("#choosedUser li.grayBg").length;i++){
                        delete self.userChoosed[$("#choosedUser li.grayBg:eq("+i+")").data("index")];

                    };
                    var temp=[];
                    for(index in self.userChoosed){
                        temp.push(self.userChoosed[index])
                    };
                    self.userChoosed=[];
                    self.userChoosed=temp;
                    $("#choosedUser li").each(function(){
                        $(this).removeClass("grayBg")
                    });
                },
            }
        });
        function closeAddUser(){
            closeAll();
        };
        function searchUserName(elem){//增加门禁用户的搜索框
            var input=$(elem).prev().val();
            if(input!="输入用户名"){
                var data={
                    command:"userinfo/queryuserinfobyname",
                    loginid:getCookie('uid'),
                    sessionid:getCookie('sid'),
                    name:input
                };
                function callback(res){
                    if(res.resultlist.length==0){
                        layer.msg("该用户不存在或没有卡号！",{icon:5});
                        return
                    };
                    vm.userSearched=res.resultlist;
                    console.log(JSON.stringify(vm.userSearched[0]));
                };
                post("/userinfo/queryuserinfobyname",data,callback,errcodefn,errfn)
            }else{
                layer.msg("请输入用户名")
            }
        };
    </script>
</body>
</html>