<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>新增报名</title>
    <script src="../../js/vue.js"></script>
    <script src="../../js/element.js"></script>
    <script src="../../js/jquery-1.11.3.js"></script>
    <script src="../../layer/xie/layer1.js"></script>
    <script src="../../js/scmp/common.js"></script>
    <script src="../../js/moment.js"></script>
    <link rel="stylesheet" href="../../css/element.css">
    <link rel="stylesheet" href="../../css/reset.css">

</head>
<style>
    [v-cloak] {
        display: none;
    }
    #add_detail{
        padding:50px;
    }
    .el-form-item__content{
        line-height: 32px !important;
    }
</style>
<body>
<div id="add_detail" v-cloak>
    <el-form :model="form" :rules="rules" ref="form" :label-position="labelPosition" label-width="80px">
        <el-row :gutter="20">
            <el-col :span="12">
                <el-form-item label="手机号" label-width="80px" prop="mobile">
                    <el-input v-model="form.mobile" @blur="exist(form.mobile)"></el-input>
                </el-form-item>
            </el-col>
            <el-col :span="12">
                <el-form-item label="邮箱" label-width="80px">
                    <el-input v-model="form.email"></el-input>
                </el-form-item>
            </el-col>
            <el-col :span="12">
                <el-form-item label="姓名" label-width="80px" prop="pname">
                    <el-input v-model="form.pname"></el-input>
                </el-form-item>
            </el-col>
            <el-col :span="12">
                <el-form-item label="职称" label-width="80px">
                    <el-select v-model="form.professional" placeholder="请选择职称">
                        <el-option v-for="item in titlelist" :key="item.id" :label="item.name" :value="item.id" ></el-option>
                    </el-select>
                </el-form-item>
            </el-col>
            <el-col :span="12">
                <el-form-item label="学历" label-width="80px">
                    <el-select v-model="form.educational" placeholder="请选择学历">
                        <el-option v-for="item in educationlist" :key="item.id" :label="item.name" :value="item.id"></el-option>
                    </el-select>
                </el-form-item>
            </el-col>
            <el-col :span="12">
                <el-form-item label="出生年月" label-width="80px">
                    <el-date-picker v-model="form.birthday" type="date"
                                    placeholder="选择时间"
                                    :picker-options="pickerOptions"
                                    @change="dateChange">
                    </el-date-picker>
                </el-form-item>
            </el-col>
            <el-col :span="12">
                <el-form-item label="工作单位" label-width="80px" prop="workunit">
                    <el-input v-model="form.workunit"></el-input>
                </el-form-item>
            </el-col>
            <el-col :span="12">
                <el-form-item label="医院等级" label-width="80px">
                    <el-select v-model="form.hospitallevel" placeholder="请选择医院等级">
                        <el-option v-for="item in hospitallist" :key="item.id" :label="item.name" :value="item.id"></el-option>
                    </el-select>
                </el-form-item>
            </el-col>
            <el-col :span="24">
                <el-form-item label="选择报名计划" label-width="120px" prop="plan">
                    <el-select v-model="form.plan" placeholder="请选择报名计划">
                        <el-option v-for="item in planlist" :key="item.trainingplanid" :label="item.trainingname" :value="item.trainingplanid"></el-option>
                    </el-select>
                </el-form-item>
            </el-col>
            <el-col :span="24">
                <p style="font-size: 16px; margin-left: -30px">发票信息</p>
            </el-col>
            <el-col :span="24">
                <el-form-item label="发票抬头" label-width="120px" prop="invoiceheader">
                    <el-input v-model="form.invoiceheader"></el-input>
                </el-form-item>
            </el-col>
            <el-col :span="24">
                <el-form-item label="纳税人识别号" label-width="120px" prop="taxpayernumber">
                    <el-input v-model="form.taxpayernumber"></el-input>
                </el-form-item>
            </el-col>
            <el-col :span="24">
                <el-form-item label="联系地址" label-width="120px" prop="address">
                    <el-input v-model="form.address"></el-input>
                </el-form-item>
            </el-col>

            <el-col :span="22" style="text-align: center">
                <el-form-item>
                    <el-button  type="primary" @click="save('form')">提交</el-button>
                    <el-button @click="cancel">取消</el-button>
                </el-form-item>
            </el-col>
        </el-row>
    </el-form>
</div>

</body>
<script>
    var vm = new Vue({
        el:"#add_detail",
        data:{
            userlist:[],//已注册用户列表
            titlelist:[],//职称
            educationlist:[],//学历
            hospitallist:[],//医院等级
            planlist:[],//报名计划
            form:{
                mobile:'',
                pname:'',
                email:'',
                birthday:'',
                professional:'',
                educational:'',
                workunit:'',
                hospitallevel:'',
                plan:'',
                invoiceheader:'',
                taxpayernumber:'',
                address:'',
            },
            pickerOptions:{},
            labelPosition: 'left',//element-ui label的位置
            rules: {//定义验证规则
                pname: [
                    { required: true, message: '请输入姓名'}
                ],
                mobile: [
                    { required: true, message: '请输入手机号'},
//                    { type: 'number', message: '请输入数字'}
                ],
                plan: [
                    {required: true, message: '请选择报名计划'},
                ]
            }
        },
        mounted (){
            var _self = this
            _self.show_professional();
            _self.show_educational();
            _self.show_hospitallevel();
            _self.show_planlist();
        },
        methods:{
            dropdown(){
                this.upload=true;
            },
            exist(val){
                var _self = this;
                var data={
                    command:'user/queryuserinfo',//接口地址
                    sessionid:getCookie('sid'),
                    loginid:getCookie('uid'),
                    mobile:val,
                };
                function callback(res){
                    if(res.mobile){
                        layer.msg("该用户已存在");
                        setTimeout(function () {
                            _self.form.pname = res.name;
                            _self.form.email = res.email;
                            _self.form.birthday = res.birthday;
                            _self.form.professional = (res.professional == 0) ? '' : res.professional;
                            _self.form.educational = (res.educational == 0) ? '' : res.educational;
                            _self.form.hospitallevel = (res.hospitallevel == 0) ? '' : res.hospitallevel;
                            _self.form.workunit = res.workunit;
                        },500)
                    }
              };
              post('/user/queryuserinfo',data,callback,errcodefn,errfn)
            },
            dateChange(val){
                this.birthday=val;
            },
            cancel:function(){
                var index = parent.layer.getFrameIndex(window.name);
                parent.layer.close(index)
            },
            save:function(val){
                var _self=this;
                var reg1 = /^1[34578]\d{9}$/;      //手机号验证
                var reg2 = /^[0-9A-Z]{15,25}$/;    //税号验证
                var reg3 = /^(\w-*\.*)+@(\w-?)+(\.\w{2,})+$/;   //邮箱号验证
                if (!reg1.test(_self.form.mobile)) {
                    layer.msg('请输入正确格式的手机号');
                    return
                }
                if (_self.form.taxpayernumber != '' && !reg2.test(_self.form.taxpayernumber)) {
                    layer.msg('请输入正确格式的税号');
                    return
                }
                if (_self.form.email != '' && !reg3.test(_self.form.email)) {
                    layer.msg('请输入正确格式的邮箱号');
                    return
                }
                var _json={
                    "1":{
                        command:'externaltrain/adduserwxinfo',
                        sessionid:getCookie('sid'),
                        loginid:getCookie('uid'),
                        mobile:_self.form.mobile,
                        name:_self.form.pname,
                        email:_self.form.email,
                        birthday:_self.form.birthday ? moment(_self.form.birthday).format('YYYY-MM-DD') : '',
                        professional:_self.form.professional,
                        educational:_self.form.educational,
                        workunit:_self.form.workunit,
                        hospitallevel:_self.form.hospitallevel,
                        planid:_self.form.plan,
                        invoiceheader:_self.form.invoiceheader,
                        taxpayernumber:_self.form.taxpayernumber,
                        address:_self.form.address,
                    }
                };
                var json=JSON.stringify(_json);
                _self.$refs[val].validate(function(valid){
                    if (valid) {
                        $.ajax({
                            url: "/externaltrain/adduserwxinfo",
                            type: "POST",
                            data:json,
                            success: function (data) {
                                data = data["1"];
                                if (data.errcode == 0) {
                                    layer.msg('添加成功!');
                                    _self.$refs[val].resetFields();
                                    setTimeout(function () {
                                        var index = parent.layer.getFrameIndex(window.name);
                                        parent.layer.close(index)
                                    },2000);
                                } else if (data.errcode == 9904) {
                                    layer.msg("登录信息已失效，请重新登录");
                                } else {
                                    layer.msg(data.errdesc)
                                }
                            },
                        error:function() {
                            errfn();
                        }
                        })
                    } else {
                        layer.msg('请填写必填项');
                        return false;
                    }
                })
            },
            show_professional:function () {
                var _self=this
                var data={
                    command:'hr/querylevellist',//接口地址
                    sessionid:getCookie('sid'),
                    loginid:getCookie('uid'),
                    code:"title",
                };
                function callback(res){
                    _self.titlelist=res.levellist
                };
                post('/hr/querylevellist',data,callback,errcodefn,errfn)
            },
            show_educational:function () {
                var _self=this
                var data={
                    command:'hr/querylevellist',//接口地址
                    sessionid:getCookie('sid'),
                    loginid:getCookie('uid'),
                    code:"education",
                };
                function callback(res){
                    _self.educationlist=res.levellist
                };
                post('/hr/querylevellist',data,callback,errcodefn,errfn)
            },
            show_hospitallevel:function () {
                var _self=this
                var data={
                    command:'hr/querylevellist',//接口地址
                    sessionid:getCookie('sid'),
                    loginid:getCookie('uid'),
                    code:"hospital",
                };
                function callback(res){
                    _self.hospitallist=res.levellist
                };
                post('/hr/querylevellist',data,callback,errcodefn,errfn)
            },
            show_planlist:function () {
                var _self=this
                var data={
                    command:'trainingplan/querytrainingplanlist',//接口地址
                    sessionid:getCookie('sid'),
                    loginid:getCookie('uid'),
                    trainingstatus:'2',
                };
                function callback(res){
                    _self.planlist=res.list;
                };
            post('/trainingplan/querytrainingplanlist',data,callback,errcodefn,errfn)
            }
        }
    })
</script>
</html>