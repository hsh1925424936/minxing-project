<!DOCTYPE html>
<html>
	<head>
		<script type="text/javascript" src="../../js/layout.js" ></script>
		<meta charset="UTF-8">
		<title>重置密码</title>
		<style type="text/css">
			.topOuter{
				width:100%; height:150px; background-color:#EFF2F5;
			}
			.topContent{
				width:885px; height:100%; margin:0 auto;
			}
			.logoPng{
				width:170px; height:95px; display:block;
				float:left; margin-top:40px;
			}
			.titleOuter{
				width:350px; height:60px; float:left; 
				margin-left:10px; margin-top:52px;
			}
			.titleOuter span{
				width:100%;
				float:left; display:block;
			}
			.titleOuter .span1{
				height:40px; font-size:25px; 
				font-weight:bold; line-height:40px;
			}
			.titleOuter .span2{
				font-size:18px;
				line-height:30px;
			}
			.link{
				width:60px; height:18px; line-height:18px; 
				font-size:14px; color:#949494; float:left;
				margin-top:70px;
			}
			.link1{
				margin-left:130px;
			}
			.link2{
				margin-left:60px;
			}
			.loginOuter{
				width:400px; margin:90px auto;
			}
			.loginTitle{
				width:100%; height:30px; font-size:20px; line-height:30px;
			}

			.loginOuter input{
				height:50px; margin-top:30px; 
				border-radius:0px;
			}
			.inpOuter{
				position:relative;
			}
			.save{
				width:100%; height:50px; background-color:#3499DA; 
				border-radius:2px; font-size:16px; color:white;
				margin-top:20px;
			}
			
			.link a{
				outline:none; text-decoration:none; color:#949494;
			}
			.dynamicCode{
				position:absolute;right:5px; top:50%; margin-top:-20px;
				width:100px; height:40px; background-color:#999999; 
				font-size:14px; color:white;
			}

		</style>
		<script>
			window.onload = function () {
				'use strict';
				var timer = null;
				var bCode = false;

				if(!getCookie('gy_token') || !getCookie('gy_ttoken') || !getCookie('gy_uid')){
					window.location.href='login.html';
				}

				$('.dynamicCode').click(function () {
					if ($('.dynamicCode')[0].bClick) {
						return false;
					}
					var reg=/^1[3-578]\d{9}$/;
					if(!reg.test($.trim($('.phoneNum').val()))){
						uselayer(3,'请输入正确的手机号');
						return false;
					}
					$('.dynamicCode')[0].bClick = true;
					Api.R({
						url:'/usr/resetpasswordrequest',
						istoken:1,
						isShade:1,
						json:{
							"1":{
								command:'usr/resetpasswordrequest',
								accountname:getCookie('gy_u'),
								sessionid:getCookie('gy_t'),
								mobile:$.trim($('.phoneNum').val())
							}
						},
						fn:function (json) {
							console.log(json);
							if ( json[1].errcode != 0 ) {
								uselayer(1,json[1].errdesc);
								$('.dynamicCode')[0].bClick = false;
							} else {
								bCode = true;
								$('.phoneNum').attr('disabled','disabled');
								var num = 10;
								$('.dynamicCode').html(num+'秒');
								timer = setInterval(function () {
									num--;
									$('.dynamicCode').html(num+'秒');
									if (num<0) {
										clearInterval(timer);
										$('.dynamicCode')[0].bClick = false;
										$('.dynamicCode').html('重新发送');
									}
								},1000);						
							}
						}
					});				
				});

				$('.save').click(function(){
					
					if ($.trim($('.password').val())=='') {
						uselayer(3,'新密码不能为空');
						return false;					
					}					
					if ($.trim($('.password').val()).length<6) {
						uselayer(3,'密码长度不能少于6位');
						return false;					
					}

					if ($.trim($('.password').val())=='') {
						uselayer(3,'确认新密码不能为空');
						return false;					
					}

					if ($.trim($('.password').val()) != $.trim($('.confirmPassword').val())) {
						uselayer(3,'新密码和确认新密码不匹配');
						return false;					
					}

					if (!bCode) {
						uselayer(3,'请先获取动态码');
						return false;							
					}
					if ($.trim($('.code').val())=='') {
						uselayer(3,'请填写动态码');
						return false;					
					}
					$('.save').attr('disabled', 'disabled');
					Api.R({
						url:'/usr/resetpassword',
						istoken:1,
						isShade:1,
						json:{
							"1":{
								command:'usr/resetpassword',
								accountname:getCookie('gy_u'),
								sessionid:getCookie('gy_t'),
								verifycode:$.trim($('.code').val()),
								newpassword:$.trim($('.password').val())
							}
							
						},
						fn:function (json) {
							$('.save').removeAttr('disabled');
							if(json[1].errcode == 0){
								uselayer(3,'重置密码成功',function(){
									window.location.href='login.html';
								});
								
							}else{
								uselayer(3,'重置密码失败，请重新提交！');
								return false;
							}
						}
					});
				});
			};
			
		</script>
	</head>
	<body>
		<div class="topOuter clearfix">
			<div class="topContent">
				<img src="../../images/ostp/logo.png" class="logoPng"/>
				<div class="titleOuter clearfix">
					<span class="span1">欢迎来到临床技能中心</span>
					<span class="span2">四川大学华西临床医学院/华西医院</span>
				</div>

				<div class="link link1">
					<a href="#">关于助教</a>
				</div>

				<div class="link link2">
					<a href="#">下载中心</a>
				</div>

			</div>
		</div>

		<div class="loginOuter clearfix">
			<div class="loginTitle">
				重置密码
			</div>

			<input type="password" class="form-control password" placeholder="输入新密码" />
			<input type="password" class="form-control confirmPassword" placeholder="确认新密码" />

			<div class="inpOuter">
				<input type="text" class="form-control phoneNum" placeholder="请输入您的手机号" maxlength="18" />
				<button type="button" class="dynamicCode">
					获取动态码
				</button>
			</div>

			<input type="text" class="form-control code" placeholder="填写动态码" />
			<button type="button" class="save">
				保存
			</button>
			
		</div>
	</body>
</html>
