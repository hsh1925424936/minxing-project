<!DOCTYPE html>
<html>

<head>
	<script type="text/javascript" src="../../js/layout.js"></script>
	<script type="text/javascript" src="../../js/jqPaginator.js"></script>
	<!-- 先引入 Vue -->
	<script src="../../js/vue.js"></script>
	<!-- 引入组件库 -->
	<script src="../../js/element.js"></script>
	<meta charset="UTF-8">
	<title>理论考试(机试)</title>
	<link rel="stylesheet" type="text/css" href="../../css/ostp/person-center.css" />
	<link rel="stylesheet" type="text/css" href="../../css/ostp/my-subscribe-layer.css" class="commonCss" />
	<link rel="stylesheet" href="../../css/element.css">
	<style type="text/css">
		.rightOuter {
			position: relative;
			min-height: 750px;
		}

		.loginOuter {
			width: 400px;
			margin-top: 40px;
			margin-left: 45px;
		}

		.loginTitle {
			width: 100%;
			height: 30px;
			font-size: 20px;
			line-height: 30px;
			font-weight: bold;
			margin-bottom: 70px;
		}

		.selectOuter {
			padding-bottom: 19px;
			border-bottom: 1px solid #CCCCCC;
			margin-top: 45px;
			line-height: 34px;
		}

		.selectTxt {
			font-size: 16px;
			font-weight: bold;
		}

		.subscribe-train {
			width: 130px;
			float: right;
			border-radius: 3px;
			font-size: 14px;
			background-color: #169BD5;
			color: white;
			text-align: center;
		}

		.module {
			width: 100%;
			height: 55px;
			line-height: 55px;
			display: block;
			text-align: center;
		}

		.moduleOn {
			background-color: #ccc;
		}

		.subscribeOuter {
			width: 100%;
			border-bottom: 1px solid #CCCCCC;
		}

		.subscribeOuter .row {
			height: 30px;
		}

		.subscribelistTit {
			font-size: 14px;
			font-weight: bold;
		}

		.subscribelistTime {
			font-size: 10px;
			color: #B9C4CA;
		}

		.blue {
			color: #6699FF;
			padding-right: 40px;
		}

		.clear {
			width: 88px;
			height: 28px;
			color: white;
			cursor: pointer;
			border-radius: 15px;
			background-color: #B7C4CD;
			float: right;
			line-height: 28px;
			text-align: center;
		}

		.row1 {
			margin-bottom: 30px;
			margin-top: 20px;
		}

		.row2 {
			font-size: 14px;
			color: rgb(102, 102, 102);
			margin-bottom: 10px;
		}

		.fenyeCon {
			width: 700px;
			margin: auto;
			position: absolute;
			left: 120px;
			bottom: -10px;
		}

		.to-my-exam {
			color: #0497cb;
			cursor: pointer;
		}

		.exam-info {
			font-size: 16px;
			height: 80px;
			width: 100%;
			padding: 10px;
			line-height: 30px;
			border: 1px solid #cccccc;
			margin-top: 20px;
		}

		.exam-detail {
			position: relative;
			font-size: 16px;

			width: 100%;
			padding: 10px;
			line-height: 30px;
			border: 1px solid #cccccc;
			margin-top: 20px;
		}

		input[type=file] {
			display: none !important;
		}

		.upload-form-btn {
			position: absolute;
			bottom: 10px;
		}

		,
		.list {
			margin-top: 20px;
			margin-bottom: 0;
			padding: 0 30px 10px;
			font-size: 24px;
		}

		.list:nth-of-type(1) {
			padding-bottom: 0;
		}

		.score {
			width: 100%;
			height: 72px;
			line-height: 72px;
			text-align: right;
			margin: 0;
			/* padding:0 .3*100px; */
			font-size: 20px;
			color: #333333;
		}

		.list h2 {
			font-size: 20px;
			color: #333333;
			font-weight: normal;
			width: 100%;
			height: 72px;
			line-height: 72px;
			border-bottom: solid 1px rgb(230, 230, 230);
		}

		.cont {
			border-bottom: solid 1px rgb(230, 230, 230);
		}

		.cont:nth-last-of-type(1) {
			border: none;
		}

		.flex {
			display: flex;
			justify-content: flex-start;
			align-items: flex-start;
			padding: 20px 0;
		}

		.flex span {
			position: relative;
			top: 2px;
		}

		.cont div h3 {
			font-size: 18px;
			font-weight: normal;
			line-height: 1.6;
		}

		.cont ul {
			padding-left: 40px;
		}

		.cont ul li {
			margin-bottom: 20px;
			display: flex;
			align-items: center;
		}

		.flexBetween {
			width: 100%;
			display: flex;
			/* justify-content: flex-around; */
		}

		.flexBetween li {
			width: 50%;
		}

		.textarea {
			width: 100%;
			height: 150px;
			background: rgb(242, 242, 242);
			padding: 20px;
			/* margin-left:.4*100px; */
		}
		/* .textarea textarea{
        width:100%;
        height:1*100px;
    }  */

		.input {
			position: relative;
			top: 5px;
		}

		.checkbox {
			width: 21px;
			height: 21px;
			background-image: url('../../images/ostp/checkbox.png');
			border-radius: 0;
			position: relative;
			top: 2px;
			display: inline;
			margin: 0 20px 0 0!important;
		}

		.checkbox:checked {
			background-image: url(../../images/ostp/checkbox_on.png);
		}

		.radio {
			width: 25px;
			height: 25px;
			position: relative;
			box-shadow: #dfdfdf 0 0 0 0 inset;
			border-radius: 15px;
			border-top-left-radius: 15px;
			border-top-right-radius: 15px;
			border-bottom-left-radius: 15px;
			border-bottom-right-radius: 15px;
			background-clip: content-box;
			display: inline-block;
			-webkit-appearance: none;
			user-select: none;
			outline: none;
			background-image: url('../../images/ostp/cheak.png');
			background-size: cover;
			margin-right: 20px !important;
		}

		.radio:checked {
			background-image: url('../../images/ostp/cheak_on.png');
			background-size: cover;
		}

		.exam-info-val {

			overflow: hidden;
			text-overflow: ellipsis;
			white-space: nowrap;
		}

		.img {
			display: flex;
			flex-direction: column;
			width: 100%;
		}

		.img img {
			width: 100%;
			margin-bottom: .05rem;
			/* height: 100%; */
		}

		.img audio {
			width: 100%;
		}

		.img video {
			width: 100%;
		}
	</style>
	<script>
		//$('.bootstrap').rempxove();
	</script>
</head>

<body>
	<div id="app">
		<div class="topOuter">
			<div class="topCon clearfix">
				<a href="index.html" class="top2Con-index">
					<img src="../../images/ostp/logo.png" class="logoPng" />
					<div class="top2Tit">
						在线自主技能训练平台
					</div>
				</a>
				<div class="top1Tit-right">
					<img src="../../images/ostp/bell.png" class="bell" />
					<img src="../../images/ostp/redCircle.png" class="redCircle" />
					<img src="../../images/ostp/feifei.png" class="headImg" />
					<div class="nameAndYear clearfix">
						<div class="nameAndYearInner clearfix">
							<div class="userName"></div>
							<div class="year"></div>
							<span class="arrow"></span>
						</div>
						<ul class="selectUl"></ul>
					</div>
				</div>
			</div>
		</div>

		<div class="main clearfix">

			<div class="rightOuter clearfix">

				<div class="row selectOuter">
					<div class="selectTxt col-xs-4">
						<span class="to-my-exam" @click="toMyExam">
						我的考试
						</span>
						<span style="color:#e1eaf1">></span>
						<span>理论考试(机试)</span>
					</div>
					<div class="col-xs-6">
						<!-- 点击跳转到预约训练页面 -->
						<!-- <a href="subscribe-train.html">
							<button class="subscribe-train">预约新训练</button>
						</a> -->

					</div>
					<div class="col-xs-2">

					</div>
				</div>

				<div class="exam-info">
					<div class="col-xs-4 exam-info-val"><span>考试名称：</span><span>{{testname}}</span></div>
					<div class="col-xs-4 exam-info-val"><span>考试类型：</span><span>{{model}}</span></div>
					<div class="col-xs-4 exam-info-val"><span>课程名称：</span><span>{{coursename}}</span></div>
					<div class="col-xs-4 exam-info-val"><span>发布时间：</span><span>{{createtime}}</span></div>
					<div class="col-xs-4 exam-info-val"><span>截止时间：</span><span>{{endtime}}</span></div>
				</div>
				<div class="exam-detail">
					<div class="g-main">
						<div class="list">
							<p class="score">满分：<span>{{totalScore}}</span>分</p>
						</div>
						<div class="list" v-for="(item,index) in testContent">
							<h2>{{index+1}}、{{item.title}}（共{{item.totalnum}}道题，每题{{item.score}}分）</h2>
							<div class="cont" v-for="(cont,key) in item.cont">

								<div class="flex">
									<span>{{key+1}}、</span>
									<h3>{{cont.questionbasename}}</h3>
								</div>
								<div v-if="cont.picturelist && cont.picturelist.length != 0" class="img">
									<img :src="img.filepath" alt="" v-for="img in cont.picturelist" v-if="ispicture(img.filepath)">
									<audio :src="img.filepath" muted="true" v-for="img in cont.picturelist" controls v-if="isaudio(img.filepath)">
									</audio>
									<video :src="img.filepath" controls v-for="img in cont.picturelist" v-if="isvideo(img.filepath)">
									</video>
								</div>
								<!-- <textarea v-if="item.type == 3" class="textarea"></textarea> -->
								<ul v-if="item.title == '单选题'">
									<li v-for="ans in cont.questionitem">
										<label>
				                                <input type="radio" class="radio input" :name="index*10+key" @click="select(cont,item,ans)"><span v-if="ans.itemname">{{ans.itemname}}、</span>{{ans.content}}
				                            </label>
									</li>
								</ul>
								<ul v-if="item.title == '多选题'">
									<li v-for="ans in cont.questionitem">
										<label>
				                                <input type="checkbox" class="checkbox" @click="select(cont,item,ans)"><span v-if="ans.itemname">{{ans.itemname}}、</span>{{ans.content}}
				                            </label>
									</li>
								</ul>
								<ul v-if="item.title == '判断题'" class="flexBetween">
									<li>
										<label>
				                                <input type="radio" :name="index*10+key" class="radio input" @click="select(0,cont)">正确
				                            </label>
									</li>
									<li>
										<label>
				                                <input type="radio" :name="index*10+key" class="radio input" @click="select(1,cont)">错误
				                            </label>

									</li>
								</ul>
							</div>
						</div>
						<div>
							<el-button style="background-color: #0497cb;margin-left:350px" type='primary' @click="submit">提交</el-button>
						</div>
					</div>
				</div>
			</div>
		</div>

	</div>
	</div>
</body>

<script type="text/javascript">
	new Vue({
		el: '#app',
		data: function () {
			return {
				testname: '',
				testContent: [

				],
				questionlist: [],
				totalScore: 0,
				checkedNum: 0,
				createtime: '',
				endtime: '',
				model: '',
				coursename: '',
				answer: '',
			}
		},
		mounted() {
			this.testname = decodeURIComponent(GetQueryString('testname'));
			this.coursename = decodeURIComponent(GetQueryString('coursename'));
			this.createtime = timetodate(GetQueryString('createtime') / 1000);
			this.endtime = decodeURIComponent(GetQueryString('endtime'));
			this.model = GetQueryString('model') == 0 ? '理论笔试' : (GetQueryString('model') == 1 ? '理论机试' : '操作考试');
			this.queryPaperCategoryList()
			this.queryViewPaper()
			console.log(this.testContent)
		},
		methods: {
			toMyExam() {
				window.location.href = './my-exam.html'
			},
			ispicture(name) {//判断是否图片
				var arr = name.split(".");
				var format = arr[arr.length - 1].toLowerCase();
				if (format == 'png' || format == 'bmp' || format == 'gif' || format == 'jpg' || format == 'jpeg') {
					return true;
				} else {
					return false;
				}
			},
			isvideo(name) {//判断是否视频
				var arr = name.split(".");
				var format = arr[arr.length - 1].toLowerCase();
				if (format == 'mp4') {
					return true;
				} else {
					return false;
				}
			},
			isaudio(name) {//判断是否音频
				var arr = name.split(".");
				var format = arr[arr.length - 1].toLowerCase();
				if (format == 'mp3') {
					return true;
				} else {
					return false;
				}
			},
			queryViewPaper() {
				let self = this;
				var json = {
					"1": {
						command: 'exampaper/viewpaper',

						sessionid: getCookie('gy_t'),
						loginid: getCookie('gy_u'),
						paperid: GetQueryString('paperid')
					}
				};
				Api.R({
					url: "/exampaper/viewpaper",
					isShade: 1,
					json: json,
					fn: function (json) {
						if (json["1"].errcode != 0) {
							uselayer(3, json["1"].errdesc);
							return;
						}
						self.totalScore = json["1"].paperinfo.score
					}
				})
			},
			queryPaperCategoryList() {
				let self = this;
				var json = {
					"1": {
						command: 'exampaper/querypapercategorylist',

						sessionid: getCookie('gy_t'),
						loginid: getCookie('gy_u'),
						paperid: GetQueryString('paperid')
					}
				};
				Api.R({
					url: "/exampaper/querypapercategorylist",
					isShade: 1,
					json: json,
					fn: function (json) {
						if (json["1"].errcode != 0) {
							uselayer(3, json["1"].errdesc);
							return;
						}
						if (json["1"] && json["1"].categoryList.length != 0) {
							json["1"].categoryList.map((item) => {
								self.testContent.push({
									cateid: item.cateid,
									title: item.nickname,
									id: item.id,
									paperid: item.paperid,
									totalnum: item.totalnum,
									totalscore: item.totalscore,
									score: item.score,
									cont: [],
									priority: item.priority,
								})
								self.queryPaperQuestion(item.id, item.cateid)
							})
							self.testContent.sort(self.sort)
						}
					}
				})

			},
			sort(a, b) {
				return a.priority - b.priority;
			},
			queryPaperQuestion(mainid, cateid) {
				let self = this
				var json = {
					"1": {
						command: 'exampaper/querypaperquestion',

						sessionid: getCookie('gy_t'),
						loginid: getCookie('gy_u'),
						paperid: GetQueryString('paperid'),
						mainid: mainid,
						cateid: cateid
					}
				};
				Api.R({
					url: "/exampaper/querypaperquestion",
					isShade: 1,
					json: json,
					fn: function (json) {
						if (json["1"].errcode != 0) {
							uselayer(3, json["1"].errdesc);
							return;
						}
						if (json['1'] && json['1'].questionlist.length != 0) {
							self.testContent.map((item) => {
								// if(json['1'].questionlist[0].mainid == item.id){
								//     item.cont = json['1'].questionlit
								// }
								json['1'].questionlist.map((item1) => {
									if (item1.mainid == item.id) {
										item.cont.push(item1)
									}
								})
							})
						}
					}
				})

			},
			select(key, item, ans) {
				// alert(key)
				// console.log(item)
				// alert('aaa')
				if (key == 0 || key == 1) {
					if (typeof item.checked == 'undefined') {
						this.$set(item, 'checked', true)
					}
					item.answer = key
				} else if (item.cateid == 1) {
					key.questionitem.map(item1=>{
                        delete item1.checked
                    })
					if (typeof ans.checked == 'undefined') {
						this.$set(ans, 'checked', true)
						this.$set(item, 'checked', true)
					}
					key.answer = ans.itemname

				} else if (item.cateid == 2) {
					if (typeof ans.checked == 'undefined') {
						this.$set(ans, 'checked', true)
						this.$set(item, 'checked', true)
					} else {
						delete ans.checked
					}
				}
			},
			submit() {
                /*if(new Date(this.endtime).getTime()<new Date().getTime()){
                    uselayer(3, '考试已经截止，无法提交！');
                    return;
                }*/
				let self = this
				this.questionlist = []
				this.checkedNum = 0
				this.answer = ''
				this.testContent.map((item) => {
					if (item.cateid == 4) {
						item.cont.map((item1) => {
							if (item1.checked) {
								this.questionlist.push({
									cateid: item.cateid,
									questionbaseid: item1.questionbaseid,
									answer: item1.answer,
									score: item1.score
								})
							}
						})
					} else if (item.cateid == 1) {
						item.cont.map((item2) => {
							item2.questionitem.map((item3) => {
								if (item3.checked) {
									this.questionlist.push({
										cateid: item.cateid,
										questionbaseid: item2.questionbaseid,
										answer: item2.answer,
										score: item2.score
									})
									this.$set(item2, 'checked', true)
								}
							})
						})
					} else if (item.cateid == 2) {
						item.cont.map((item4) => {
							this.answer = ""
							item4.questionitem.map((item5) => {
								if (item5.checked) {
									this.answer += item5.itemname
									this.$set(item4, 'checked', true)
								}
							})
							this.questionlist.push({
								cateid: item.cateid,
								questionbaseid: item4.questionbaseid,
								answer: self.answer,
								score: item4.score
							})
						})
					}
				})
				this.testContent.map((item) => {
					item.cont.map((item1) => {
						if (!item1.checked) {
							this.checkedNum++
						}
					})
				})
				// alert(this.checkedNum)
				if (this.checkedNum != 0) {
					uselayer(3, '还有' + this.checkedNum + '道题，没有做！');
					//this.toast('还有'+this.checkedNum+'道题，没有做！')
				} else {
					var json = {
						"1": {
							command: 'unifyexam/submittest',
							uid: getCookie('gy_u'),
							sessionid: getCookie('gy_t'),
							loginid: getCookie('gy_u'),
							paperid: GetQueryString('paperid'),
							questionlist: self.questionlist,
							examid: GetQueryString('id'),
							uploadpath: '',
						}
					};
					Api.R({
						url: "/unifyexam/submittest",
						isShade: 1,
						json: json,
						fn: function (json) {
							if (json["1"].errcode != 0) {
								uselayer(3, json["1"].errdesc);
								return;
							}
							uselayer(4, '提交成功', self.toMyExam)
						}
					})

				}
			}
		}
	})
	function fenye(allcount, page) {//分页的方法
		var totalPages = Math.ceil(allcount / 4);
		var type2 = $('.ordertype').val();
		$.jqPaginator('#pagination1', {//分页
			totalPages: totalPages,
			visiblePages: 10,
			currentPage: page,
			first: '<li class="first"><a href="javascript:void(0);">首页</a></li>',
			prev: '<li class="prev"><a href="javascript:void(0);"><i class="_arrow arrow2"></i>上一页</a></li>',
			next: '<li class="next"><a href="javascript:void(0);">下一页<i class="_arrow arrow3"></i></a></li>',
			last: '<li class="last"><a href="javascript:void(0);">末页</a></li>',
			page: '<li class="page"><a href="javascript:void(0);">{{page}}</a></li>',
			onPageChange: function (num, type) {
				if (type == 'change') {
					getapplaylist(type2, num);//type2为下拉列表的类型
				}

			}
		});
	}

	function getapplaylist(status, page) {
		var pagecount = 4;
		var json = {
			"1": {
				command: "test/querytestlist",
				uid: getCookie('gy_u'),
				sessionid: getCookie('gy_t'),
				loginid: getCookie('gy_u'),
				page: page,
				reqnum: pagecount,
				answermode: 0
			}
		};
		if (status != 4) {
			json[1].status = status;
		}
		Api.R({
			url: "/learn/querybookedlist",
			isShade: 1,
			json: json,
			fn: function (json) {
				if (json["1"].errcode != 0) {
					uselayer(3, json["1"].errdesc);
					return;
				}
				var arr = json["1"].testlist;
				if (arr.length == 0) {
					$('.subscribeOuter-list').html('<p class="no-data">暂无考试</p>');
					$('.fenyeCon').css('display', 'none');
					return false;
				}
				$('.subscribeOuter-list').html('');
				for (var i = 0; i < arr.length; i++) {
					var _clear = '待考试';

					var oDate = new Date();
					//获取当前时间并转为时间戳
					oDate = oDate.getTime().toString().substr(0, 10);
					if (oDate - datetotime(arr[i].endtime) > 0) {
						_clear = "已过期";
					}
					var str =
						'<div class="subscribeOuter clearfix" status="' + arr[i].status + '">'
						+ '<div class="row row1">'
						+ '<div class="col-xs-4 subscribelistTit">' + arr[i].testname + '</div>'
						+ '<div class="col-xs-4">'
						+ '</div>'
						+ '<div class="col-xs-4 right subscribelistTime">' + timetodate(datetotime(arr[i].starttime)) + '-' + timetodate(datetotime(arr[i].endtime), 2) + '</div>'
						+ '</div>'
						+ '<div class="row row2">';

					if (arr[i].model == 0) {
						str +=
							'<div class="col-xs-4">考试形式：理论笔试</div>';
					} else if (arr[i].model == 1) {
						str +=
							'<div class="col-xs-4">考试形式：理论机试</div>';
					} else {
						str +=
							'<div class="col-xs-4">考试形式：操作考试</div>';
					}


					str +=
						'<div class="col-xs-4">课程：' + arr[i].coursename + '</div>'
						+ '<div class="col-xs-4">老师：' + arr[i].teacher + '</div>'
						+ '<div class="col-xs-4 blue right">' + _clear + '</div>'
						+ '</div>'
						+ '<div class="row row2">'
						+ '<div class="col-xs-4">总分：' + arr[i].score + '</div>'
						+ '<div class="col-xs-4">'
						+ '<div class="clear" _id="' + arr[i].applystudentid + '" style="display:' + (oDate - datetotime(arr[i].endtime) < 0 && arr[i].status == 0 ? 'block' : 'none') + ';">点击进入</div>'
						+ '</div>'
						+ '</div>'
						+ '</div>';

					$('.subscribeOuter-list').append(str);
				}
				$('.clear').click(function () {
					var oId = $(this).attr('_id');

					/*uselayer(2,'确定要取消预约吗？',function () {
						Api.applayCancel({
							json:{
								id:oId
							},
							fn:function (json) {
								console.log(json);
								uselayer(3,json.message);
								getapplaylist();
							}
						});
					})*/

					subscribeLayer('确定要取消预约吗？', function () {
						Api.R({
							url: "/learn/deletebookedlist",
							isShade: 1,
							json: {
								"1": {
									command: "learn/deletebookedlist",
									sessionid: getCookie('gy_t'),
									uid: getCookie('gy_u'),
									loginid: getCookie('gy_u'),
									applystudentid: oId
								}
							},
							fn: function (json) {
								if (json["1"].errcode != 0) {
									uselayer(3, json["1"].errdesc);
									return;
								}
								uselayer(3, '预约已被取消!');
								getapplaylist();
							}
						});
					});


				});
				var allcount = json["1"]['allcount'];
				fenye(allcount, page);//生成分页
			}
		});
	};

	window.onload = function () {
		'use strict';
		common();


	};
</script>

</html>