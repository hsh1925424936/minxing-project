<!DOCTYPE html>
<html>
	<head>
		<script type="text/javascript" src="../../js/layout.js" ></script>
		<script type="text/javascript" src="../../js/jqPaginator.js"></script>
		<meta charset="UTF-8">
		<title>我的预约</title>
		<link rel="stylesheet" type="text/css" href="../../css/ostp/person-center.css"/>
		<link rel="stylesheet" type="text/css" href="../../css/ostp/my-subscribe-layer.css" class="commonCss"/>
		<style type="text/css">
			.rightOuter{
				position:relative; min-height:750px;
			}

			.loginOuter{
				width:400px; margin-top:40px; margin-left:45px;
			}
			.loginTitle{
				width:100%; height:30px; font-size:20px; line-height:30px;
				font-weight:bold; margin-bottom:70px;
			}

			.selectOuter{
				padding-bottom:19px; border-bottom:1px solid #CCCCCC;
				margin-top:45px; line-height:34px;
			}
			.selectTxt{
				font-size:16px; font-weight:bold;
			}
			.subscribe-train{
				width:130px; float:right; border-radius:3px; font-size:14px;
				background-color:#169BD5; color:white; text-align:center;
			}

			.module{
				width:100%; height:55px; line-height:55px; display:block;
				text-align:center;
			}
			.moduleOn{
				background-color:#ccc;
			}
			.subscribeOuter{
				width:100%; border-bottom:1px solid #CCCCCC;
			}
			.subscribeOuter .row{
				height:30px;
			}
			.subscribelistTit{
				font-size:14px; font-weight:bold;
			}
			.subscribelistTime{
				font-size:10px; color:#B9C4CA;
			}
			.blue{
				color:#6699FF; padding-right:40px;
			}
			.clear{
				width:88px; height:28px; color:white; cursor: pointer;
				border-radius:15px; background-color:#B7C4CD;
				float:right; line-height:28px; text-align:center;
			}
			.row1{
				margin-bottom:30px; margin-top:20px;
			}
			.row2{
				font-size:14px; color:rgb(102,102,102);
				margin-bottom:10px;
			}

			.fenyeCon{
				width:700px; margin:auto; position:absolute;
				left:120px; bottom:-10px;
			}

		</style>
		<script>
			//$('.bootstrap').remove();
		</script>
	</head>
	<body>
		<div class="topOuter">
			<div class="topCon clearfix">
				<a href="index.html" class="top2Con-index">
					<img src="../../images/ostp/logo.png" class="logoPng" />
					<div class="top2Tit">
						在线自主技能训练平台
					</div>					
				</a>
				<div class="top1Tit-right">
					<img src="../../images/ostp/bell.png" class="bell" />
					<img src="../../images/ostp/redCircle.png" class="redCircle" />
					<img src="../../images/ostp/feifei.png" class="headImg" />
					<div class="nameAndYear clearfix">
						<div class="nameAndYearInner clearfix">
							<div class="userName"></div>
							<div class="year"></div>
							<span class="arrow"></span>
						</div>
						<ul class="selectUl"></ul>
					</div>
				</div>
			</div>
		</div>

		<div class="main clearfix">
			<div class="leftOuter">


			</div>

			<div class="rightOuter clearfix">
				
				<div class="row selectOuter">
					<div class="selectTxt col-xs-4">
						我的预约
					</div>
					<div class="col-xs-6">
						<!-- 点击跳转到预约训练页面 -->
						<!-- <a href="subscribe-train.html">
							<button class="subscribe-train">预约新训练</button>
						</a> -->
						
					</div>
					<div class="col-xs-2">
						<select class="form-control ordertype">
						<!-- 预约状态0=申请，1=成功，2=失败，3=已取消 -->
							<option value='4'>全部</option>
							<option value='0'>已申请</option>
							<option value='1'>已训练</option>
							<option value='2'>未完成</option>
							<option value='3'>已取消</option>
						</select>
					</div>
				</div>
				
				<div class="subscribeOuter-list">

	

				</div>
				<div class="fenyeCon">
					<ul class="pagination" id="pagination1"></ul>
				</div>
			</div>

		</div>

	</body>
	
	<script type="text/javascript">
		function fenye(allcount,page){//分页的方法
			var totalPages =  Math.ceil(allcount/4);
			var type2 = $('.ordertype').val();
			$.jqPaginator('#pagination1', {//分页
		        totalPages:totalPages,
	            visiblePages: 10,
	            currentPage: page,
	            first: '<li class="first"><a href="javascript:void(0);">首页</a></li>',
	            prev: '<li class="prev"><a href="javascript:void(0);"><i class="_arrow arrow2"></i>上一页</a></li>',
	            next: '<li class="next"><a href="javascript:void(0);">下一页<i class="_arrow arrow3"></i></a></li>',
	            last: '<li class="last"><a href="javascript:void(0);">末页</a></li>',
	            page: '<li class="page"><a href="javascript:void(0);">{{page}}</a></li>',
		        onPageChange: function (num, type) {
		        	if(type == 'change'){
		        		getapplaylist(type2,num);//type2为下拉列表的类型
		        	}
		            
		        }
		    });
		}

		function getapplaylist(status,page) {
			var pagecount = 4;
			var json = {
				"1": {
					command: "learn/querybookedlist",
					uid: getCookie('gy_u'),
					sessionid: getCookie('gy_t'),
					loginid: getCookie('gy_u'),
					page:page,
					reqnum:pagecount
				}
			};
			if ( status != 4 ){
				json[1].status = status;
			}
			Api.R({
				url: "/learn/querybookedlist",
				isShade:1,
				json:json,
				fn:function (json) {
					if(json["1"].errcode != 0){
						uselayer(3, json["1"].errdesc);
						return;
					}
					var arr = json["1"].learnids;
					if (arr.length ==0 ) {
						$('.subscribeOuter-list').html('<p class="no-data">暂无预约</p>');
						$('.fenyeCon').css('display', 'none');
						return false;
					}
					$('.subscribeOuter-list').html('');
					for (var i = 0 ; i < arr.length; i++) {
						var _clear ='申请中';
						switch (arr[i].status){
							case 0:_clear ='预约成功';
								break;
							case 1:_clear ='已训练';
								break;
							case 2:_clear ='未完成';
								break;
							case 3:_clear ='已取消';
								break;
						}
						var oDate = new Date();
						//获取当前时间并转为时间戳
						oDate = oDate.getTime().toString().substr(0,10);
						var str = 
							'<div class="subscribeOuter clearfix" status="'+arr[i].status+'">'
								+'<div class="row row1">'
									+'<div class="col-xs-4 subscribelistTit">'+arr[i].name+'技能训练操作</div>'
									+'<div class="col-xs-4">'
									+'</div>'
									+'<div class="col-xs-4 right subscribelistTime">'+arr[i].createdat+'</div>'
								+'</div>'
								+'<div class="row row2">';

								if( arr[i].learntype == 0 ){
									str +=
									'<div class="col-xs-4">训练形式：在线训练</div>';
								}else if( arr[i].learntype == 1 ){
									str +=
									'<div class="col-xs-4">训练形式：模型人训练</div>';
								}else {
									str +=
									'<div class="col-xs-4">训练形式：智能训练</div>';
								}
								

								str +=
									'<div class="col-xs-4">预约时间：'+timetodate(datetotime(arr[i].startdt))+'-'+timetodate(datetotime(arr[i].enddt),2)+'</div>'
									+'<div class="col-xs-4 blue right">'+_clear+'</div>'
								+'</div>'
								+'<div class="row row2">'
									+'<div class="col-xs-4">训练地点：'+arr[i].roomnum+'室</div>'
									+'<div class="col-xs-4">'
										+'<div class="clear" _id="'+arr[i].applystudentid+'" style="display:'+(oDate-datetotime(arr[i].enddt)<0&&arr[i].status==0?'block':'none')+';">取消预约</div>'
									+'</div>'
								+'</div>'
							+'</div>';			
							
						$('.subscribeOuter-list').append(str);
					}
					$('.clear').click(function () {
						var oId = $(this).attr('_id');

						/*uselayer(2,'确定要取消预约吗？',function () {
							Api.applayCancel({
								json:{
									id:oId
								},
								fn:function (json) {
									console.log(json);
									uselayer(3,json.message);
									getapplaylist();
								}
							});
						})*/

						subscribeLayer('确定要取消预约吗？',function () {
							Api.R({
								url: "/learn/deletebookedlist",
								isShade: 1,
								json:{
									"1": {
										command: "learn/deletebookedlist",
										sessionid: getCookie('gy_t'),
										uid: getCookie('gy_u'),
										loginid: getCookie('gy_u'),
										applystudentid: oId
									}
								},
								fn:function (json) {
									if(json["1"].errcode != 0){
										uselayer(3,json["1"].errdesc);
										return;
									}
									uselayer(3,'预约已被取消!');
									getapplaylist();
								}
							});
						});


					});
					var allcount = json["1"]['allcount'];
					fenye(allcount,page);//生成分页
				}
			});				
		};

		window.onload = function () {
			'use strict';
			common();
			showpersoncenter('我的预约');
			$('.ordertype').change(function () {//我的预约列表筛选
				var status = $('.ordertype').val();
				getapplaylist(status,1);
			});
			getapplaylist(4,1);//status是4时查全部
		};
		

	</script>

</html>
