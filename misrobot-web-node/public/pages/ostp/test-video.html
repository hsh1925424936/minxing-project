<!DOCTYPE html>
<html>
	<head>
		<script type="text/javascript" src="../../js/layout.js" ></script>
		<script type="text/javascript" src="../../js/jqPaginator.js"></script>
		 <!-- 先引入 Vue -->
		  <script src="../../js/vue.js"></script>
		  <!-- 引入组件库 -->
		  <script src="../../js/element.js"></script>
		<meta charset="UTF-8">
		<title>视频上传</title>
		<link rel="stylesheet" type="text/css" href="../../css/ostp/person-center.css"/>
		<link rel="stylesheet" type="text/css" href="../../css/ostp/my-subscribe-layer.css" class="commonCss"/>
		<link rel="stylesheet" href="../../css/element.css">
		<style type="text/css">
			.rightOuter{
				position:relative; min-height:750px;
			}

			.loginOuter{
				width:400px; margin-top:40px; margin-left:45px;
			}
			.loginTitle{
				width:100%; height:30px; font-size:20px; line-height:30px;
				font-weight:bold; margin-bottom:70px;
			}

			.selectOuter{
				padding-bottom:19px; border-bottom:1px solid #CCCCCC;
				margin-top:45px; line-height:34px;
			}
			.selectTxt{
				font-size:16px; font-weight:bold;
			}
			.subscribe-train{
				width:130px; float:right; border-radius:3px; font-size:14px;
				background-color:#169BD5; color:white; text-align:center;
			}

			.module{
				width:100%; height:55px; line-height:55px; display:block;
				text-align:center;
			}
			.moduleOn{
				background-color:#ccc;
			}
			.subscribeOuter{
				width:100%; border-bottom:1px solid #CCCCCC;
			}
			.subscribeOuter .row{
				height:30px;
			}
			.subscribelistTit{
				font-size:14px; font-weight:bold;
			}
			.subscribelistTime{
				font-size:10px; color:#B9C4CA;
			}
			.blue{
				color:#6699FF; padding-right:40px;
			}
			.clear{
				width:88px; height:28px; color:white; cursor: pointer;
				border-radius:15px; background-color:#B7C4CD;
				float:right; line-height:28px; text-align:center;
			}
			.row1{
				margin-bottom:30px; margin-top:20px;
			}
			.row2{
				font-size:14px; color:rgb(102,102,102);
				margin-bottom:10px;
			}

			.fenyeCon{
				width:700px; margin:auto; position:absolute;
				left:120px; bottom:-10px;
			}
			.to-my-exam{
				color:#0497cb;
				cursor:pointer;
			}
			.exam-info{
				font-size:16px;
				height:80px;
				width:100%;
				padding:10px;
				line-height: 30px;
				border:1px solid  #cccccc;
				margin-top:20px;
			}
			.upload-form{
				position: relative;
				font-size:16px;
				height:280px;
				width:100%;
				padding:10px;
				line-height: 30px;
				border:1px solid  #cccccc;
				margin-top:20px;
			}
			input[type=file]{
				display: none !important;
			}
			.upload-form-btn{
				position: absolute;
				bottom:10px;

			}
			.exam-info-val{
				font-size: 14px;
				overflow: hidden;
				text-overflow: ellipsis;
				white-space: nowrap;

		    }
		</style>
		<script>
			//$('.bootstrap').remove();
		</script>
	</head>
	<body>
	<div id = "app">
		<div class="topOuter">
			<div class="topCon clearfix">
				<a href="index.html" class="top2Con-index">
					<img src="../../images/ostp/logo.png" class="logoPng" />
					<div class="top2Tit">
						在线自主技能训练平台
					</div>
				</a>
				<div class="top1Tit-right">
					<img src="../../images/ostp/bell.png" class="bell" />
					<img src="../../images/ostp/redCircle.png" class="redCircle" />
					<img src="../../images/ostp/feifei.png" class="headImg" />
					<div class="nameAndYear clearfix">
						<div class="nameAndYearInner clearfix">
							<div class="userName"></div>
							<div class="year"></div>
							<span class="arrow"></span>
						</div>
						<ul class="selectUl"></ul>
					</div>
				</div>
			</div>
		</div>

		<div class="main clearfix">

			<div class="rightOuter clearfix">

				<div class="row selectOuter">
					<div class="selectTxt col-xs-4">
						<span class ="to-my-exam" @click = "toMyExam">
						我的考试
						</span>
						<span style = "color:#e1eaf1">></span>
						<span>视频上传</span>
					</div>
					<div class="col-xs-6">
						<!-- 点击跳转到预约训练页面 -->
						<!-- <a href="subscribe-train.html">
							<button class="subscribe-train">预约新训练</button>
						</a> -->

					</div>
					<div class="col-xs-2">

					</div>
				</div>

				<div class="exam-info">
					<div class="col-xs-4 exam-info-val"><span>题目名称：</span><span>{{questionname}}</span></div>
					<div class="col-xs-4 exam-info-val"><span>考试类型：</span><span>操作考试</span></div>
					<div class="col-xs-4 exam-info-val"><span>考试名称：</span><span>{{examname}}</span></div>
					<div class="col-xs-4 exam-info-val"><span>发布时间：</span><span>{{starttime}}</span></div>
					<div class="col-xs-4 exam-info-val"><span>截止时间：</span><span>{{endtime}}</span></div>
				</div>
				<div class = "upload-form">
					<div style = "margin:20px 0;">上传视频</div>
					<el-upload
					  class="upload-demo"
					  action="/file/upload"
					  :before-upload = 'checkFile'
					  :on-change="handleChange"
					  :on-success = "handleSuccess"
					  :on-error = "handleError"
					  :on-remove="handleRemove"
					  >
					  <el-button style="background-color: #0497cb;" size="small" type="primary">点击上传</el-button>
					  <div slot="tip" class="el-upload__tip">支持mp4，avi的格式上传，文件大小不超过300M</div>
					</el-upload>
					<div class = "upload-form-btn">
					<el-button style="margin-left: 340px;background-color: #0497cb;" type = "primary" @click = "submitVideo">提交</el-button>
					</div>
				</div>
			</div>

		</div>
	</div>
	</body>

	<script type="text/javascript">
		new Vue({
	      el: '#app',
	      data: function() {
	        return {
	        	visible: false,
	        	path:'',
	        	id:'',
	        	examid:'',
	        	paperid:'',
	        	questionid:'',
	        	examname:'',
	        	questionname:'',
	        	starttime:'',
	        	endtime:'',
	        }
	      },
	      mounted(){
	      	this.id = GetQueryString('id');
	      	this.examid = GetQueryString('examid');
	      	this.paperid = GetQueryString('paperid');
	      	this.questionid = GetQueryString('questionid');
	      	this.examname = decodeURIComponent(GetQueryString('examname'));
	      	this.questionname = decodeURIComponent(GetQueryString('questionname'));
	      	this.starttime = decodeURIComponent(GetQueryString('starttime'));
	      	this.endtime = decodeURIComponent(GetQueryString('endtime'));
	      },
	      methods:{
	      	toMyExam(){
	      		window.location.href = './my-exam.html'
	      	},
	      	handleSuccess(res,file,list){
	      		console.log(res)
	      		this.path = res.data.uri;

	      	},
	      	handleError(){
	      		this.$message.error('上传失败，请稍后重试 ')
	      	},
	      	checkFile(file) {
                console.log(file)
		    	console.log(file.type)
                console.log(file.size)
		        const isMov = (file.type === 'video/mp4')||(file.type === 'video/avi');
                const big = file.size/1024/1024<300;
		        if (!isMov) {
		          this.$message.error('请上传.mp4或.avi格式的视频文件！');
		        }
                if(!big){
                    this.$message.error('请上传小于300M的视频')
                }

		        return isMov&&big;
		    },
		    handleRemove(){
		    	this.path='';
		    },
	      	handleChange(file,list){

		    	if(list.length>1){
		    		list.shift();
		    	}

		    },
		    submitVideo(){
                /*if(new Date(this.endtime).getTime()<new Date().getTime()){
                    uselayer(3, '考试已经截止，无法提交！');
                    return;
                }*/
                if(this.path==''){
                	uselayer(3, '请先上传视频，再提交');
                    return;
                }
		    	var self = this;
		    	var json = {
					"1": {
						"command": "unifyexam/answerquestion",
						sessionid: getCookie('gy_t'),
						loginid: getCookie('gy_u'),
						id:this.id,
						"paperid":this.paperid,
						"examid":this.examid,
						"questionid":this.questionid,
						"stuid":getCookie('gy_u'),
						"path":this.path
					}
				};
		    	Api.R({
					url: "/unifyexam/answerquestion",
					isShade:1,
					json:json,
					fn:function (json) {
						if(json["1"].errcode != 0){
							uselayer(3, json["1"].errdesc);
							return;
						}
						uselayer(4,'提交成功',self.toMyExam)
					}
				});
		    }
	      }
    	})
		function fenye(allcount,page){//分页的方法
			var totalPages =  Math.ceil(allcount/4);
			var type2 = $('.ordertype').val();
			$.jqPaginator('#pagination1', {//分页
		        totalPages:totalPages,
	            visiblePages: 10,
	            currentPage: page,
	            first: '<li class="first"><a href="javascript:void(0);">首页</a></li>',
	            prev: '<li class="prev"><a href="javascript:void(0);"><i class="_arrow arrow2"></i>上一页</a></li>',
	            next: '<li class="next"><a href="javascript:void(0);">下一页<i class="_arrow arrow3"></i></a></li>',
	            last: '<li class="last"><a href="javascript:void(0);">末页</a></li>',
	            page: '<li class="page"><a href="javascript:void(0);">{{page}}</a></li>',
		        onPageChange: function (num, type) {
		        	if(type == 'change'){
		        		getapplaylist(type2,num);//type2为下拉列表的类型
		        	}

		        }
		    });
		}

		function getapplaylist(status,page) {
			var pagecount = 4;
			var json = {
				"1": {
					command: "test/querytestlist",
					uid: getCookie('gy_u'),
					sessionid: getCookie('gy_t'),
					loginid: getCookie('gy_u'),
					page:page,
					reqnum:pagecount,
					answermode:0
				}
			};
			if ( status != 4 ){
				json[1].status = status;
			}
			Api.R({
				url: "/learn/querybookedlist",
				isShade:1,
				json:json,
				fn:function (json) {
					if(json["1"].errcode != 0){
						uselayer(3, json["1"].errdesc);
						return;
					}
					var arr = json["1"].testlist;
					if (arr.length ==0 ) {
						$('.subscribeOuter-list').html('<p class="no-data">暂无考试</p>');
						$('.fenyeCon').css('display', 'none');
						return false;
					}
					$('.subscribeOuter-list').html('');
					for (var i = 0 ; i < arr.length; i++) {
						var _clear ='待考试';

						var oDate = new Date();
						//获取当前时间并转为时间戳
						oDate = oDate.getTime().toString().substr(0,10);
						if(oDate-datetotime(arr[i].endtime)>0){
							_clear = "已过期";
						}
						var str =
							'<div class="subscribeOuter clearfix" status="'+arr[i].status+'">'
								+'<div class="row row1">'
									+'<div class="col-xs-4 subscribelistTit">'+arr[i].testname+'</div>'
									+'<div class="col-xs-4">'
									+'</div>'
									+'<div class="col-xs-4 right subscribelistTime">'+timetodate(datetotime(arr[i].starttime))+'-'+timetodate(datetotime(arr[i].endtime),2)+'</div>'
								+'</div>'
								+'<div class="row row2">';

								if( arr[i].model == 0 ){
									str +=
									'<div class="col-xs-4">考试形式：理论笔试</div>';
								}else if( arr[i].model == 1 ){
									str +=
									'<div class="col-xs-4">考试形式：理论机试</div>';
								}else {
									str +=
									'<div class="col-xs-4">考试形式：操作考试</div>';
								}


								str +=
									'<div class="col-xs-4">课程：'+arr[i].coursename+'</div>'
									+'<div class="col-xs-4">老师：'+arr[i].teacher+'</div>'
									+'<div class="col-xs-4 blue right">'+_clear+'</div>'
								+'</div>'
								+'<div class="row row2">'
									+'<div class="col-xs-4">总分：'+arr[i].score+'</div>'
									+'<div class="col-xs-4">'
										+'<div class="clear" _id="'+arr[i].applystudentid+'" style="display:'+(oDate-datetotime(arr[i].endtime)<0&&arr[i].status==0?'block':'none')+';">点击进入</div>'
									+'</div>'
								+'</div>'
							+'</div>';

						$('.subscribeOuter-list').append(str);
					}
					$('.clear').click(function () {
						var oId = $(this).attr('_id');

						/*uselayer(2,'确定要取消预约吗？',function () {
							Api.applayCancel({
								json:{
									id:oId
								},
								fn:function (json) {
									console.log(json);
									uselayer(3,json.message);
									getapplaylist();
								}
							});
						})*/

						subscribeLayer('确定要取消预约吗？',function () {
							Api.R({
								url: "/learn/deletebookedlist",
								isShade: 1,
								json:{
									"1": {
										command: "learn/deletebookedlist",
										sessionid: getCookie('gy_t'),
										uid: getCookie('gy_u'),
										loginid: getCookie('gy_u'),
										applystudentid: oId
									}
								},
								fn:function (json) {
									if(json["1"].errcode != 0){
										uselayer(3,json["1"].errdesc);
										return;
									}
									uselayer(3,'预约已被取消!');
									getapplaylist();
								}
							});
						});


					});
					var allcount = json["1"]['allcount'];
					fenye(allcount,page);//生成分页
				}
			});
		};

		window.onload = function () {
			'use strict';
			common();


		};


	</script>

</html>
