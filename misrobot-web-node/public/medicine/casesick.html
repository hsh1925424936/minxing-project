<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="format-detection" content="telephone=no">
    <meta name="msapplication-tap-highlight" content="no">
    <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width">
    <script src="js/vue.js"></script>
    <script src="js/scoket.io.js"></script>
    <script src="js/jquery-1.11.3.js"></script>
    <script src="js/element.js"></script>
    <link rel="stylesheet" type="text/css" href="css/element.css">
    <link rel="stylesheet" type="text/css" href="css/reset.css">
    <link rel="stylesheet" type="text/css" href="css/casesick.css">
    <title>药学</title>
</head>
<body>
<div class="casesick">
    <div class="choice" v-if="status == 1">
        <header class="flex flex-w-center flex-h-center">
                <span>
                    模拟药房
                </span>
            <i :class="{active : showlayout}" @click="showlayout = true"></i>
            <b class="shade-all-w" v-if="showlayout" @click="showlayout = false"></b>
            <s @click="logout" v-if="showlayout">
                注销
            </s>
        </header>
        <section class="flex flex-full">
            <nav>
                <ul>
                    <li class="flex flex-h-center" v-for=" (level,index) in levellist " :class="{active : i == index }" @click="choicelevel(level.name,level.id,index)">
                        <i v-if="i !== index" class="level-icon"></i>
                        <i v-else class="level-icon-real"></i>
                        {{level.name}}
                    </li>
                </ul>
            </nav>
            <aside>
                <p>你好，{{name}}你将扮演病患角色，请选择病例脚本。</p>
                <ul class="sickinfo flex">
                    <li class="detailbox" v-for="(item , index) in detaillist" @click="choicecase(item.original,item.id,index);">
                        <div :class="{choiceitem : k == index}">
                            <p>{{item.original}}模拟病例</p>
                            <ul>
                                <li class="flex">
                                    <span>姓名：</span>
                                    <span>{{item.name}}</span>
                                </li>
                                <li class=" flex">
                                    <span>性别：</span>
                                    <span>{{item.sex | sex}}</span>
                                </li>
                                <li class="flex">
                                    <span>原病因：</span>
                                    <span>{{item.original}}</span>
                                </li>
                                <li class="flex">
                                    <span>症状：</span>
                                    <span>{{item.symptom}}</span>
                                </li>
                            </ul>
                        </div>
                    </li>
                </ul>
            </aside>
        </section>
    </div>
    <div class="grade flex"  v-if="status == 2">
        <div class="casedetail">
            <header>
                <span>模拟病例（{{detail.type | type}}）</span>
                <i class="start" @click="startexam()">开始模拟</i>
            </header>
            <section>
                <div class="headerbox">
                    <h3>基本信息</h3>
                    <div class="infomation flex flex-w-center flex-h-center">
                        <img :src="detail.head" alt="">
                        <div class="flex flex-column">
                            <span>
                                <i>姓名：{{detail.name}}</i>
                                <i class="sex" :class="{ active : detail.sex }">性别：{{detail.sex | sex}}</i>
                            </span>
                            <span>
                                <i>年龄：{{detail.age}}</i>
                                <i>备注：{{detail.remark}}</i>
                            </span>
                        </div>
                    </div>

                    <i class="icon-box" v-if="selectlist.length > 0" @click=" seletdetails = true">
                        <b>{{selectlist.length}}</b>
                    </i>
                </div>
                <div class="sectioninfo">
                    <h3>病况信息</h3>
                    <ul>
                        <li class="flex flex-column flex-w-center">
                            <i class="flex-item-start">
                                原病信息
                            </i>
                                <span>
                                    {{detail.original}}
                                </span>
                        </li>
                        <li class="flex flex-column flex-w-center">
                            <i class="flex-item-start">
                                症状
                            </i>
                                <span>
                                    &#x3000;&#x3000;{{detail.symptom}}
                                </span>
                        </li>
                        <li class="medicinelist flex flex-column flex-w-center"  v-if = 'caseType == 1 || caseType == 3'>
                            <i class="flex-item-start">
                                可推荐用药
                            </i>
                                <span>
                                    <b v-for="item in detail.drugs">
                                        {{item.name}}
                                    </b>
                                    <p v-if = 'caseType == 1'>
                                        *注：此标准用药不要告诉店员，让店员根据你的症状描述尝试推荐
                                    </p>
                                    <p v-if = 'caseType == 3'>
                                        注意：诱导用药是为了迷糊店员，你可以假装向店员购买这些药品，考察店员是否有判断重症病的能力，对于这部分患者建议他们去医院治疗，也许能及早挽救生命
                                    </p>
                                </span>
                        </li>
                        <li class="case flex flex-column flex-w-center"  v-if = 'caseType == 2'>
                            <i class="flex-item-start">
                                处方
                            </i>
                            <div>
                                <div class="flex recipebox">
                                    <img :src="detail.recipe" alt="">
                                    <s @click="boost()"></s>
                                    <span class="flex flex-column flex-h-center">
                                        <p>处方说明</p>
                                        <b>{{detail.recipenotes}}</b>
                                    </span>
                                </div>
                                <p class="senditem">
                                    <el-checkbox v-model="checked">店员已向我询要处方</el-checkbox>
                                    <i :class="{disabled : !checked}" @click="sendrecipe()">发送处方</i>
                                </p>
                            </div>
                        </li>
                        <li class="flex flex-column flex-w-center">
                            <i class="flex-item-start">
                                过往病史
                            </i>
                                <span>
                                    &#x3000;&#x3000;{{detail.history}}
                                </span>
                        </li>
                        <li class="flex flex-column flex-w-center">
                            <i class="flex-item-start">
                                口忌
                            </i>
                                <span>
                                    &#x3000;&#x3000;{{detail.avoid}}
                                </span>
                        </li>
                        <li class="flex flex-column flex-w-center">
                            <i class="flex-item-start">
                                其他注意事项
                            </i>
                                <span>
                                    &#x3000;&#x3000;{{detail.others}}
                                </span>
                        </li>
                    </ul>
                </div>
            </section>
            <i v-if="bgpic" class="shade"></i>
            <div v-if="bgpic" class="bgpicture">
                <img :src="detail.recipe" alt="">
                <s @click="closed"></s>
            </div>
            <i v-if="sendmedicine" class="shade"></i>
            <div v-if="sendmedicine" class="medicinebox flex flex-w-center flex-h-center flex-column">
                <b></b>
                <p>收到店员配送的药品篮</p>
            </div>
            <i v-if="seletdetails" class="shade"></i>
            <div v-if="seletdetails" class="medicinedetails flex flex-w-center flex-h-center flex-column">
                <i @click="seletdetails = false"></i>
                <h2>药品篮</h2>
                <div class="flex flex-h-center flex-column">
                    <p v-for = 'val in selectlist'>
                        <span>{{val.name}}</span>
                        <b>一个疗程</b>
                    </p>
                </div>
            </div>
        </div>
        <div class="score">
            <header>
                <span>给店员评分</span>
                <i class="submitexam disabled" @click="submitexam()">提&#x3000;交</i>
            </header>
            <section>
                <ul>
                    <li v-for="(item,index) in examlist.items" :key="index">
                        <h3>{{item.category}}</h3>
                        <p>{{item.order}}.{{item.content}}<span style="color: #e99400" v-if="item.required == 2">（系统自动打分）</span></p>
                        <div class="ratelist">
                            <span class="rate disable" :class="{auto : item.required == 2 }" v-for="(val,index) in item.items" @click="getscore(item.id,val,$event)"></span>
                            <template v-if="item.required == 2">
                                <span class="rate auto"></span>
                                <span class="rate auto"></span>
                                <span class="rate auto"></span>
                            </template>
                        </div>
                        <p>{{item.text}}</p>
                    </li>
                </ul>
            </section>
        </div>
    </div>
    <i class="shade-all" v-if="sucess"></i>
    <div class="succ flex flex-column flex-h-center flex-w-center" v-if="sucess">
        <i></i>
        <p>提交成功</p>
    </div>
</div>
<script>
    var  _setupWebViewJavascriptBridge = function(callback){
        if (window.WebViewJavascriptBridge) { return callback(WebViewJavascriptBridge); }
        if (window.WVJBCallbacks) { return window.WVJBCallbacks.push(callback); }
        window.WVJBCallbacks = [callback];
        var WVJBIframe = document.createElement('iframe');
        WVJBIframe.style.display = 'none';
        WVJBIframe.src = 'wvjbscheme://__BRIDGE_LOADED__';
        document.documentElement.appendChild(WVJBIframe);
        setTimeout(function() { document.documentElement.removeChild(WVJBIframe) }, 0)
    };
    var invokeNative = function(methodName, param, callback) {
        _setupWebViewJavascriptBridge(function(bridge) {
            bridge.callHandler(methodName, param, function responseCallback(responseData) {
                callback && callback(responseData);
            });
        });
    };
    window.onerror=function(a,b,c){
        alert(a+b+c)
    };
    vm = new Vue({
        el: '.casesick',
        data: {
            checked:false,
            status:1,//当前状态
            i:0,//当前选中
            k:null,//当前选中
            levellist:'',//分类
            levelid:'',//默认分类详情
            detaillist:'',//分类详情
            detail : {},
            mockid:'',//评分表id
            caseType:1,//1：非处方  2: 处方   3：重症
            examlist:[],//评分表
            resultlist:[],
            socket:{},
            name:'',//病人名字
            sessionid:'',
            loginid:'',
            evaled_id:'',//店员id
            evaled_name:'',//店员名字
            submit_id:'',//病人id
            sendmedicine:false,//推送药品
            selectlist:[],//选中的药品
            seletdetails:false,//药品详情
            sucess:false,//提交成功
            bgpic:false,//处方照片放大
            auto:'',
            showlayout:false
        },
        filters :{
            'sex':function(val){
                return val? '女性' : '男性'
            },
            'type':function(val){
                if (val && typeof val === 'string'){
                    return val.substring(0, val.length-2);
                }
            }
        },
        computed: {

        },
        mounted:function(){
            invokeNative('getClerkAndPatientInfo',{},this.getinfo);
//            this.initscoket();
//            this.queryLevel();
        },
        methods:{
//            reset:function(){
//                var json = {
//                    "1": {
//                        command: "medicine/reset"
//                    }
//                };
//                $.ajax({
//                    url: '/medicine/reset',
//                    type: 'POST',
//                    contentType: 'application/json;charset=utf-8',
//                    data: JSON.stringify(json)
//                }).done(function (data) {
//                    if(data && data.data) {
//
//                    }
//                }).fail(function () {
//                    alert('显示失败！');
//                });
//            },
            closed : function(){
                this.bgpic  = false;
                this.socket.emit('closed','');
            },
            over : function(){
                invokeNative('completionScore', function () {});
            },
            logout : function(){
                invokeNative('logOut', function () {});
            },
            getinfo:function(data){
                var self = this;
                var me = JSON.parse(data);
                self.evaled_id = me.clerkUserID;
                self.submit_id = me.patientID;
                self.name = me.patientName;
                self.evaled_name = me.clerkName;
                self.loginid = me.patientUserID;
                self.sessionid = me.patientSessionID;
                self.initscoket();
                self.queryLevel();
            },
            initscoket:function(){
                var self = this;
                this.socket = io.connect('/medicine/cabinet', {});
                this.socket.on('send',function(msg){
                    self.sendmedicine = true;
                    self.selectlist = msg;
                    if(self.caseType == 1){
                        var flag = 0;
                        for ( var i in self.detail.drugs){
                            for ( var j in self.selectlist){
                                if(self.detail.drugs[i].id == self.selectlist[j].id){
                                    $('.auto').removeClass('rate').addClass('active');
                                    self.resultlist.push({'qust_id':self.auto.id,'opts_id':self.auto.items[1].id});
                                    for ( var l in self.examlist.items){
                                        if (self.examlist.items[l].id == self.auto.id){
                                            self.examlist.items[l].text = self.auto.items[1].comment
                                        }
                                    }
                                    flag = 1;
                                }
                            }
                        }
                        if (flag == 0){
                            self.resultlist.push({'qust_id':self.auto.id,'opts_id':self.auto.items[0].id});
                            for ( var k in self.examlist.items){
                                if (self.examlist.items[k].id == self.auto.id){
                                    self.examlist.items[k].text = self.auto.items[0].comment
                                }
                            }
                        }
                    }
                    setTimeout(function(){
                        self.sendmedicine = false;
                    },2000)
                })
            },
            //获取一级分类
            queryLevel : function() {
                var _this = this;
                var _json = {
                    "1": {
                        command: "hr/querylevellist",
                        sessionid: _this.sessionid,
                        loginid: _this.loginid,
                        code: 'case'
                    }
                };
                var json = JSON.stringify(_json);
                $.ajax({
                    url: "/hr/querylevellist",
                    type: "POST",
                    data: json,
                    contentType: "application/json",
                    success: function (data) {
                        data = data["1"];
                        if (data.errcode == 0) {
                            _this.levellist=data.levellist;
                            if(_this.levellist){
                                _this.levelid=_this.levellist[0].id;
                                _this.leveldetail(_this.levelid);
                            }
                        }
                    }
                })
            },
            //获取当前分类详情
            leveldetail : function(param) {
                var _this = this;
                var _json = {
                    "1": {
                        command: "case/list",
                        sessionid: _this.sessionid,
                        loginid: _this.loginid,
                        type:param
                    }
                };
                var json = JSON.stringify(_json);
                $.ajax({
                    url: "/case/list",
                    type: "POST",
                    data: json,
                    contentType: "application/json",
                    success: function (data) {
                        data = data["1"];
                        if (data.errcode == 0) {
                            _this.detaillist=data.caselist;
                        }
                    }
                })
            },
            //选择分类
            choicelevel : function(paramtype,param,params){
                this.caseType = paramtype === '非处方药病例' ? 1 : paramtype === '处方药病例' ? 2 : paramtype === '重症病例' ? 3 : 0 ;
                this.leveldetail(param);
                this.i = params ;
            },
            //获取评分表信息
            getexaminfo:function(param){
                var _this = this;
                var _json = {
                    "1": {
                        command: 'mock/begin',
                        sessionid: _this.sessionid,
                        loginid: _this.loginid,
                        clerk:_this.evaled_id,
                        patient:_this.loginid,
                        caseid:param
                    }
                };
                var json = JSON.stringify(_json);
                $.ajax({
                    url: "/mock/begin",
                    type: "POST",
                    data: json,
                    contentType: "application/json",
                    success: function (data) {
                        data = data["1"];
                        if (data.errcode == 0) {
                            _this.mockid = data.id;
                            _this.getexam();
                        }
                    }
                });
            },
            //获取评分表
            getexam:function(){
                var _this = this;
                var bus_code = _this.caseType == 1 ? 'Nonprescription' : _this.caseType == 2 ? 'Prescription' : _this.caseType == 3 ? 'Grave' : '';
                var _json = {
                    "1": {
                        command: 'commonNaire/startActivityNaire',
                        sessionid: _this.sessionid,
                        loginid: _this.loginid,
                        bus_code: bus_code ,
                        object_id: _this.mockid
                    }
                };
                var json = JSON.stringify(_json);
                $.ajax({
                    url: "/commonNaire/startActivityNaire",
                    type: "POST",
                    data: json,
                    contentType: "application/json",
                    success: function (data) {
                        data = data["1"];
                        if (data.errcode == 0) {
                            _this.examlist = data.naire_info;
                            for(var i in _this.examlist.items){
                                _this.$set(_this.examlist.items[i],'text','评分标准~');
                            }
                            var object = {};
                            $(_this.examlist.items).each(function(i,el){
                                if(!object[el.category]){
                                    object[el.category]=true;
                                }else{
                                    _this.examlist.items[i].category = '';
                                }
                            });
                            for ( var j in _this.examlist.items){
                                if (_this.examlist.items[j].required == 2){
                                    _this.auto = _this.examlist.items[j];
                                }
                            }
                        }
                    }
                });
            },
            //选择病例
            choicecase:function(param,param2,params){
                var _this = this;
                _this.k = params;
                _this.$confirm('确定进入“'+param+'”病例吗？', '提示', {
                    confirmButtonText: '确定',
                    cancelButtonText: '取消',
                    type: 'warning'
                }).then(function(){
                    var _json = {
                        "1": {
                            command: 'case/detail',
                            sessionid: _this.sessionid,
                            loginid: _this.loginid,
                            id:param2
                        }
                    };
                    var json = JSON.stringify(_json);
                    $.ajax({
                        url: "/case/detail",
                        type: "POST",
                        data: json,
                        contentType: "application/json",
                        success: function (data) {
                            data = data["1"];
                            if (data.errcode == 0) {
                                _this.detail = data;
                                if (data.head == ''){
                                    _this.detail.head = './images/women.png'
                                }
                                _this.getexaminfo(param2);
                                _this.socket.emit('start',{});
                                _this.status = 2;
                            }
                        }
                    });
                    _this.$message({
                        type: 'success',
                        message: '你已选择'+param
                    });
                }).catch(function(){
                    _this.k = null ;
                    _this.$message({
                        type: 'info',
                        message: '已取消当前选择~'
                    });
                });
            },
            //请开始你的表演
            startexam:function(){
                $('.submitexam').removeClass('disabled');
                $('.rate').removeClass('disable');
                $('.start').addClass('disabled');
                this.socket.emit('play',this.detail);
            },
            //发送处方
            sendrecipe:function(){
                this.socket.emit('recipe',{});
            },
            //放大镜
            boost:function(){
                this.bgpic = true;
                this.socket.emit('boost',{});
            },
            //五角星打分
            getscore:function(param,params,event){
                var _this = this ;
                for ( var i in _this.examlist.items){
                    if (_this.examlist.items[i].id == param){
                        _this.examlist.items[i].text = params.comment
                    }
                }
                var target = event.target;
                if (_this.resultlist.length > 0){
                    for (var i in _this.resultlist){
                        if (_this.resultlist[i].qust_id == param){
                            _this.resultlist.splice(i,1);
                        }
                    }
                    _this.resultlist.push({'qust_id':param,'opts_id':params.id});
                } else {
                    _this.resultlist.push({'qust_id':param,'opts_id':params.id});
                }
                if ($(target).hasClass('rate')){
                    $(target).prevAll().removeClass('rate').addClass('active');
                    $(target).removeClass('rate').addClass('active');
                } else {
                    $(target).nextAll().removeClass('active').addClass('rate');
                }

            },
            //记录完成提交
            endexam:function(){
                var _this = this;
                var drug = '', _drug = [] ;
                for(var i in _this.selectlist){
                    _drug.push(_this.selectlist[i].id)
                }
                drug = _drug.join(",");
                var _json = {
                    "1": {
                        command: 'mock/end',
                        sessionid: _this.sessionid,
                        loginid: _this.loginid,
                        mockid:_this.mockid,
                        drugs:drug
                    }
                };
                var json = JSON.stringify(_json);
                $.ajax({
                    url: "/mock/end",
                    type: "POST",
                    data: json,
                    contentType: "application/json",
                    success: function (data) {
                        data = data["1"];
                        if (data.errcode == 0) {

                        }
                    }
                });
            },
            //提交成绩
            submitexam:function(){
                var _this = this;
                if (_this.resultlist.length !== _this.examlist.items.length){
                    _this.$notify({
                        title: '注意',
                        message: '请给所有评分项打分~',
                        type: 'warning'
                    });
                }else {
                    var _json = {
                        "1": {
                            command: 'commonNaire/submitNaireResult',
                            sessionid: _this.sessionid,
                            loginid: _this.loginid,
                            naire_id:_this.examlist.id,
                            type:1,
                            evaled_id:_this.evaled_id,
                            submit_id:_this.submit_id,
                            activity_id:_this.mockid,
                            source:0,
                            result_list:_this.resultlist
                        }
                    };
                    var json = JSON.stringify(_json);
                    $.ajax({
                        url: "/commonNaire/submitNaireResult",
                        type: "POST",
                        data: json,
                        contentType: "application/json",
                        success: function (data) {
                            data = data["1"];
                            if (data.errcode == 0) {
                                _this.socket.emit('end',{'id':data.submit_id,'name':_this.evaled_name});
                                _this.sucess = true;
                                _this.endexam();
                                setTimeout(function(){
                                    _this.over();
                                },2000)
                            }
                        }
                    });
                }
            }
        }
    })
</script>
</body>
</html>
